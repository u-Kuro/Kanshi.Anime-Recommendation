<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanshi. - Anime Recommendation</title>
    <link rel="shortcut icon" type="image/x-icon" href="./public/logo.png" />
    <!-- Jquery -->
    <script src="./js-css/jquery-1.8.3.min.js"></script>
    <!-- Swal 2 -->
    <script src="./js-css/swal2/sweetalert2.all.js"></script>
    <script src="./js-css/swal2/sweetalert2.css"></script>
    <link rel="stylesheet" href="./js-css/swal2/sweetalert2.css">
    <!-- Table Sort -->
    <link rel="stylesheet" href="./js-css/jquery tablesorter/theme.default.min.css">
    <script type="text/javascript" src="./js-css/jquery tablesorter/jquery.tablesorter.js"></script>
    <script type="text/javascript" src="./js-css/jquery tablesorter/jquery.metadata.min.js"></script>
    <script type="text/javascript" src="./js-css/jquery tablesorter/jquery.tablesorter.pager.min.js"></script>
    <!-- Datalist Search Code -->
    <link rel="stylesheet" href="./js-css/flexdatalist/jquery.flexdatalist.css">
    <script src="./js-css/flexdatalist/jquery.flexdatalist.js"></script>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="./js-css/bootstrap-3.3.6.min.css"/>
    <!-- Fontawesome -->
    <link rel="stylesheet" href="./js-css/font-awesome.min.css">
    <script src="./js-css/fontawesome-5.0.js" crossorigin="anonymous"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PPMY92TJCE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-PPMY92TJCE');
    </script>
    <style>
            /* Change For Text Size */
            :root{
                font-size: 0.9rem !important;
            }
            /* Change/Add to Class/Tag of desired division for Padding */
            .Home,
            .overlay{
                padding-inline: clamp(0px, 5vw, 75px) !important;
            }
            /* Default */
            html,
            body {
                height: 100%;
                width: 100%;
                overflow: auto;
            }
            :root{
                font-size: 0.9rem;
                background-color: #fff;
                font-family: sans-serif;
                z-index: 0;
                min-width: 100%;
                min-height: 100%;
                overflow:auto;
            }
            :root>*{
                background-color: #fff;
                min-width: inherit;
                min-height: inherit;
            }
            *,
            ::after,
            ::before{
                margin: 0;
                padding: 0;
                text-indent: 0;
                box-sizing: border-box;
            }
            /* Text */
            .textLogo{
                font-size: clamp(1.6rem, 2vw,1.6rem) !important;
            }
            h1{
                font-size: clamp(1.3rem, 2vw,1.3rem);
            }
            h2{
                font-size: clamp(1.05rem, 2vw,1.05rem);
            }
            h3{
                font-size: clamp(1.05rem, 2vw,1.05rem);
            }
            p,
            label,
            input[type="text"]{
                font-size: clamp(0.95rem, 2vw,0.95rem);
            }
            h4{
                font-size: clamp(1rem, 2vw,1rem);
            }
            h5{
                font-size: clamp(0.9rem, 2vw,0.9rem);
            }
            h6{
                font-size: clamp(0.8rem, 2vw,0.8rem);
            }
            h1,
            h2,
            h3,
            h4,
            h5,
            h6,
            p,
            input,
            textarea,
            .textLogo{
                cursor:default;
                hyphens:manual;
                white-space:pre-wrap;
                word-break:break-word;
                overflow-wrap:break-word;
                transform-origin: left;
            }
            h1,
            h2,
            h3,
            h4,
            h5,
            h6,
            p,
            .textLogo{
                max-width: fit-content;
                min-width: fit-content;
            }
            /* Forms */
            input,
            textarea{
                outline: 0;
            }
            input[type=text]{
                user-select: text;
            }
            button,
            button>*{
                cursor: pointer;
            }
            dialog{
                border: 0;
            }
            img{
                max-width: 100%;
            }
            /* Additional */
            body{
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            ::-webkit-scrollbar {
                display: none;
            }
            .example {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            button {
                background-color: black;
                color: white;
            }
            input {
                padding: 0.5em;
            }
            .userInput {
                width: min-content;
                border-color: rgb(118, 118, 118);
                border-width: 2px;
                border-style: inset;
                border-radius: 0px;
                background-color: rgb(255, 255, 255);
            }
            .loader {
                position: fixed;
                left: 0px;
                top: 0px;
                width: 100%;
                height: 100%;
                z-index: 9999;
                background: url('./public/loading.gif')
                    50% 50% no-repeat
                    rgb(0, 0, 0)
            }
            .loader > * {
                justify-content: center;
                min-height: 100%;
                align-items: center;
                display: flex;
                margin-top: 150px;
                color: wheat;
                text-align: center;
            }
            html,body,.home{
                width: 100%;
                min-height: 100%;
                height: 100%;
            }
            label{margin: 0}
            .searchData,.table-responsive{
                margin-block: 15px;
            }
            .flexdatalist-multiple > .value {
                max-width: fit-content;
                cursor: pointer;
            }
            .userInputContainer,.filter-container,.btn-container{
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                margin-block: 15px;
                gap: 0.5em;
            }
            .userInputContainer>:not(label),.filter-container>:not(label),.btn-container>:not(label){
                flex-grow: 1;
            }
            .flexdatalist-multiple{
                display: flex;
                flex-wrap: wrap-reverse;
                max-height: 120px;
                overflow-y: scroll;
            }
            .flexdatalist-multiple>.flexdatalist-multiple-value{
                flex-grow: 1;
                display: flex !important;
            }
            .flexdatalist-multiple>.flexdatalist-multiple-value>.flexdatalist-alias{
                outline: none;
                flex-grow: 1;
            }
            .tableLoadingContainer{
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .show-hidden-anime-btn{
                text-align: center !important;
                min-width: 85px !important;
            }
            header {
                background: url('./public/header.png');
                text-align: left;
                width: 100%;
                height: 165px;
                background-size: contain;
                position: relative;
                overflow: hidden;
                border-radius: 0 0 50% 50% / 5%;
            }
            header .overlay{
                width: 100%;
                height: 100%;
                padding: 1.75em;
                color: #FFF;
                background-image: linear-gradient( 135deg, #39343c69 10%, #6d00006b 100%);
            }
            header .overlay>*{
                padding-right: 50%;
            }
            button {
                border: none;
                outline: none;
                padding: 10px 20px;
                border-radius: 50px;
                box-shadow: 0 3px 20px 0 #0000003b;
            }
            button:hover{
                cursor: pointer;
            }
            a {
                color: #B06D70;
            }
            #anime-table{
                border: 1px solid #ddd !important;
            }
            #animeRecommendationList{
                content-visibility: auto;
            }
            #animeRecommendationList > tr > *{
                white-space: nowrap;
            }
            #updateIntervalBtn,
            #updateBtn,
            #showAllAnime{
                display: none;
            }
            #hiddenUnhiddenBtn{
                background: black !important;
                color: white !important;
                max-width: fit-content !important;
                cursor: pointer;
            }
            #searchBtn:hover,
            #searchBtn:focus{
                color: white;
            }
            .anime-table-headers > th{
                vertical-align: middle !important;
                padding: 1em !important;
            }
            .tablesorter-header-inner{
                margin-right: 0.5em !important;
                min-width: max-content !important;
            }
            .show-all-anime{
                background: black !important;
                color: white !important;
                border-radius: 5%;
                max-width: fit-content !important;
            }
            .tablesorter-default{
                margin: 0 !important;
            }
            .hide-anime-column{
                padding-block: 1.5em !important;
                vertical-align: middle !important;
                text-align: center !important;
                user-select: none !important;
            }
            .item > td {
                vertical-align: middle !important;
            }
            .anime-score{
                text-align: center !important;
                max-width: 50px !important;
                text-overflow: ellipsis !important;
                overflow: hidden !important;
                cursor: pointer;
                user-select: none !important;
            }
            .anime-score > div {
                display: flex;
                gap: 0.5ch;
                max-width: 50px !important;
                text-overflow: ellipsis !important;
                overflow: hidden !important;
            }
            .overlay,
            .searchData,
            .flexdatalist-results{
                user-select: none;
            }
            .spinner {
                border: 2px solid #f3f3f3;
                border-top: 2px solid #B06D70;
                border-radius: 50%;
                width: 13px;
                min-width: 13px;
                height: 13px;
                min-height: 13px;
                animation: spin 2s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .data-status-container{
                display: none;
                align-items: center;
                justify-content: center;
            }
            .table-responsive{
                border: 1px solid #dddddd !important;
                min-height: 556px !important;
                margin-bottom: 100px !important;
            }
            .pager{
                position: fixed;
                bottom: 0;
                width: 100%;
                border-radius: 50% 50% 0 0 / 5%;
                background: rgb(0,0,0,0.925);
                color: white;
                margin: 0;
                z-index: 100;
            }
            .pager-form{
                display: flex;
                justify-content: center;
                align-items: center;
                user-select: none;
            }
            .pager-form>*{
                flex: 1;
                min-width: fit-content;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            }
            .pager-form>*>*{
                flex: 1;
                min-width: fit-content;
                cursor: pointer;
            }
            .tablesorter-pager {
                padding: 1em;
            }
            td.tablesorter-pager {
                background-color: #e6eeee;
                margin: 0;
            }
            .tablesorter-pager img {
                vertical-align: middle;
                margin-right: 2px;
                cursor: pointer;
            }
            .tablesorter-pager .pagedisplay {
                margin-block: auto;
                text-align: left;
            }
            .tablesorter-pager select {
                margin: 0;
                padding: 0;
            }
            .tablesorter-pager.disabled {
                display: none;
            }
            .tablesorter-pager .disabled {
                opacity: 0.5;
                filter: alpha(opacity=50);
                cursor: default;
            }
            .pagedisplay{
                max-width: fit-content;
            }
            .pagenum{
                background-color: transparent;
                height: fit-content;
                border: transparent;
                text-align: center;
                outline: none;
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
            }
            .pagenum>*{
                background-color: black;
                color: white;
            }
            .endPage{
                text-align: left;
            }
            .nav{
                z-index: 100;
                position: fixed;
                width: 100%;
                height: 50px;
                display: flex;
                color: white;
                justify-content: space-between;
                background-color: rgb(0,0,0,0.925);
                padding: 1em;
                align-items: center;
                user-select: none;
            }
            .nav > div{
                flex: 1;
                display: flex;
            }
            .nav img{
                margin-left: auto;
                max-height: 40px;
                cursor: pointer;
            }
            .nav h1{
                cursor: pointer;
            }
            header{
                margin-top: 50px;
            }
            .menu-container {
                overflow: auto;
                top: 0px;
                right: 0;
                position: fixed;
                z-index: 99;
                height: 100%;
                width: 100%;
                background-color: rgb(0, 0, 0, 0.925);
                color: white;
                display: none;
                user-select: none;
            }
            .menu-container>div{
                margin-bottom: 63px;
                padding: 1em;
                margin-top: 50px;
                display: flex;
                flex-wrap: wrap;
                gap: 1.5em;
                height: min-content;
            }
            .menu-container>div>button{
                -moz-box-shadow: 0 3px 20px 0 #af6e7138 !important;
                -webkit-box-shadow: 0 3px 20px 0 #af6e7138 !important;
                box-shadow: 0 3px 20px 0 #af6e7138 !important;
            }
            .no-before::before{
                content: none;
            }
            .whitespace-pre-wrap{
                white-space: pre-wrap !important;
            }
            .swal2-container{
                user-select: none;
            }
            .swal2-validation-message-custom-success::before {
                content: "✓";
                display: inline-block;
                width: 1.5em;
                min-width: 1.5em;
                height: 1.5em;
                margin: 0 0.625em;
                border-radius: 50%;
                background-color: #78f274;
                color: #fff;
                font-weight: 600;
                line-height: 1.5em;
                text-align: center;
            }
            .swal2-actions{
                justify-content: space-evenly !important;
                width: 100% !important;
                gap: 1em !important;
                padding-inline: 1em !important;
            }
            .swal2-actions button{
                min-width: fit-content !important;
                flex:1 !important;
            }
            .swal2-footer{
                justify-content: space-evenly !important;
                width: 100% !important;
                flex-wrap: wrap;
                gap: 1.5ch;
            }
            .no-border{
                border: none;
            }
            .swal2-footer > *{
                flex: 1 !important;
                min-width: 100% !important;
                text-align: center !important;
            }
            .swal-overlay-custom{
                display: none;
                position: fixed;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 0;
                overflow-y: auto;
                background-color: rgba(0,0,0,.4);
                z-index: 10000;
                pointer-events: none;
                opacity: 0;
                transition: opacity .3s;
            }
            .swal-overlay--show-modal-custom{
                opacity: 1;
                pointer-events: auto;
            }
            .swal-overlay--show-modal-custom .swal-modal-custom{
                opacity: 1;
                pointer-events: auto;
                box-sizing: border-box;
                -webkit-animation: showSweetAlert .3s;
                animation: showSweetAlert .3s;
                will-change: transform;
            }
            @keyframes swal2-show {
                0% {
                    transform: scale(0.7);
                }
                45% {
                    transform: scale(1.05);
                }
                80% {
                    transform: scale(0.95);
                }
                100% {
                    transform: scale(1);
                }
            }
            @keyframes swal2-hide {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }
                100% {
                    transform: scale(0.5);
                    opacity: 0;
                }
            }
            .swal2-show{
                animation-duration: 0.3s;
                animation-timing-function: ease;
                animation-delay: 0s;
                animation-iteration-count: 1;
                animation-direction: normal;
                animation-fill-mode: none;
                animation-play-state: running;
                animation-name: swal2-show;
            }
            .swal2-hide{
                animation-duration: 0.3s;
                animation-timing-function: ease;
                animation-delay: 0s;
                animation-iteration-count: 1;
                animation-direction: normal;
                animation-fill-mode: none;
                animation-play-state: running;
                animation-name: swal2-hide;
            }
            .swal-modal-custom{
                overflow: auto;
                font-family: "Helvetica Neue",Helvetica,Arial,sans-serif !important;
                padding-top: 36px;
                padding-bottom: 2px;
                position: fixed;
                top: 50%;
                right: 50%;
                transform: scale(1) translate(50%,-50%) !important;
                width: 512px;
                max-width: 95%;
                max-height: 100%;
                opacity: 0;
                pointer-events: none;
                background-color: #fff;
                color: #545454;
                text-align: center;
                border-radius: 5px;
                display: inline-block;
                vertical-align: middle;
                z-index: 10001;
                transition: opacity .2s,-webkit-transform .3s;
                transition: transform .3s,opacity .2s;
                transition: transform .3s,opacity .2s,-webkit-transform .3s;
            }
            .swal-text-custom:first-child{
                display: block !important;
                margin: auto;
            }
            .swal-text-custom{
                font-family: "Helvetica Neue",Helvetica,Arial,sans-serif !important;
                font-weight: 400 !important;
                font-size: 16px !important;
                text-align: center;
                position: relative;
                float: none;
                line-height: normal;
                vertical-align: top;
                text-align: left;
                display: inline-block;
                margin-inline: 16px !important;
                color: #333;
                overflow-wrap: break-word;
                box-sizing: border-box;
                -webkit-tap-highlight-color: rgb(0,0,0,0);
            }
            .swal-text-custom * {
                font-family: "Helvetica Neue",Helvetica,Arial,sans-serif !important;
                font-weight: 400 !important;
                font-size: 16px !important;
                color: #333 !important;
            }
            .swal-footer-custom {
                display: flex;
                justify-content: space-evenly;
                gap: 16px !important;
                align-items: center;
                text-align: center;
                padding: 15px !important;
                border-radius: inherit;
                border-top-left-radius: 0;
                border-top-right-radius: 0;
            }
            .swal-button-container-custom {
                display: flex !important;
                flex: 1 !important;
                min-width: fit-content !important;
            }
            .swal-button--confirm-custom{
                background-color: black !important;
                color: white !important;
            }
            .swal-button--cancel-custom {
                background-color: #e27d81 !important;
                color: white !important;
            }
            .swal-button-custom {
                flex: 1 !important;
                font-size: 14px !important;
                font-weight: 500 !important;
                padding: 9px 16px !important;
                margin: 5px !important;
                color: #fff;
                border: none;
                box-shadow: none;
                border-radius: 4px;
                margin: 0;
                cursor: pointer;
            }
            .swal-button__loader-custom{
                position: absolute;
                height: auto;
                width: 43px;
                z-index: 2;
                left: 50%;
                top: 50%;
                -webkit-transform: translateX(-50%) translateY(-50%);
                transform: translateX(-50%) translateY(-50%);
                text-align: center;
                pointer-events: none;
                opacity: 0;
            }
            .orange{
                color: orange;
            }
            .red{
                color: red;
            }
            td#animeTitle>i{
                padding: 0.5ch;
            }
            #warnAnimeContainer{
                user-select: none;
            }
        </style>
</head>
<body>
<nav class="nav">
    <div><h1 id="menuTitle" class="textLogo">Kanshi.</h1></div>
    <div><img id="menuIcon" src="./public/logo.png" alt="menubar"></div>
</nav>
<div class="menu-container">
    <div>
        <button id="updateBtn">Update</button>
        <button id="showAllAnime">Show All</button>
        <input type="file" id="importFile" style="display: none;" accept=".json"/>
        <button id="deepUpdateBtn">Deep Update</button>
        <button id="importBtn">Import</button>
        <button id="exportBtn">Export</button>
        <button id="warnAnimeBtn">Choose Content to Warn</button>
        <button id="hideKidsAnimeBtn">Hide Kids Anime</button>
        <button id="updateIntervalBtn">Update Every 1 hour</button>
        <button id="exportIntervalBtn">Export Every 1 hour</button>
        <button id="sign-up">Create Another Account</button>
    </div>
</div>
<header>
    <div class="overlay">
        <h1 class="textLogo">Kanshi.</h1>
        <h3>Anime - Anilist</h3>
        <h3>Recommendations</h3>
    </div>
</header>
<div class="Home">
    <div class="searchData">
        <div class="userInputContainer">
            <input class="userInput" placeholder="Anilist Username" name="username" id="username" type="text">
        </div>
        <div id="filters" class="filter-container">
            <input type="text"
                placeholder="Filter Word/Number (!Exclude/Score>N/etc.)"
                class="flexdatalist"
                data-search-in="info"
                multiple="multiple"
                data-min-length="1"
                name="filter">
        </div>
        <div class="btn-container">
            <button id="searchBtn" class="btn" type="submit">Search</button>
        </div>
        <div id="dataStatusContainer" class="data-status-container">
            <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
            <h6 id="dataStatus"></h6>
        </div>
    </div>
    <div class="table-responsive">
        <table id="anime-table" class="tablesorter table table-bordered table-striped">
            <thead>
            <tr class="anime-table-headers">
                <th id="hiddenUnhiddenBtn" class="trigger-btn sorter-false show-hidden-anime-btn">Unhidden</th>
                <th>WScore</th>
                <th>Title</th>
                <th>Top Similarities</th>
                <th>Score</th>
                <th>User Status</th>
                <th>Status</th>
                <th>Genres</th>
                <th>Tags</th>
                <th>Format</th>
                <th>Year</th>
                <th>Season</th>
                <th>Studios</th>
                <th>Staff</th>
            </tr>
            </thead>
            <tbody id="animeRecommendationList">
            <tr class="item" role="row">
                <td style="padding: 1.5em !important;" colspan="14">
                    <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                    No Data
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- pager -->
<div id="pager" class="pager">
    <form class="pager-form">
        <span id="first" class="first"><h5>First</h5></span>
        <span id="prev" class="prev"><h5>Prev</h5></span>
        <span id="selectPageNumber">
            <select id="pageNumberOptions" class="custom-select pagenum" title="Select page number"></select>
        </span>
        <span id="next" class="next"><h5>Next</h5></span>
        <span id="last" class="last"><h5>Last</h5></span>
    </form>
</div>

<!-- Modal -->
<div id="myModal" class="modal fade">
    <div class="modal-dialog modal-confirm">
        <div class="modal-content">
            <div class="modal-header flex-column">
                <h4 class="modal-title w-100">Are you sure?</h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            </div>
            <div class="modal-body">
                <p>Do you really want to delete these records? This process cannot be undone.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>
<!-- confirmation modal-->
<div id="confirm-modal" class="modal fade" >
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Modal title</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete?&hellip;</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>
</div>
<div class="loader">
    <span><h1 id="loaderText">Loading...</h1></span>
</div>

<div id="warnAnimeContainer" class="swal-overlay-custom swal-overlay--show-modal-custom" tabindex="-1">
    <div id="warnAnimeModal" class="swal-modal-custom" role="dialog" aria-modal="true">
        <div class="swal-text-custom">
            <div style="margin:0 !important;padding:0;">Select an Anime Information to be Warned</div>
            <div class="filter-container">
                <input type="text"
                    placeholder="Normal word for Semi-Warning or !Red-Warning"
                    class="flexdatalistWarnAnime"
                    data-search-in="info"
                    multiple="multiple"
                    data-min-length="1"
                    name="filter">
            </div>
        </div>
        <div class="swal-footer-custom">
            <div class="swal-button-container-custom">
                <button id="cancelWarnAnime" class="swal-button-custom swal-button--cancel-custom">Cancel</button>
                <div class="swal-button__loader-custom">
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>
            <div class="swal-button-container-custom">
                <button id="submitWarnAnime" class="swal-button-custom swal-button--confirm-custom">Submit</button>
                <div class="swal-button__loader-custom">
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script defer>
    // Initialize Global Variables
        // IndexDB
    var request, db,
        // Saved Data
    savedUsername, savedRecScheme, savedFilters, savedUserList, savedAnimeEntries, savedHiddenAnimeTitles, savedWarnAnime,
    savedYscroll, savedHiddenTablePage, savedUnhiddenTablePage, savedTableStatus, savedSort,
    savedFilterOptionsJson, allFilterInfo,
    exportIntervalIsActive, updateIntervalIsActive, exportIntervalStartDate, updateIntervalStartDate,
    exportIntervalTimeout = [], updateIntervalTimeout = [],
    kidsAnimeIsHidden,
    // Browser
    notificationGranted = false,
    // Broweser
        // Load Saved API Request State
    savedAnalyzeVariableTime, savedUpdateAnalyzeAnimeTime, savedDeepUpdateTime,
    deepUpdateStartTime, isDeepUpdate, requestIntervalSeconds, savedLastRequestDate, requestPause,
    updateStartTime, isRunning = false, requestIsRunning = false, isLoading = false, temp = []
    // Create IndexDB
    $(window).load(async function() {
        await new Promise((resolve)=>{
            setTimeout(()=>{
                resolve()
            },1000)
            request = window.indexedDB.open("MyIndexDB", 1)
            request.onerror = (event) => {
                console.error("MyIndexDB is Not Allowed! Using Locale Storage Instead")
            }
            request.onsuccess = (event) => {
                db = event.target.result
                resolve()
            }
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                db.createObjectStore("MyObjectStore")
            }
        }).then(async()=>{
            setTimeout(()=>{
                return
            },1000)
            await new Promise(async(resolve)=>{
                savedUnhiddenTablePage = await retrieveJSON("savedUnhiddenTablePage") || 0
                savedHiddenTablePage = await retrieveJSON("savedHiddenTablePage") || 0
                savedTableStatus = await retrieveJSON("savedTableStatus") || "Unhidden"
                resolve()
            })
            return
        }).then(async()=>{
            setTimeout(()=>{
                return
            },1000)
            await new Promise(async(resolve)=>{// Load Functions
                // Browser (Mobile)
                $(window).on("orientationchange", function(event) {
                    $('body').animate({scrollTop: 0},1)
                })
                // Browser (Mobile)
                await $("#anime-table")
                    .tablesorter({
                        sortInitialOrder: "asc",
                        headers: {
                            1:{sortInitialOrder: "desc"},
                            4:{sortInitialOrder: "desc"},
                            9:{sortInitialOrder: "desc"},
                        },
                        widgets: ["saveSort"],
                        widgetOptions : {
                            saveSort : true
                        }
                    })
                    .tablesorterPager({
                        container: $(".pager"),
                        updateArrows: true,
                        page: (savedTableStatus==="Unhidden"? savedUnhiddenTablePage:savedHiddenTablePage),
                        savePages: true,
                        size: 8,
                        pageReset: false,
                        removeRows: true,
                        cssNext: '.next',
                        cssPrev: '.prev',
                        cssFirst: '.first',
                        cssLast: '.last',
                        cssGoto: '.pagenum',
                        cssPageDisplay: '.pagedisplay'
                    })
                    .delegate('button.hide-anime', 'click' , async function() {
                        var hiddenRow =  await $(this).closest('tr')
                        var hiddenAnimeTitle = await hiddenRow.children("td#animeTitle").children("a").attr("data-value")
                        savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles") || []
                        await savedHiddenAnimeTitles.push(hiddenAnimeTitle)
                        await saveJSON(savedHiddenAnimeTitles,"savedHiddenAnimeTitles")
                        hiddenRow.addClass("remove-me")
                        $("#anime-table").trigger("pagerUpdate")
                        if($("#anime-table")[0].config.rowsCopy.length===0){
                            await $("#animeRecommendationList").empty()
                            await $("#animeRecommendationList").append(`
                                <tr class="item" role="row">
                                    <td style="padding: 1.5em !important;" colspan="14">
                                        <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                        No Data
                                    </td>
                                </tr>
                            `)
                        }
                        // Have a Hidden Anime
                        if(await savedHiddenAnimeTitles.length>0){
                            await $("#showAllAnime").show()
                        }
                        await setTimeout(async()=>{
                            let setPageInfo = await setInterval(async()=>{
                                if(typeof $('#anime-table')[0].config!=="undefined"){
                                    await clearInterval(setPageInfo)
                                    await $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                }
                            },1)
                        },0)
                        return false
                    })
                    .delegate('button.show-anime', 'click' , async function() {
                        var hiddenRow = await $(this).closest('tr')
                        var hiddenAnimeTitle = await hiddenRow.children("td#animeTitle").children("a").attr("data-value")
                        savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles") || []
                        savedHiddenAnimeTitles = await savedHiddenAnimeTitles.filter((v)=>v!==hiddenAnimeTitle)
                        await saveJSON(savedHiddenAnimeTitles,"savedHiddenAnimeTitles")
                        // No Hidden Anime
                        await hiddenRow.addClass("remove-me")
                        await $("#anime-table").trigger("pagerUpdate")
                        if(await savedHiddenAnimeTitles.length===0||$("#anime-table")[0].config.rowsCopy.length===0){
                            await $("#animeRecommendationList").empty()
                            await $("#animeRecommendationList").append(`
                                <tr class="item" role="row">
                                    <td style="padding: 1.5em !important;" colspan="14">
                                        <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                        No Data
                                    </td>
                                </tr>
                            `)
                            await $("#showAllAnime").hide()
                        }
                        await setTimeout(async()=>{
                            let setPageInfo = await setInterval(async()=>{
                                if(await (typeof $('#anime-table')[0].config!=="undefined")){
                                    await clearInterval(setPageInfo)
                                    await $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                }
                            },1)
                        },0)
                        return false
                    })
                await $('.flexdatalistWarnAnime').flexdatalist({
                    minLength: 1,
                    searchIn: 'info',
                    data: savedFilterOptionsJson
                })
                resolve()
            })
            return
        }).then(async()=>{
            setTimeout(()=>{
                return
            },1000)

            await new Promise(async(resolve) => {
                // Reload Name
                savedUsername = await retrieveJSON("savedUsername") || ""
                if(await savedUsername.length>0){
                    await $("#username").val(savedUsername)
                    await $("#updateIntervalBtn").show()
                }
                // Reload FilterOptions
                savedFilterOptionsJson = await retrieveJSON("savedFilterOptionsJson") || []
                allFilterInfo = await retrieveJSON("allFilterInfo") || {}
                if(await savedFilterOptionsJson.length===0){
                    var worker = await new Worker("./js-css/worker/getOptions.js")
                    await worker.postMessage("")
                    worker.onmessage = async (message) => {
                        const data = await message.data
                        savedFilterOptionsJson = await data.savedFilterOptionsJson
                        await saveJSON(savedFilterOptionsJson,"savedFilterOptionsJson")
                        allFilterInfo = await data.allFilterInfo
                        await saveJSON(allFilterInfo,"allFilterInfo")
                        await $('.flexdatalist').flexdatalist({
                            minLength: 1,
                            searchIn: 'info',
                            data: savedFilterOptionsJson
                        })
                        await worker.terminate()
                    }
                } else {
                    await $('.flexdatalist').flexdatalist({
                        minLength: 1,
                        searchIn: 'info',
                        data: savedFilterOptionsJson
                    })
                }

                // Reload Saved Sort
                let setSavedSort = await setInterval(async()=>{
                    if(typeof $('#anime-table')[0].config!=="undefined"){
                        await clearInterval(setSavedSort)
                        savedSort = await retrieveJSON("savedSort") || [1,1]
                        await $.tablesorter.sortOn($('#anime-table')[0].config, [savedSort])
                        await $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                    }
                },1)

                // Return Page CSS
                await setTimeout(async()=>{
                    let setPageInfo = await setInterval(async()=>{
                        if(typeof $('#anime-table')[0].config!=="undefined"){
                            await clearInterval(setPageInfo)
                            await $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                        }
                    },1)
                },0)
                resolve()
            })
            return
        }).then(async()=>{
            setTimeout(()=>{
                return
            },2000)
            await new Promise(async(resolve)=>{
                await $("#warnAnimeContainer").show().css({visibility:"hidden"})
                let reloadSavedData = await setInterval(async () => {
                    if(await $("#warnAnimeContainer .flexdatalist-multiple-value > .flexdatalist-alias").length){
                        await clearInterval(reloadSavedData)
                        // Reload Filters
                        var warnAnimeInput
                        savedWarnAnime = await retrieveJSON("savedWarnAnime") || [ "ecchi","mahou shoujo","!boys' love","cgi","!ero guro","!female harem",
                                                                                   "full cgi","kids","love triangle","!male harem","!mixed gender harem",
                                                                                   "!nudity","!slavery","!suicide","tokusatsu","!yuri","wuxia","!netorare",
                                                                                   "!rape"
                                                                                 ]
                        for(let i=0; i<savedWarnAnime.length; i++) {
                            warnAnimeInput = await $("#warnAnimeModal .flexdatalist-multiple-value > .flexdatalist-alias")
                            await warnAnimeInput.val(savedWarnAnime[i])
                            var e = await $.Event("keyup",{keyCode:13})
                            await warnAnimeInput.trigger(e)
                            await warnAnimeInput.val("")
                        }
                        await $("#warnAnimeContainer").css({visibility:"visible"}).hide()
                        resolve()
                    }
                },1)
            })
            return
        }).then(async()=>{
            setTimeout(()=>{
                return
            },3000)
            await new Promise(async(resolve) => {
                // Reload Filters -> Data
                    // Check for FlexDatalist Availability
                let reloadSavedData = await setInterval(async () => {
                    if(await $("#filters .flexdatalist-multiple-value > .flexdatalist-alias").length){
                        await clearInterval(reloadSavedData)
                        // Reload Filters
                        var filterInput
                        savedFilters = await retrieveJSON("savedFilters") || []
                        for(let i=0; i<savedFilters.length; i++) {
                            filterInput = await $("#filters .flexdatalist-multiple-value > .flexdatalist-alias")
                            await filterInput.val(savedFilters[i])
                            var e = await $.Event("keyup",{keyCode:13})
                            await filterInput.trigger(e)
                            await filterInput.val("")
                        }
                        // Check if the List shown is Hidden List or Unhidden List -> Rename th button
                        var filters = await $("#filters .flexdatalist-multiple").children("li.value")
                        for(let i=0; i<filters.length; i++) {
                            var filterName = await filters.eq(i).children(".text")[0].innerText
                            if(await filterName.toLowerCase()==="hidden"){
                                await $("#hiddenUnhiddenBtn").text("Hidden")
                            }
                        }
                        // Reload Data Table
                        await $("#animeRecommendationList").empty()
                        await $("#animeRecommendationList").append(`
                            <tr class="item" role="row">
                                <td style="padding: 1.5em !important;" colspan="14">
                                    <div style="display:flex; align-items:center;">
                                        <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                        <div>Loading...</div>
                                    </div>
                                </td>
                            </tr>
                        `)
                        kidsAnimeIsHidden = await retrieveJSON("kidsAnimeIsHidden")
                        if(await kidsAnimeIsHidden===undefined) {
                            kidsAnimeIsHidden = await true
                            await saveJSON(kidsAnimeIsHidden,"kidsAnimeIsHidden")
                        }
                        if(await kidsAnimeIsHidden){
                            await $("#hideKidsAnimeBtn").css({background: "white",color:"black"})
                        }
                        savedRecScheme = await retrieveJSON("savedRecScheme") || {}
                        if(await Object.keys(savedRecScheme).length>0){
                            await $("#updateBtn").show()
                            await LoadData(savedRecScheme)
                            $(".loader").fadeOut("slow")
                            savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles") || []
                            if(await savedHiddenAnimeTitles.length>0){
                                await $("#showAllAnime").show()
                            }
                            resolve()
                        } else {
                            animeData = `
                                <tr class="item" role="row">
                                    <td style="padding: 1.5em !important;" colspan="14">
                                        <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                        No Data
                                    </td>
                                </tr>
                            `
                            await $("#animeRecommendationList").empty()
                            await $("#animeRecommendationList").append(animeData)
                            await $("#anime-table").trigger("update")
                            setTimeout(async()=>{
                                let setPageInfo = await setInterval(async()=>{
                                    if(await typeof $('#anime-table')[0].config!=="undefined"){
                                        await clearInterval(setPageInfo)
                                        await $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                    }
                                },1)
                            },0)
                            resolve()
                        }
                    }
                },1)
            })
            return
        }).then(async()=>{
            await new Promise(async(resolve) => {
                await $("#anime-table")
                    .bind('pageMoved', async function(){
                        await setTimeout(async()=>{
                            let setPageInfo = await setInterval(async()=>{
                                if(typeof $('#anime-table')[0].config!=="undefined"){
                                    await clearInterval(setPageInfo)
                                    await $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                    var page = await $('#anime-table')[0].config.pager.page
                                    ++page
                                    savedTableStatus = await retrieveJSON("savedTableStatus") || "Unhidden"
                                    if(savedTableStatus==="Unhidden"){
                                        saveJSON(page,"savedUnhiddenTablePage")
                                    } else {
                                        saveJSON(page,"savedHiddenTablePage")
                                    }
                                }
                            },1)
                        },0)
                    })
                resolve()
            })
            return
        }).then(async()=>{
            setTimeout(()=>{
                return
            },2000)
            // Reload saved Website Y-Position
            await new Promise(async(resolve)=>{
                savedYscroll = await retrieveJSON("savedYscroll") || 0.0
                var reloadSavedYScrollStartDate = await new Date()
                let reloadSavedYScroll = await setInterval(async()=>{
                    await $('body').animate({scrollTop: savedYscroll},1)
                    if(await ($("body").scrollTop()===savedYscroll||
                    (((new Date()).getTime())-reloadSavedYScrollStartDate.getTime())>1000)){
                        await clearInterval(reloadSavedYScroll)
                        resolve()
                    }
                },1)
            })
            return
        }).then(async()=>{
            setTimeout(()=>{
                return
            },1000)
            // Auto Interval
            await new Promise(async(resolve) => {
                // Update
                updateIntervalIsActive = await retrieveJSON("updateIntervalIsActive") || false
                if(await updateIntervalIsActive){
                    await $("#updateIntervalBtn").css({background: "white",color:"black"})
                    updateIntervalStartDate = await retrieveJSON("updateIntervalStartDate") || new Date()
                    await saveJSON(updateIntervalStartDate,"updateIntervalStartDate")
                    if(await (new Date).getTime()-(updateIntervalStartDate.getTime())>3600000){// 1hr
                        if(!requestIsRunning){
                            savedUsername = await retrieveJSON("savedUsername") || ""
                            if(await $("#username").val()!==savedUsername) await $("#username").val(savedUsername)
                            await Update()
                            updateIntervalStartDate = await new Date()
                            await saveJSON(updateIntervalStartDate,"updateIntervalStartDate")
                        }
                    } else {
                        for(let i=0;i<updateIntervalTimeout.length;i++) await clearTimeout(updateIntervalTimeout[i])
                        var saveUpdateIntervalTimeout = setTimeout(async()=>{
                            if(!requestIsRunning){
                                savedUsername = await retrieveJSON("savedUsername") || ""
                                if(await $("#username").val()!==savedUsername) await $("#username").val(savedUsername)
                                await Update()
                                updateIntervalStartDate = await new Date()
                                await saveJSON(updateIntervalStartDate,"updateIntervalStartDate")
                            }
                        },await 3600000-((new Date).getTime()-(updateIntervalStartDate.getTime())))
                        await updateIntervalTimeout.push(saveUpdateIntervalTimeout)
                    }
                }
                resolve()
            })
            return
        }).then(async()=>{
            setTimeout(()=>{
                return
            },3000)
            // Auto Interval
            await new Promise(async(resolve)=>{
                // Export
                exportIntervalIsActive = await retrieveJSON("exportIntervalIsActive") || false
                if(await exportIntervalIsActive){
                    await $("#exportIntervalBtn").css({background: "white",color:"black"})
                    exportIntervalStartDate = await retrieveJSON("exportIntervalStartDate") || new Date()
                    await saveJSON(exportIntervalStartDate,"exportIntervalStartDate")
                    if(await ((new Date).getTime()-(exportIntervalStartDate.getTime())>3600000)){// 1hrs
                        $("#dataStatusContainer").hide()
                        $("#dataStatusSpinner").show()
                        $("#dataStatusContainer").css("display","flex").fadeIn(2500)
                        $("#dataStatus")
                            .empty()
                            .append(`Exporting data, please wait...`)
                        var worker = new Worker("./js-css/worker/export.js")
                        const savedUsername = await retrieveJSON("savedUsername")
                        const savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles")
                        const savedWarnAnime = await retrieveJSON("savedWarnAnime")
                        const savedUserList = await retrieveJSON("savedUserList")
                        const savedAnimeEntries = await retrieveJSON("savedAnimeEntries")
                        const savedRecScheme = await retrieveJSON("savedRecScheme")
                        const savedLatestAnimeID = await retrieveJSON("savedLatestAnimeID")
                        const savedAnalyzeVariableTime = await retrieveJSON("savedAnalyzeVariableTime")
                        const savedUpdateAnalyzeAnimeTime = await retrieveJSON("savedUpdateAnalyzeAnimeTime")
                        const savedDeepUpdateTime = await retrieveJSON("savedDeepUpdateTime")
                        const lastAnilistPage = await retrieveJSON("lastAnilistPage")
                        const savedAnalyzedVariablesCount = await retrieveJSON("savedAnalyzedVariablesCount")
                        worker.postMessage({
                            savedUsername: savedUsername,
                            savedWarnAnime: savedWarnAnime,
                            savedHiddenAnimeTitles: savedHiddenAnimeTitles,
                            savedRecScheme: savedRecScheme,
                            savedAnimeEntries: savedAnimeEntries,
                            savedLatestAnimeID: savedLatestAnimeID,
                            savedUserList: savedUserList,
                            savedAnalyzeVariableTime: savedAnalyzeVariableTime,
                            savedUpdateAnalyzeAnimeTime: savedUpdateAnalyzeAnimeTime,
                            savedDeepUpdateTime: savedDeepUpdateTime,
                            lastAnilistPage: lastAnilistPage,
                            savedAnalyzedVariablesCount: savedAnalyzedVariablesCount
                        })
                        worker.onmessage = async(message) => {
                            // Browser
                            await downloadObjectAsJson(message.data.backupStr, `Kanshi.${savedUsername.toLowerCase()||"Backup"}.json`)
                            // Browser
                            exportIntervalStartDate = await new Date()
                            await saveJSON(exportIntervalStartDate,"exportIntervalStartDate")
                            if(!requestIsRunning){
                                await $("#dataStatusContainer").fadeOut(2500)
                                await $("#dataStatus").empty()
                                await $("#dataStatusContainer").hide()
                            }
                            await Swal.fire({
                                heightAuto: false,
                                text: "Data has been exported!",
                                icon: "success",
                                confirmButtonColor: "#000"
                            })
                        }
                    } else {
                        for(let i=0;i<exportIntervalTimeout.length;i++) await clearTimeout(exportIntervalTimeout[i])
                        var saveExportIntervalTimeout = await setTimeout(async()=>{
                            $("#dataStatusContainer").hide()
                            $("#dataStatusSpinner").show()
                            $("#dataStatusContainer").css("display","flex").fadeIn(2500)
                            $("#dataStatus")
                                .empty()
                                .append(`Exporting data, please wait...`)
                            var worker = new Worker("./js-css/worker/export.js")
                            const savedUsername = await retrieveJSON("savedUsername")
                            const savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles")
                            const savedWarnAnime = await retrieveJSON("savedWarnAnime")
                            const savedUserList = await retrieveJSON("savedUserList")
                            const savedAnimeEntries = await retrieveJSON("savedAnimeEntries")
                            const savedRecScheme = await retrieveJSON("savedRecScheme")
                            const savedLatestAnimeID = await retrieveJSON("savedLatestAnimeID")
                            const savedAnalyzeVariableTime = await retrieveJSON("savedAnalyzeVariableTime")
                            const savedUpdateAnalyzeAnimeTime = await retrieveJSON("savedUpdateAnalyzeAnimeTime")
                            const savedDeepUpdateTime = await retrieveJSON("savedDeepUpdateTime")
                            const lastAnilistPage = await retrieveJSON("lastAnilistPage")
                            const savedAnalyzedVariablesCount = await retrieveJSON("savedAnalyzedVariablesCount")
                            worker.postMessage({
                                savedUsername: savedUsername,
                                savedWarnAnime: savedWarnAnime,
                                savedHiddenAnimeTitles: savedHiddenAnimeTitles,
                                savedRecScheme: savedRecScheme,
                                savedAnimeEntries: savedAnimeEntries,
                                savedLatestAnimeID: savedLatestAnimeID,
                                savedUserList: savedUserList,
                                savedAnalyzeVariableTime: savedAnalyzeVariableTime,
                                savedUpdateAnalyzeAnimeTime: savedUpdateAnalyzeAnimeTime,
                                savedDeepUpdateTime: savedDeepUpdateTime,
                                lastAnilistPage: lastAnilistPage,
                                savedAnalyzedVariablesCount: savedAnalyzedVariablesCount
                            })
                            worker.onmessage = async(message) => {
                                // Browser
                                await downloadObjectAsJson(message.data.backupStr, `Kanshi.${savedUsername.toLowerCase()||"Backup"}.json`)
                                // Browser
                                exportIntervalStartDate = await new Date()
                                await saveJSON(exportIntervalStartDate,"exportIntervalStartDate")
                                if(!requestIsRunning){
                                    await $("#dataStatusContainer").fadeOut(2500)
                                    await $("#dataStatus").empty()
                                    await $("#dataStatusContainer").hide()
                                }
                                await Swal.fire({
                                    heightAuto: false,
                                    text: "Data has been exported!",
                                    icon: "success",
                                    confirmButtonColor: "#000"
                                })
                            }
                        },await 3600000-((new Date).getTime()-(exportIntervalStartDate.getTime())))
                        await exportIntervalTimeout.push(saveExportIntervalTimeout)
                    }
                }
                resolve()
            })
            return
        }).then(async()=>{
            await new Promise((resolve) => {
                $(".loader").fadeOut("slow",()=>{return resolve()})
            })
        }).then(async()=>{
            await new Promise(async (resolve) => {
                if(savedUsername===undefined||savedUsername.length===0){
                    await initUsernameData()
                    resolve()
                } else {
                    resolve()
                }
            })
        })
    })
    // Event Listeners
    $("#username").on('keypress',async (e) =>{
        savedRecScheme = await retrieveJSON("savedRecScheme") || {}
        if(e.which===13) {
            $("#searchBtn").click()        
        }
    })
    $("#searchBtn").on('click', async ()=>{
        savedDeepUpdateTime = await retrieveJSON("savedDeepUpdateTime") || 320
        savedRecScheme = await retrieveJSON("savedRecScheme") || {}
        if(Object.keys(savedRecScheme).length>0) {
            savedUsername = await retrieveJSON("savedUsername")
            var newUsername = $("#username").val()
            if(equalsNCS(newUsername,savedUsername)){
                await $("#animeRecommendationList").empty()
                await $("#animeRecommendationList").append(`
                    <tr class="item" role="row">
                        <td style="padding: 1.5em !important;" colspan="14">
                            <div style="display:flex; align-items:center;">
                                <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                <div>Loading...</div>
                            </div>
                        </td>
                    </tr>
                `)
                LoadData(savedRecScheme)
            } else {
                Swal.fire({
                    heightAuto: false,
                    text: `Username was changed from ${savedUsername} to ${newUsername}. This will remove your current recommendation list, do you still want to continue?`,
                    showConfirmButton: true,
                    confirmButtonText: "Yes",
                    showDenyButton: true,
                    denyButtonText: "No",
                    confirmButtonColor: '#000',
                    denyButtonColor: '#e27d81',
                    icon: "question",
                    reverseButtons: true
                }).then(async(value)=>{
                    if(requestIsRunning){
                        Swal.fire({
                            heightAuto: false,
                            text: "List is already updating! Please wait a moment...",
                            icon: "info",
                            confirmButtonColor: "#000"
                        })
                    } else if(value.isConfirmed){
                        // Reset User List
                        savedUserList = {}
                        saveJSON(savedUserList,"savedUserList")
                        Update()
                    } else {
                        $("#username").focus()
                    }
                })
            }
        } else {
            if(!requestIsRunning){
                Swal.fire({
                    heightAuto: false,
                    text: `Do you want to continue and update your recommendations list?
                    The estimated time to finish is ${msToTime(savedDeepUpdateTime*1000)}`,
                    showConfirmButton: true,
                    confirmButtonText: "Yes",
                    showDenyButton: true,
                    denyButtonText: "No",
                    confirmButtonColor: '#000',
                    denyButtonColor: '#e27d81',
                    icon: "question",
                    reverseButtons: true
                })
                .then((value) => {
                    if(value.isConfirmed){
                        deepUpdateStartTime = new Date()
                        isDeepUpdate = true
                        Update()
                    }
                })
            } else {
                Swal.fire({
                    heightAuto: false,
                    text: "List is already updating! Please wait a moment...",
                    icon: "info",
                    confirmButtonColor: "#000"
                })
            }
        }
    })
    $("#menuIcon, #menuTitle").on("click",()=>{
        var menu = $(".menu-container")
        if(menu.css("display")=="none"){
            menu.fadeIn(250)
        } else {
            menu.fadeOut(250)
        }
    })
    $("#updateBtn").on('click', async ()=>{
        var savedUpdateTime = (await retrieveJSON("savedAnalyzeVariableTime") || 20) + (await retrieveJSON("savedUpdateAnalyzeAnimeTime") || 3)
        if(!requestIsRunning){
            Swal.fire({
                heightAuto: false,
                text: `Do you want to continue and update your recommendations list?
                This may take ${msToTime(savedUpdateTime*1000)} to finish.`,
                showConfirmButton: true,
                confirmButtonText: "Yes",
                showDenyButton: true,
                denyButtonText: "No",
                confirmButtonColor: '#000',
                denyButtonColor: '#e27d81',
                icon: "question",
                reverseButtons: true
            })
            .then(async(value) => {
                if(value.isConfirmed){
                    var newUsername = await $("#username").val()
                    savedUsername = await retrieveJSON("savedUsername") || ""
                    if(newUsername!==savedUsername){
                        Swal.fire({
                            heightAuto: false,
                            text: `Username was changed from ${savedUsername} to ${newUsername}. This will remove your current recommendation list, do you still want to continue?`,
                            showConfirmButton: true,
                            confirmButtonText: "Yes",
                            showDenyButton: true,
                            denyButtonText: "No",
                            confirmButtonColor: '#000',
                            denyButtonColor: '#e27d81',
                            icon: "question",
                            reverseButtons: true
                        }).then(async(value)=>{
                            $(".menu-container").fadeOut(250)
                            if(value.isConfirmed){
                                // Reset User List
                                savedUserList = {}
                                await saveJSON(savedUserList,"savedUserList")
                                Update()
                            } else {
                                $("#username").focus()
                            }
                        })
                    } else {
                        Update()
                        $(".menu-container").fadeOut(250)
                    }
                }
            })
        } else {
            Swal.fire({
                heightAuto: false,
                text: "List is already updating! Please wait a moment...",
                icon: "info",
                confirmButtonColor: "#000"
            })
        }
    })
    $("#deepUpdateBtn").on("click", async ()=>{
        savedDeepUpdateTime = await retrieveJSON("savedDeepUpdateTime") || 320
        if(!requestIsRunning){
            Swal.fire({
                heightAuto: false,
                text: `Do you want to continue and update all data in your recommendations list?
                This may take ${msToTime(savedDeepUpdateTime*1000)} to finish.`,
                showConfirmButton: true,
                confirmButtonText: "Yes",
                showDenyButton: true,
                denyButtonText: "No",
                confirmButtonColor: '#000',
                denyButtonColor: '#e27d81',
                icon: "question",
                reverseButtons: true
            })
            .then(async(value) => {
                if(value.isConfirmed){
                    deepUpdateStartTime = new Date()
                    isDeepUpdate = true
                    await Update()
                    $(".menu-container").fadeOut(250)
                }
            })
        } else {
            Swal.fire({
                heightAuto: false,
                text: "List is already updating! Please wait a moment...",
                icon: "info",
                confirmButtonColor: "#000"
            })
        }
    })
    $("#hiddenUnhiddenBtn").on('click', async()=>{
        if(!isRunning){
            isRunning = true
            savedUsername = await retrieveJSON("savedUsername") || ""
            savedRecScheme = await retrieveJSON("savedRecScheme") || {}
            if(savedUsername.length>0&&Object.keys(savedRecScheme).length>0){
                var state = await $("#hiddenUnhiddenBtn").text()
                if(!equalsNCS($("#username").val(),savedUsername)){
                    await $("#username").val(savedUsername)
                }
                if(state==="Unhidden"){
                    if($("#filters .flexdatalist-multiple-value > .flexdatalist-alias").length){
                        var filterInput = await $("#filters .flexdatalist-multiple-value > .flexdatalist-alias")
                        await filterInput.val("hidden")
                        var e = await $.Event("keyup",{keyCode:13})
                        await filterInput.trigger(e)
                        await filterInput.val("")
                    }
                    await $("#hiddenUnhiddenBtn").text("Hidden")
                    saveJSON("Hidden","savedTableStatus")
                    await $("#animeRecommendationList").empty()
                    await $("#animeRecommendationList").append(`
                        <tr class="item" role="row">
                            <td style="padding: 1.5em !important;" colspan="14">
                                <div style="display:flex; align-items:center;">
                                    <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                    <div>Loading...</div>
                                </div>
                            </td>
                        </tr>
                    `)
                    await LoadData(savedRecScheme)
                    setTimeout(()=>{
                        let setPageInfo = setInterval(()=>{
                            if(typeof $('#anime-table')[0].config!=="undefined"){
                                clearInterval(setPageInfo)
                                $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                            }
                        },1)
                    },0)
                    isRunning = false
                } else {
                    if($("#filters .flexdatalist-multiple-value").length){
                        var filters = await $("#filters .flexdatalist-multiple").children("li.value")
                        for(let i=0; i<filters.length; i++) {
                            var filterName = await filters.eq(i).children(".text")[0].innerText
                            if(filterName.toLowerCase()==="hidden"){
                                await filters.eq(i).children(".fdl-remove").trigger("click")
                                await $("#filters .flexdatalist-alias").blur()
                            }
                        }
                    }
                    await $("#hiddenUnhiddenBtn").text("Unhidden")
                    saveJSON("Unhidden","savedTableStatus")
                    await $("#animeRecommendationList").empty()
                    await $("#animeRecommendationList").append(`
                        <tr class="item" role="row">
                            <td style="padding: 1.5em !important;" colspan="14">
                                <div style="display:flex; align-items:center;">
                                    <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                    <div>Loading...</div>
                                </div>
                            </td>
                        </tr>
                    `)
                    await LoadData(savedRecScheme)
                    setTimeout(()=>{
                        let setPageInfo = setInterval(()=>{
                            if(typeof $('#anime-table')[0].config!=="undefined"){
                                clearInterval(setPageInfo)
                                $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                            }
                        },1)
                    },0)
                    isRunning = false
                }
            } else isRunning = false
        }
    })
    $("#showAllAnime").on('click', ()=>{
        Swal.fire({
            heightAuto: false,
            text: "Do you want to show all your hidden anime? This will remove all hidden Anime in the hidden's list!",
            showConfirmButton: true,
            confirmButtonText: "Yes",
            showDenyButton: true,
            denyButtonText: "No",
            confirmButtonColor: '#000',
            denyButtonColor: '#e27d81',
            icon: "question",
            reverseButtons: true
        })
        .then(async(value) => {
            if(value.isConfirmed){
                savedUsername = await retrieveJSON("savedUsername") || ""
                if(!equalsNCS($("#username").val(),savedUsername)){
                    $("#username").val(savedUsername)
                }
                saveJSON([], "savedHiddenAnimeTitles")
                if(await $("#filters .flexdatalist-multiple-value").length){
                    var filters = await $("#filters .flexdatalist-multiple").children("li.value")
                    for(let i=0; i<filters.length; i++) {
                        var filterName = await filters.eq(i).children(".text")[0].innerText
                        if(filterName.toLowerCase()==="hidden"){
                            await filters.eq(i).children(".fdl-remove").trigger("click")
                            await $("#filters .flexdatalist-alias").blur()
                        }
                    }
                }
                if($("#hiddenUnhiddenBtn").text()==="Hidden"){
                    await $("#animeRecommendationList").empty()
                    await $("#animeRecommendationList").append(`
                        <tr class="item" role="row">
                            <td style="padding: 1.5em !important;" colspan="14">
                                <div style="display:flex; align-items:center;">
                                    <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                    <div>Loading...</div>
                                </div>
                            </td>
                        </tr>
                    `)
                }
                savedRecScheme = await retrieveJSON("savedRecScheme") || {}
                await LoadData(savedRecScheme)
                $("#hiddenUnhiddenBtn").text("Unhidden")
                savedUnhiddenTablePage = await retrieveJSON("savedUnhiddenTablePage") || 0
                await $('#anime-table').trigger("pageSet",savedUnhiddenTablePage)
                setTimeout(()=>{
                    let setPageInfo = setInterval(()=>{
                        if(typeof $('#anime-table')[0].config!=="undefined"){
                            clearInterval(setPageInfo)
                            $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                        }
                    },1)
                },0)
                saveJSON("Unhidden","savedTableStatus")
                $("#showAllAnime").hide()
                $(".menu-container").fadeOut(250)
                Swal.fire({
                    heightAuto: false,
                    text: "All hidden anime has now been successfully transferred to your List!",
                    icon: "success",
                    confirmButtonColor: "#000"
                })
            }
        })
    })
    $("#importBtn").on("click", ()=>{
        $("#importFile").click()
    })
    $("#importFile").on("change",(event)=>{
        if($("#importFile")[0].value != ""){
            const importedFile = $("#importFile")[0].files[0]
            const reader = new FileReader()
            reader.onload = async() => {
                const fullPath = $("#importFile")[0].value
                $("#importBtn").css({background: "white", color: "black"})
                const startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
                var filename = fullPath.substring(startIndex);
                if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
                    filename = filename.substring(1);
                }
                if(savedUsername!==undefined&&savedUsername.length){
                    Swal.fire({
                        heightAuto: false,
                        text: `File named [${filename}] been detected, do you want to continue the import? This will remove your current data!`,
                        showConfirmButton: true,
                        confirmButtonText: "Yes",
                        showDenyButton: true,
                        denyButtonText: "No",
                        confirmButtonColor: '#000',
                        denyButtonColor: '#e27d81',
                        icon: "question",
                        reverseButtons: true
                    })
                    .then(async(value) => {
                        if(value.isConfirmed){
                            var fileContent
                            await new Promise(async(resolve,reject)=>{
                                await $("#importBtn").css({background: "black", color: "white"})
                                try{
                                    fileContent = await JSON.parse(reader.result);
                                } catch(ex) {
                                    $("#importFile")[0].value = null
                                    Swal.fire({
                                        heightAuto: false,
                                        text: "Error: Invalid Backup File",
                                        icon: "error",
                                        confirmButtonColor: "#000"
                                    })
                                }
                                if(fileContent.savedUsername===undefined||fileContent.savedUsername===null) {
                                    $("#importFile")[0].value = null
                                    Swal.fire({
                                        heightAuto: false,
                                        text: "Error: Backup file does not Have a Username",
                                        icon: "error",
                                        confirmButtonColor: "#000"
                                    })
                                    reject()
                                } else {
                                    await $(".menu-container").fadeOut(250)
                                    $("#dataStatusContainer").hide()
                                    $("#dataStatusSpinner").show()
                                    $("#dataStatusContainer").css("display","flex").fadeIn(2500)
                                    $("#dataStatus")
                                        .empty()
                                        .append(`Importing data, please wait...`)
                                    resolve()
                                }
                            }).then(async()=>{
                                savedUsername = await fileContent.savedUsername || ""
                                await $("#username").val(savedUsername)
                                await saveJSON(savedUsername,"savedUsername")
                                return
                            }).then(async()=>{
                                savedHiddenAnimeTitles = await fileContent.savedHiddenAnimeTitles || []
                                await saveJSON(savedHiddenAnimeTitles,"savedHiddenAnimeTitles")
                                if(savedHiddenAnimeTitles.length) $("#showAllAnime").show()
                                else $("#showAllAnime").hide()
                                return
                            }).then(async()=>{
                                savedRecScheme = await fileContent.savedRecScheme || {}
                                await saveJSON(savedRecScheme,"savedRecScheme")
                            }).then(async()=>{
                                savedAnimeEntries = await fileContent.savedAnimeEntries || []
                                await saveJSON(savedAnimeEntries,"savedAnimeEntries")
                            }).then(async()=>{
                                savedLatestAnimeID = await fileContent.savedLatestAnimeID || ""
                                await saveJSON(savedLatestAnimeID,"savedLatestAnimeID")
                            }).then(async()=>{
                                savedUserList = await fileContent.savedUserList || {}
                                await saveJSON(savedUserList,"savedUserList")
                            }).then(async()=>{
                                savedAnalyzeVariableTime = await fileContent.savedAnalyzeVariableTime || 20
                                await saveJSON(savedAnalyzeVariableTime,"savedAnalyzeVariableTime")
                            }).then(async()=>{
                                savedUpdateAnalyzeAnimeTime = await fileContent.savedUpdateAnalyzeAnimeTime || 3
                                await saveJSON(savedUpdateAnalyzeAnimeTime,"savedUpdateAnalyzeAnimeTime")
                            }).then(async()=>{
                                lastAnilistPage = await fileContent.lastAnilistPage || 284
                                await saveJSON(lastAnilistPage,"lastAnilistPage")
                            }).then(async()=>{
                                savedWarnAnime = await fileContent.savedWarnAnime || [ "ecchi","mahou shoujo","!boys' love","cgi","!ero guro","!female harem",
                                                                                    "full cgi","kids","love triangle","!male harem","!mixed gender harem",
                                                                                    "!nudity","!slavery","!suicide","tokusatsu","!yuri","wuxia","!netorare",
                                                                                    "!rape"
                                                                                    ]
                                await saveJSON(savedWarnAnime,"savedWarnAnime")
                                return
                            }).then(async()=>{
                                await $("#username").val(savedUsername)
                                return
                            }).then(async()=>{
                                await new Promise(async(resolve)=>{
                                    await $("#warnAnimeContainer").css({visibility:"hidden"}).show()
                                    let reloadSavedData = await setInterval(async () => {
                                        if(await $("#warnAnimeContainer .flexdatalist-multiple-value > .flexdatalist-alias").length){
                                            await clearInterval(reloadSavedData)
                                            await new Promise(async(resolve)=>{
                                                // Remove Current Filters
                                                var warnInfo = await $("#warnAnimeModal .flexdatalist-multiple").children("li.value")
                                                for(let i=0; i<warnInfo.length; i++) {
                                                    var infoName = await warnInfo.eq(i).children(".text")[0].innerText
                                                    await warnInfo.eq(i).children(".fdl-remove").trigger("click")
                                                    await $("#warnAnimeModal .flexdatalist-alias").blur()
                                                }
                                                resolve()
                                            }).then(async()=>{
                                                // Reload Filters
                                                var warnAnimeInput
                                                for(let i=0; i<savedWarnAnime.length; i++) {
                                                    warnAnimeInput = await $("#warnAnimeModal .flexdatalist-multiple-value > .flexdatalist-alias")
                                                    await warnAnimeInput.val(savedWarnAnime[i])
                                                    var e = await $.Event("keyup",{keyCode:13})
                                                    await warnAnimeInput.trigger(e)
                                                    await warnAnimeInput.val("")
                                                }
                                                await $("#warnAnimeContainer").css({visibility:"visible"}).hide()
                                                return
                                            })
                                            resolve()
                                        }
                                    },1)
                                })
                                return
                            }).then(async()=>{
                                if(Object.keys(savedRecScheme).length) {
                                    await $("#updateBtn").show()
                                    await $("#updateIntervalBtn").show()
                                    await LoadData(savedRecScheme)
                                } else {
                                    await $("#updateBtn").hide()
                                    await $("#updateIntervalBtn").hide()
                                    animeData = `
                                        <tr class="item" role="row">
                                            <td style="padding: 1.5em !important;" colspan="14">
                                                <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                                No Data
                                            </td>
                                        </tr>
                                    `
                                    await $("#animeRecommendationList").empty()
                                    await $("#animeRecommendationList").append(animeData)
                                    await $("#anime-table").trigger("update")
                                }
                                return
                            }).then(async()=>{
                                $("#importFile")[0].value = null
                                if(!requestIsRunning){
                                    $("#dataStatusContainer").fadeOut(2500)
                                    $("#dataStatus").empty()
                                    $("#dataStatusContainer").hide()       
                                }
                                await Swal.fire({
                                    heightAuto: false,
                                    text: "Data has been updated!",
                                    icon: "success",
                                    confirmButtonColor: "#000"
                                })
                                return
                            })
                            .catch(()=>{
                                return
                            })
                        } else {
                            $("#importFile")[0].value = null
                            await $("#importBtn").css({background: "black", color: "white"})
                        }
                    })
                } else {
                    var fileContent
                    await new Promise(async(resolve,reject)=>{
                        await $("#importBtn").css({background: "black", color: "white"})
                        try{
                            fileContent = await JSON.parse(reader.result)
                        } catch(ex) {
                            $("#importFile")[0].value = null
                            $(".swal2-validation-message")
                                .html(
                                    `Error: Invalid Backup File`
                                )
                                .css({display:"flex"})
                            return
                        }
                        if(fileContent.savedUsername===undefined||fileContent.savedUsername===null) {
                            $("#importFile")[0].value = null
                            $(".swal2-validation-message")
                                .html(
                                    `Error: Backup file does not Have a Username`
                                )
                                .css({display:"flex"})
                            reject()
                        } else {
                            $(".swal2-validation-message").addClass("no-before")
                                .css({display:"flex"})
                                .html(
                                    `<div id="UsernameValidation" style="display:flex; align-items:center; justify-content:center; ">
                                        <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                        <div>Importing Data...</div>
                                    </div>`
                                )
                            resolve()
                        }
                    }).then(async()=>{
                        savedUsername = await fileContent.savedUsername || ""
                        await $("#username").val(savedUsername)
                        await saveJSON(savedUsername,"savedUsername")
                        return
                    }).then(async()=>{
                        savedHiddenAnimeTitles = await fileContent.savedHiddenAnimeTitles || []
                        await saveJSON(savedHiddenAnimeTitles,"savedHiddenAnimeTitles")
                        if(savedHiddenAnimeTitles.length) $("#showAllAnime").show()
                        else $("#showAllAnime").hide()
                        return
                    }).then(async()=>{
                        savedRecScheme = await fileContent.savedRecScheme || {}
                        await saveJSON(savedRecScheme,"savedRecScheme")
                    }).then(async()=>{
                        savedAnimeEntries = await fileContent.savedAnimeEntries || []
                        await saveJSON(savedAnimeEntries,"savedAnimeEntries")
                    }).then(async()=>{
                        savedLatestAnimeID = await fileContent.savedLatestAnimeID || ""
                        await saveJSON(savedLatestAnimeID,"savedLatestAnimeID")
                    }).then(async()=>{
                        savedUserList = await fileContent.savedUserList || {}
                        await saveJSON(savedUserList,"savedUserList")
                    }).then(async()=>{
                        savedAnalyzeVariableTime = await fileContent.savedAnalyzeVariableTime || 20
                        await saveJSON(savedAnalyzeVariableTime,"savedAnalyzeVariableTime")
                    }).then(async()=>{
                        savedUpdateAnalyzeAnimeTime = await fileContent.savedUpdateAnalyzeAnimeTime || 3
                        await saveJSON(savedUpdateAnalyzeAnimeTime,"savedUpdateAnalyzeAnimeTime")
                    }).then(async()=>{
                        lastAnilistPage = await fileContent.lastAnilistPage || 284
                        await saveJSON(lastAnilistPage,"lastAnilistPage")
                    }).then(async()=>{
                        savedWarnAnime = await fileContent.savedWarnAnime || [ "ecchi","mahou shoujo","!boys' love","cgi","!ero guro","!female harem",
                                                                            "full cgi","kids","love triangle","!male harem","!mixed gender harem",
                                                                            "!nudity","!slavery","!suicide","tokusatsu","!yuri","wuxia","!netorare",
                                                                            "!rape"
                                                                            ]
                        await saveJSON(savedWarnAnime,"savedWarnAnime")
                        return
                    }).then(async()=>{
                        await $("#username").val(savedUsername)
                        return
                    }).then(async()=>{
                        await new Promise(async(resolve)=>{
                            await $("#warnAnimeContainer").css({visibility:"hidden"}).show()
                            let reloadSavedData = await setInterval(async () => {
                                if(await $("#warnAnimeModal .flexdatalist-multiple-value > .flexdatalist-alias").length){
                                    await clearInterval(reloadSavedData)
                                    await new Promise(async(resolve)=>{
                                        // Remove Current Filters
                                        var warnInfo = await $("#warnAnimeModal .flexdatalist-multiple").children("li.value")
                                        for(let i=0; i<warnInfo.length; i++) {
                                            var infoName = await warnInfo.eq(i).children(".text")[0].innerText
                                            await warnInfo.eq(i).children(".fdl-remove").trigger("click")
                                            await $("#warnAnimeModal .flexdatalist-alias").blur()
                                        }
                                        resolve()
                                    }).then(async()=>{
                                        // Reload Filters
                                        var warnAnimeInput
                                        for(let i=0; i<savedWarnAnime.length; i++) {
                                            warnAnimeInput = await $("#warnAnimeModal .flexdatalist-multiple-value > .flexdatalist-alias")
                                            await warnAnimeInput.val(savedWarnAnime[i])
                                            var e = await $.Event("keyup",{keyCode:13})
                                            await warnAnimeInput.trigger(e)
                                            await warnAnimeInput.val("")
                                        }
                                        await $("#warnAnimeContainer").css({visibility:"visible"}).hide()
                                        return
                                    })
                                    resolve()
                                }
                            },1)
                        })
                        return
                    }).then(async()=>{
                        if(Object.keys(savedRecScheme).length) {
                            await $("#updateBtn").show()
                            await $("#updateIntervalBtn").show()
                            await LoadData(savedRecScheme)
                        } else {
                            await $("#updateBtn").hide()
                            await $("#updateIntervalBtn").hide()
                            animeData = `
                                <tr class="item" role="row">
                                    <td style="padding: 1.5em !important;" colspan="14">
                                        <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                        No Data
                                    </td>
                                </tr>
                            `
                            await $("#animeRecommendationList").empty()
                            await $("#animeRecommendationList").append(animeData)
                            await $("#anime-table").trigger("update")
                        }
                        return
                    }).then(async()=>{
                        $("#importFile")[0].value = null
                        await Swal.fire({
                            heightAuto: false,
                            text: "Data has been updated!",
                            icon: "success",
                            confirmButtonColor: "#000"
                        })
                        return
                    })
                    .catch(()=>{
                        return
                    })
                }
            }
            reader.readAsText(importedFile);  
        }
    })
    $("#exportBtn").on("click", async()=>{
        Swal.fire({
            heightAuto: false,
            text: `Do you want to export your data?`,
            showConfirmButton: true,
            confirmButtonText: "Yes",
            showDenyButton: true,
            denyButtonText: "No",
            confirmButtonColor: '#000',
            denyButtonColor: '#e27d81',
            icon: "question",
            reverseButtons: true
        })
        .then(async(value) => {
            if(value.isConfirmed){
                await new Promise(async(resolve)=>{
                    await $(".menu-container").fadeOut(250)
                    await $("#dataStatusContainer").hide()
                    await $("#dataStatusSpinner").show()
                    await $("#dataStatusContainer").css("display","flex").fadeIn(2500)
                    await $("#dataStatus")
                        .empty()
                        .append(`Exporting data, please wait...`)
                    resolve()
                }).then(async()=>{
                    var worker = new Worker("./js-css/worker/export.js")
                    const savedUsername = await retrieveJSON("savedUsername")
                    const savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles")
                    const savedWarnAnime = await retrieveJSON("savedWarnAnime")
                    const savedUserList = await retrieveJSON("savedUserList")
                    const savedAnimeEntries = await retrieveJSON("savedAnimeEntries")
                    const savedRecScheme = await retrieveJSON("savedRecScheme")
                    const savedLatestAnimeID = await retrieveJSON("savedLatestAnimeID")
                    const savedAnalyzeVariableTime = await retrieveJSON("savedAnalyzeVariableTime")
                    const savedUpdateAnalyzeAnimeTime = await retrieveJSON("savedUpdateAnalyzeAnimeTime")
                    const savedDeepUpdateTime = await retrieveJSON("savedDeepUpdateTime")
                    const lastAnilistPage = await retrieveJSON("lastAnilistPage")
                    const savedAnalyzedVariablesCount = await retrieveJSON("savedAnalyzedVariablesCount")
                    worker.postMessage({
                        savedUsername: savedUsername,
                        savedWarnAnime: savedWarnAnime,
                        savedHiddenAnimeTitles: savedHiddenAnimeTitles,
                        savedRecScheme: savedRecScheme,
                        savedAnimeEntries: savedAnimeEntries,
                        savedLatestAnimeID: savedLatestAnimeID,
                        savedUserList: savedUserList,
                        savedAnalyzeVariableTime: savedAnalyzeVariableTime,
                        savedUpdateAnalyzeAnimeTime: savedUpdateAnalyzeAnimeTime,
                        savedDeepUpdateTime: savedDeepUpdateTime,
                        lastAnilistPage: lastAnilistPage,
                        savedAnalyzedVariablesCount: savedAnalyzedVariablesCount
                    })
                    worker.onmessage = async(message) => {
                        // Browser
                        await downloadObjectAsJson(message.data.backupStr, `Kanshi.${savedUsername.toLowerCase()||"Backup"}.json`)
                        // Browser
                        if(!requestIsRunning){
                            await $("#dataStatusContainer").fadeOut(2500)
                            await $("#dataStatus").empty()
                            await $("#dataStatusContainer").hide()
                        }
                        await Swal.fire({
                            heightAuto: false,
                            text: "Data has been exported!",
                            icon: "success",
                            confirmButtonColor: "#000"
                        })
                    }
                })
            }
        })
    })
    $("#updateIntervalBtn").on("click",async()=>{
        updateIntervalIsActive = await retrieveJSON("updateIntervalIsActive") || false
        if(updateIntervalIsActive){
            Swal.fire({
                heightAuto: false,
                text: `Do you want to disable auto update for your recommendations list every 1 hour?`,
                showConfirmButton: true,
                confirmButtonText: "Yes",
                showDenyButton: true,
                denyButtonText: "No",
                confirmButtonColor: '#000',
                denyButtonColor: '#e27d81',
                icon: "question",
                reverseButtons: true
            })
            .then(async(value) => {
                if(value.isConfirmed){
                    $("#updateIntervalBtn").css({background:"black",color:"white"})
                    updateIntervalIsActive = false
                    saveJSON(updateIntervalIsActive,"updateIntervalIsActive")
                }
            })
        } else {
            Swal.fire({
                heightAuto: false,
                text: `Do you want to enable auto update for your recommendations list every 1 hour?`,
                showConfirmButton: true,
                confirmButtonText: "Yes",
                showDenyButton: true,
                denyButtonText: "No",
                confirmButtonColor: '#000',
                denyButtonColor: '#e27d81',
                icon: "question",
                reverseButtons: true
            })
            .then(async(value) => {
                if(value.isConfirmed){
                    $("#updateIntervalBtn").css({background:"white",color:"black"})
                    updateIntervalIsActive = true
                    saveJSON(updateIntervalIsActive,"updateIntervalIsActive")
                    updateIntervalStartDate = await retrieveJSON("updateIntervalStartDate") || new Date()
                    saveJSON(updateIntervalStartDate,"updateIntervalStartDate")
                    if((new Date).getTime()-(updateIntervalStartDate.getTime())>3600000){// 1hrs
                        if(!requestIsRunning){
                            savedUsername = await retrieveJSON("savedUsername") || ""
                            if(await $("#username").val()!==savedUsername) await $("#username").val(savedUsername)
                            Update()
                            updateIntervalStartDate = new Date()
                            saveJSON(updateIntervalStartDate,"updateIntervalStartDate")
                        }
                    } else {
                        for(let i=0;i<updateIntervalTimeout.length;i++) clearTimeout(updateIntervalTimeout[i])
                        var saveUpdateIntervalTimeout = setTimeout(async()=>{
                            if(!requestIsRunning){
                                savedUsername = await retrieveJSON("savedUsername") || ""
                                if(await $("#username").val()!==savedUsername) await $("#username").val(savedUsername)
                                Update()
                                updateIntervalStartDate = new Date()
                                saveJSON(updateIntervalStartDate,"updateIntervalStartDate")
                            }
                        },3600000-((new Date).getTime()-(updateIntervalStartDate.getTime())))
                        updateIntervalTimeout.push(saveUpdateIntervalTimeout)
                    }
                }
            })
        }
    })
    $("#exportIntervalBtn").on("click",async()=>{
        exportIntervalIsActive = await retrieveJSON("exportIntervalIsActive") || false
        if(exportIntervalIsActive){
            Swal.fire({
                heightAuto: false,
                text: `Do you want to disable data back-up every 1 hour?`,
                showConfirmButton: true,
                confirmButtonText: "Yes",
                showDenyButton: true,
                denyButtonText: "No",
                confirmButtonColor: '#000',
                denyButtonColor: '#e27d81',
                icon: "question",
                reverseButtons: true
            })
            .then(async(value) => {
                if(value.isConfirmed){
                    $("#exportIntervalBtn").css({background:"black",color:"white"})
                    exportIntervalIsActive = false
                    saveJSON(exportIntervalIsActive,"exportIntervalIsActive")
                }
            })
        } else {
            Swal.fire({
                heightAuto: false,
                text: `Do you want to enable data Back-Up every 1 hour?`,
                showConfirmButton: true,
                confirmButtonText: "Yes",
                showDenyButton: true,
                denyButtonText: "No",
                confirmButtonColor: '#000',
                denyButtonColor: '#e27d81',
                icon: "question",
                reverseButtons: true
            })
            .then(async(value) => {
                if(value.isConfirmed){
                    $("#exportIntervalBtn").css({background:"white",color:"black"})
                    exportIntervalIsActive = true
                    saveJSON(exportIntervalIsActive,"exportIntervalIsActive")
                    exportIntervalStartDate = await retrieveJSON("exportIntervalStartDate") || new Date()
                    saveJSON(exportIntervalStartDate,"exportIntervalStartDate")
                    if((new Date).getTime()-(exportIntervalStartDate.getTime())>3600000){// 1hrs
                        await new Promise(async(resolve)=>{
                            await $(".menu-container").fadeOut(250)
                            await $("#dataStatusContainer").hide()
                            await $("#dataStatusSpinner").show()
                            await $("#dataStatusContainer").css("display","flex").fadeIn(2500)
                            await $("#dataStatus")
                                .empty()
                                .append(`Exporting data, please wait...`)
                            resolve()
                        }).then(async()=>{
                            var worker = new Worker("./js-css/worker/export.js")
                            const savedUsername = await retrieveJSON("savedUsername")
                            const savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles")
                            const savedWarnAnime = await retrieveJSON("savedWarnAnime")
                            const savedUserList = await retrieveJSON("savedUserList")
                            const savedAnimeEntries = await retrieveJSON("savedAnimeEntries")
                            const savedRecScheme = await retrieveJSON("savedRecScheme")
                            const savedLatestAnimeID = await retrieveJSON("savedLatestAnimeID")
                            const savedAnalyzeVariableTime = await retrieveJSON("savedAnalyzeVariableTime")
                            const savedUpdateAnalyzeAnimeTime = await retrieveJSON("savedUpdateAnalyzeAnimeTime")
                            const savedDeepUpdateTime = await retrieveJSON("savedDeepUpdateTime")
                            const lastAnilistPage = await retrieveJSON("lastAnilistPage")
                            const savedAnalyzedVariablesCount = await retrieveJSON("savedAnalyzedVariablesCount")
                            worker.postMessage({
                                savedUsername: savedUsername,
                                savedWarnAnime: savedWarnAnime,
                                savedHiddenAnimeTitles: savedHiddenAnimeTitles,
                                savedRecScheme: savedRecScheme,
                                savedAnimeEntries: savedAnimeEntries,
                                savedLatestAnimeID: savedLatestAnimeID,
                                savedUserList: savedUserList,
                                savedAnalyzeVariableTime: savedAnalyzeVariableTime,
                                savedUpdateAnalyzeAnimeTime: savedUpdateAnalyzeAnimeTime,
                                savedDeepUpdateTime: savedDeepUpdateTime,
                                lastAnilistPage: lastAnilistPage,
                                savedAnalyzedVariablesCount: savedAnalyzedVariablesCount
                            })
                            worker.onmessage = async(message) => {
                                // Browser
                                await downloadObjectAsJson(message.data.backupStr, `Kanshi.${savedUsername.toLowerCase()||"Backup"}.json`)
                                // Browser
                                exportIntervalStartDate = await new Date()
                                await saveJSON(exportIntervalStartDate,"exportIntervalStartDate")
                                if(!requestIsRunning){
                                    await $("#dataStatusContainer").fadeOut(2500)
                                    await $("#dataStatus").empty()
                                    await $("#dataStatusContainer").hide()   
                                }
                                await Swal.fire({
                                    heightAuto: false,
                                    text: "Data has been exported!",
                                    icon: "success",
                                    confirmButtonColor: "#000"
                                })
                            }
                        })
                    } else {
                        for(let i=0;i<exportIntervalTimeout.length;i++) clearTimeout(exportIntervalTimeout[i])
                        var saveExportIntervalTimeout = setTimeout(async()=>{
                            await $("#dataStatusContainer").hide()
                            await $("#dataStatusSpinner").show()
                            await $("#dataStatusContainer").css("display","flex").fadeIn(2500)
                            await $("#dataStatus")
                                .empty()
                                .append(`Exporting data, please wait...`)
                            var worker = new Worker("./js-css/worker/export.js")
                            const savedUsername = await retrieveJSON("savedUsername")
                            const savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles")
                            const savedWarnAnime = await retrieveJSON("savedWarnAnime")
                            const savedUserList = await retrieveJSON("savedUserList")
                            const savedAnimeEntries = await retrieveJSON("savedAnimeEntries")
                            const savedRecScheme = await retrieveJSON("savedRecScheme")
                            const savedLatestAnimeID = await retrieveJSON("savedLatestAnimeID")
                            const savedAnalyzeVariableTime = await retrieveJSON("savedAnalyzeVariableTime")
                            const savedUpdateAnalyzeAnimeTime = await retrieveJSON("savedUpdateAnalyzeAnimeTime")
                            const savedDeepUpdateTime = await retrieveJSON("savedDeepUpdateTime")
                            const lastAnilistPage = await retrieveJSON("lastAnilistPage")
                            const savedAnalyzedVariablesCount = await retrieveJSON("savedAnalyzedVariablesCount")
                            worker.postMessage({
                                savedUsername: savedUsername,
                                savedWarnAnime: savedWarnAnime,
                                savedHiddenAnimeTitles: savedHiddenAnimeTitles,
                                savedRecScheme: savedRecScheme,
                                savedAnimeEntries: savedAnimeEntries,
                                savedLatestAnimeID: savedLatestAnimeID,
                                savedUserList: savedUserList,
                                savedAnalyzeVariableTime: savedAnalyzeVariableTime,
                                savedUpdateAnalyzeAnimeTime: savedUpdateAnalyzeAnimeTime,
                                savedDeepUpdateTime: savedDeepUpdateTime,
                                lastAnilistPage: lastAnilistPage,
                                savedAnalyzedVariablesCount: savedAnalyzedVariablesCount
                            })
                            worker.onmessage = async(message) => {
                                // Browser
                                await downloadObjectAsJson(message.data.backupStr, `Kanshi.${savedUsername.toLowerCase()||"Backup"}.json`)
                                // Browser
                                exportIntervalStartDate = await new Date()
                                await saveJSON(exportIntervalStartDate,"exportIntervalStartDate")
                                if(!requestIsRunning){
                                    await $("#dataStatusContainer").fadeOut(2500)
                                    await $("#dataStatus").empty()
                                    await $("#dataStatusContainer").hide()
                                }
                                await Swal.fire({
                                    heightAuto: false,
                                    text: "Data has been exported!",
                                    icon: "success",
                                    confirmButtonColor: "#000"
                                })
                            }
                        },3600000-((new Date).getTime()-(exportIntervalStartDate.getTime())))
                        exportIntervalTimeout.push(saveExportIntervalTimeout)
                    }
                }
            })
        }
    })
    $("#warnAnimeBtn").on("click", async ()=>{
        $("#warnAnimeContainer").removeClass("swal2-hide").addClass("swal2-show").show()
    })
    $("#submitWarnAnime").on("click",async()=>{
        var warnAnimeInputs = $("#warnAnimeModal .flexdatalist-multiple > .value").children(".text")
        var warnAnime = []
        for(let i=0; i<warnAnimeInputs.length; i++){
            var warnName = warnAnimeInputs[i].textContent
            warnAnime.push(warnName)
        }
        await saveJSON(warnAnime,"savedWarnAnime")
        savedRecScheme = await retrieveJSON("savedRecScheme")
        await $("#warnAnimeContainer").removeClass("swal2-show").addClass("swal2-hide").fadeOut(250)
        LoadData(savedRecScheme)
    })
    $("#warnAnimeContainer, #cancelWarnAnime").on("click",()=>{
        $("#warnAnimeContainer").removeClass("swal2-show").addClass("swal2-hide").fadeOut(250)
    })
    $("#warnAnimeContainer .swal-modal-custom").on("click",(e)=>{
        e.stopImmediatePropagation()
    })
    $("#sign-up").on("click", async ()=>{
        Swal.fire({
            heightAuto: false,
            text: `Do you want to create an Anilist account?`,
            showConfirmButton: true,
            confirmButtonText: "Yes, Signup",
            showDenyButton: true,
            denyButtonText: "No",
            confirmButtonColor: '#000',
            denyButtonColor: '#e27d81',
            icon: "question",
            reverseButtons: true
        }).then(async(value)=>{
            if(value.isConfirmed){
                await window.open('https://anilist.co/signup', '_blank')
                const { value: username} = await Swal.fire({
                    heightAuto: false,
                    text: "Done signing-up your new account with Anilist? Update with your new username to load your own data.",
                    input: 'text',
                    inputLabel: 'Enter your Anilist Username:',
                    customClass: {
                        icon: 'no-border'
                    },
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: true,
                    confirmButtonText: "Update",
                    confirmButtonColor: '#000',
                    showDenyButton: true,
                    denyButtonColor: '#e27d81',
                    denyButtonText: "Cancel",
                    reverseButtons: true,
                    inputValidator: async(value) => {
                        return await new Promise(async(resolve) => {
                            if(!value) {
                                resolve("You need to write Something...")
                            } else {
                                $.ajax({
                                    type: 'POST',
                                    url: 'https://graphql.anilist.co',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Accept': 'application/json',
                                    },
                                    dataType: 'json',
                                    data: JSON.stringify({
                                        query: `{User(name:"${value}"){name}}`
                                    }),
                                    beforeSend: () => {
                                        $(".swal2-validation-message").addClass("no-before")
                                        .css({display:"flex"})
                                        .html(
                                            `<div id="UsernameValidation" style="display:flex; align-items:center; justify-content:center; ">
                                                <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                                <div>Checking Username...</div>
                                            </div>`
                                        )
                                    },
                                    success: (data) => {
                                        $("#UsernameValidation").fadeOut(250,()=>{
                                            $("#UsernameValidation").remove()
                                            $(".swal2-validation-message")
                                                .addClass("swal2-validation-message-custom-success")
                                                .html("Username Found")
                                            setTimeout(()=>{
                                                resolve()
                                            },500) 
                                        })
                                    },
                                    error: (err) =>{
                                        $("#UsernameValidation").fadeOut(250,()=>$(this).remove())
                                        resolve("Username not Found, Please Try Again")
                                    }
                                })
                            }
                        })
                    }
                })
                if(username){
                    await $("#username").val(username)
                    Update()
                }
            }
        })
    })
    $("#hideKidsAnimeBtn").on("click", async ()=>{
        kidsAnimeIsHidden = await retrieveJSON("kidsAnimeIsHidden")
        if(kidsAnimeIsHidden){
            kidsAnimeIsHidden = false
            saveJSON(kidsAnimeIsHidden,"kidsAnimeIsHidden")
            $("#hideKidsAnimeBtn").css({background:"black",color:"white"})
            savedRecScheme = await retrieveJSON("savedRecScheme")
            LoadData(savedRecScheme)
        } else {
            kidsAnimeIsHidden = true
            saveJSON(kidsAnimeIsHidden,"kidsAnimeIsHidden")
            $("#hideKidsAnimeBtn").css({background:"white",color:"black"})
            savedRecScheme = await retrieveJSON("savedRecScheme")
            LoadData(savedRecScheme)
        }
    })
    $("#animeRecommendationList").delegate('td.anime-score', 'click' , async function() {
        var warns = $(this).children("div").children("div").attr("title")
        if(warns!==undefined){
            await Swal.fire({
                heightAuto: false,
                text: `Content Warning, Anime has the following contents: \n${warns}`,
                icon: "info",
                confirmButtonColor: "#000",
                customClass: {
                    container: 'whitespace-pre-wrap'
                }
            })
        }
    })
    $(".anime-table-headers").on('click', ()=>{
        setTimeout(()=>{
            let setPageInfo = setInterval(()=>{
                if(typeof $('#anime-table')[0].config!=="undefined"){
                    saveJSON($('#anime-table')[0].config.sortList[0],"savedSort")
                    clearInterval(setPageInfo)
                    $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                }
            },1)
        },0)
    })
    $("body").on('scroll', function () {
        setTimeout(()=>{
            saveJSON($("body").scrollTop(),"savedYscroll")
        },1)
    })
    // Search Function
    async function Update(){
        updateStartTime = new Date
        var filterInput = $("#filters > ul > .flexdatalist-multiple-value > input")
        var username = $("#username").val()
        var filter = filterInput.val()
        // Check Input Validity
        if(username===""||username===null||typeof username==="undefined"){
            $("#username")[0].setCustomValidity("Anilist Username is Required!")
            $("#username")[0].reportValidity()
        }else if($("#filters .flexdatalist-multiple").children("li").length<2&&filterInput.val()!=""){
            filterInput[0].setCustomValidity("Select or Enter a word to Filter!")
            filterInput[0].reportValidity()
        } else {
            savedUsername = await retrieveJSON("savedUsername") || ""
            if(savedUsername.length===0){
                saveJSON(username,"savedUsername")
            }
            requestPause = await retrieveJSON("requestPause") || false
            savedLastRequestDate = await retrieveJSON("savedLastRequestDate") || new Date(Date.now()-60001)
            if(!requestPause
            ||(((new Date().getTime())-savedLastRequestDate.getTime())>60000)){
                // Search New Data
                requestPause = true
                saveJSON(requestPause,"requestPause")
                var filterInputs = $("#filters .flexdatalist-multiple > .value").children(".text")
                var filters = []
                for(let i=0; i<filterInputs.length; i++){
                    var filterName = filterInputs[i].textContent
                    filters.push(filterName)
                }
                saveJSON(filters, "savedFilters")
                analyzeVariables(username)
            } else {
                if(!requestIsRunning){
                    for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                    $("#dataStatusContainer").hide()
                    $("#dataStatusSpinner").show()
                    $("#dataStatusContainer").css("display","flex").fadeIn(2500)
                    requestIntervalSeconds = Math.round(60-(((new Date()).getTime()-savedLastRequestDate.getTime())/1000)) || 60
                    for(let i=requestIntervalSeconds; i>=0; i--){
                        let timeout = setTimeout(async()=>{
                            if(i===0){
                                requestPause = false
                                saveJSON(requestPause,"requestPause")
                                $("#dataStatusSpinner").hide()
                                $("#dataStatus")
                                    .empty()
                                    .append(`Update is now Available!`)
                                $("#dataStatusContainer").fadeOut(2500)
                                $("#dataStatus").empty()
                                if(await $("#username").val()!==savedUsername) await $("#username").val(savedUsername)
                                Update()
                            } else {
                                $("#dataStatus")
                                    .empty()
                                    .append(`Please wait for another Update... Estimated Time: ${msToTime(i*1000)}`)
                            }
                        },(requestIntervalSeconds-i)*1000)
                        temp.push(timeout)
                    }
                }
            }
        }
    }

    async function analyzeVariables(username) {
        // Allow One Instance
        if(requestIsRunning)return
        else requestIsRunning = true
        //
        var savedAnalyzeVariableTime = await retrieveJSON("savedAnalyzeVariableTime") || 20
        var AnalyzeVariableStartTime = new Date()
        // Check Parameters
        if(username.length>0) {
            // Initialize Anilist Graphql Data
            var query = `
            {
                MediaListCollection(userName: "${username}", type: ANIME) {
                    lists {
                        status
                        entries {
                            media {
                                id
                                title {
                                    userPreferred
                                }
                                averageScore
                                episodes
                                duration
                                trending
                                popularity
                                favourites
                                format
                                genres
                                tags {
                                    name
                                    rank
                                }
                                studios {
                                    nodes {
                                        name
                                        isAnimationStudio
                                    }
                                }
                                seasonYear
                                season
                                staff {
                                    edges {
                                        node {
                                            name {
                                                userPreferred
                                            }
                                        }
                                    }
                                }
                            }
                            score
                        }
                    }
                }
            }
            `;
            savedUserList = await retrieveJSON("savedUserList") || {}
            // Request API
            $.ajax({
                type: 'POST',
                url: 'https://graphql.anilist.co',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                dataType: 'json',
                data: JSON.stringify({
                    query: query
                }),
                beforeSend: async () => {
                    requestIsRunning = true
                    // Reset User List
                    if(isDeepUpdate){
                        savedUserList = {}
                        await saveJSON(savedUserList,"savedUserList")
                    }
                    savedAnalyzeVariableTime = await retrieveJSON("savedAnalyzeVariableTime") || 20
                    $("#dataStatusContainer").hide()
                    $("#dataStatusSpinner").show()
                    $("#dataStatusContainer").css("display","flex").fadeIn(2500)
                    for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                    for(let i=savedAnalyzeVariableTime; i>0; i--){
                        var timeout = setTimeout(()=>{
                            $("#dataStatus")
                                .empty()
                                .append(`Analyzing Variables... Estimated Time: ${msToTime(i*1000)}`)
                        },(savedAnalyzeVariableTime-i)*1000)
                        temp.push(timeout)
                    }
                },
                success: (userList)=> {
                    // Alert user if Scored List is 0
                    // to have a better recommendation
                    var animeList = userList.data.MediaListCollection.lists
                    var userListCount = []
                    if(animeList.length>1){
                        for(let i=0; i<animeList.length; i++){
                            userListCount = userListCount.concat(animeList[i].entries)
                        }
                    } else if(animeList.length===1) {
                        userListCount = animeList[0].entries
                    }
                    userListCount = userListCount.length
                    if(userListCount===0){
                        Swal.fire({
                            heightAuto: false,
                            title: "Let us know your Taste...",
                            text: `To make your recommendations better, score the anime you've watched on your Anilist account or import your MAL list to Anilist.`,
                            showConfirmButton: true,
                            confirmButtonText: "Go to Anilist",
                            showDenyButton: true,
                            denyButtonText: "Import my MAL",
                            showCancelButton: true,
                            cancelButtonText: "Later",
                            confirmButtonColor: '#000',
                            denyButtonColor: '#2E51A2',
                            cancelButtonColor: '#e27d81',
                            icon: "info",
                            reverseButtons: true
                        })
                        .then(async(value) => {
                            if(value.isConfirmed){
                                window.open('https://anilist.co/search/anime', '_blank');
                            } else if(value.isDenied) {
                                malanilistImportExport()
                            }
                        })
                    } else if(userListCount>0&&userListCount<30) {
                        Swal.fire({
                            heightAuto: false,
                            title: "Let us know your Taste...",
                            text: `You currently rated ${userListCount} Anime in your Anilist account, a minimum of 30 will suffice the analysis. To make your recommendations better, continue watching and rate the anime you've watched.`,
                            showConfirmButton: true,
                            confirmButtonText: "Sure, Later",
                            showDenyButton: true,
                            denyButtonText: "Go to Anilist",
                            confirmButtonColor: '#e27d81',
                            denyButtonColor: '#000',
                            icon: "info",
                            reverseButtons: true
                        })
                        .then(async(value) => {
                            if(value.isDenied){
                                window.open('https://anilist.co/search/anime', '_blank');
                            }
                        })
                    }
                    var worker = new Worker("./js-css/worker/analyzeVariable.js")
                    worker.postMessage({userList: userList, savedUserList: savedUserList})
                    worker.onmessage = (message) => {
                        worker.terminate()
                        const data = message.data
                        savedUserList = data.savedUserList
                        saveJSON(savedUserList,"savedUserList")
                        const varScheme = data.varScheme
                        const userListStatus = data.userListStatus
                        const alteredVariables = data.alteredVariables
                        var timeInterval = (new Date).getTime()-AnalyzeVariableStartTime.getTime()
                        saveJSON(Math.max(Math.ceil(timeInterval/1000),savedAnalyzeVariableTime), "savedAnalyzeVariableTime")
                        updateAllAnimeList(username, varScheme, userListStatus, alteredVariables)
                    }
                },
                error: function(xhr) {
                    try {
                        var err = xhr
                        if(isJsonString(xhr.responseText)){
                            err = JSON.parse(xhr.responseText).errors[0].message
                            console.error(JSON.parse(xhr.responseText))
                        }
                        $("#dataStatusContainer").fadeOut(2500)
                        $("#dataStatusSpinner").show()
                        $("#dataStatus").empty()
                        if(err==="User not found"){
                            Swal.fire({
                                heightAuto: false,
                                text: `Username '${username}' was not found in Anilist. Do you want to create another Anilist account?`,
                                showConfirmButton: true,
                                confirmButtonText: "Yes, Signup",
                                showDenyButton: true,
                                denyButtonText: "No, Change it Back",
                                confirmButtonColor: '#000',
                                denyButtonColor: '#e27d81',
                                icon: "question",
                                reverseButtons: true
                            }).then(async(value)=>{
                                if(value.isConfirmed){
                                    await window.open('https://anilist.co/signup', '_blank');
                                    const { value: xusername} = await Swal.fire({
                                        heightAuto: false,
                                        text: "Done signing-up your new account with Anilist? Update with your new username or Return to the old username.",
                                        input: 'text',
                                        inputLabel: 'Enter your Anilist Username:',
                                        inputValue: username,
                                        customClass: {
                                            icon: 'no-border'
                                        },
                                        allowOutsideClick: false,
                                        allowEscapeKey: false,
                                        showConfirmButton: true,
                                        confirmButtonText: "Update",
                                        confirmButtonColor: '#000',
                                        showDenyButton: true,
                                        denyButtonColor: '#e27d81',
                                        denyButtonText: "Change it Back",
                                        reverseButtons: true,
                                        inputValidator: async(value) => {
                                            return await new Promise(async(resolve) => {
                                                if(!value) {
                                                    resolve("You need to write Something...")
                                                } else {
                                                    $.ajax({
                                                        type: 'POST',
                                                        url: 'https://graphql.anilist.co',
                                                        headers: {
                                                            'Content-Type': 'application/json',
                                                            'Accept': 'application/json',
                                                        },
                                                        dataType: 'json',
                                                        data: JSON.stringify({
                                                            query: `{User(name:"${value}"){name}}`
                                                        }),
                                                        beforeSend: () => {
                                                            $(".swal2-validation-message").addClass("no-before")
                                                            .css({display:"flex"})
                                                            .html(
                                                                `<div id="UsernameValidation" style="display:flex; align-items:center; justify-content:center; ">
                                                                    <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                                                    <div>Checking Username...</div>
                                                                </div>`
                                                            )
                                                        },
                                                        success: (data) => {
                                                            $("#UsernameValidation").fadeOut(250,()=>{
                                                                $("#UsernameValidation").remove()
                                                                $(".swal2-validation-message")
                                                                    .addClass("swal2-validation-message-custom-success")
                                                                    .html("Username Found")
                                                                setTimeout(()=>{
                                                                    resolve()
                                                                },500) 
                                                            })
                                                        },
                                                        error: (err) =>{
                                                            $("#UsernameValidation").fadeOut(250,()=>$(this).remove())
                                                            resolve("Username not Found, Please Try Again")
                                                        }
                                                    })
                                                }
                                            })
                                        }
                                    })
                                    if(xusername){
                                        await $("#username").val(xusername)
                                        Update()
                                    } else {
                                        savedUsername = await retrieveJSON("savedUsername")
                                        $("#username").val(savedUsername)
                                    }
                                } else {
                                    savedUsername = await retrieveJSON("savedUsername")
                                    $("#username").val(savedUsername)
                                }
                            })
                        } else {
                            console.error("Error 100")
                            Swal.fire({
                                heightAuto: false,
                                text: `Error 100: Oops...Something went wrong! ${typeof err==="string"?err:"Please try again..."}`,
                                icon: "error",
                                confirmButtonColor: "#000"
                            });
                            (async()=>{
                                savedRecScheme = await retrieveJSON("savedRecScheme") || {}
                                await LoadData(savedRecScheme)
                            })()
                            // Browser
                            showNotification(`Oops...Something went wrong! ${typeof err==="string"?err:"Please try again..."}`)
                            // Browser
                        }
                    } catch(ex) {
                        console.error(ex)
                        $("#dataStatusContainer").fadeOut(2500)
                        $("#dataStatusSpinner").show()
                        $("#dataStatus").empty()
                        console.error("Error 101")
                        Swal.fire({
                            heightAuto: false,
                            text: `Error 101: Oops...Something went wrong! ${typeof err==="string"?err:"Please try again..."}`,
                            icon: "error",
                            confirmButtonColor: "#000"
                        });
                        (async()=>{
                            savedRecScheme = await retrieveJSON("savedRecScheme") || {}
                            await LoadData(savedRecScheme)
                        })()
                        // Browser
                        showNotification(`Oops...Something went wrong! ${typeof err==="string"?err:"Please try again..."}`)
                        // Browser
                    }
                    console.log("WebtoApp: Update Error")
                    if(Object.keys(savedRecScheme).length===0){
                        $("#animeRecommendationList").empty()
                        $("#animeRecommendationList").append(`
                            <tr class="item" role="row">
                                <td style="padding: 1.5em !important;" colspan="14">
                                    <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                    No Data
                                </td>
                            </tr>
                        `)
                    }
                    for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                    requestIsRunning = false
                }
            })
        }
    }

    async function updateAllAnimeList(username, varImportance, userListStatus, alteredVariables){
        var savedLatestAnimeID = await retrieveJSON("savedLatestAnimeID") || ""
        var lastAnilistPage = await retrieveJSON("lastAnilistPage") || 284
        $.ajax({
            type: 'POST',
            url: 'https://graphql.anilist.co',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
            dataType: 'json',
            data: JSON.stringify({
                query: `
                {
                    Media(type: ANIME, startDate_greater:20000000, sort:[START_DATE_DESC], status:RELEASING) {
                        id
                    }
                }
                `
            }),
            beforeSend: ()=>{
                // Reset Anime-List
                if(isDeepUpdate){
                    savedLatestAnimeID = ""
                    saveJSON(savedLatestAnimeID,"savedLatestAnimeID")
                }
                for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                $("#dataStatus")
                    .empty()
                    .append(`Checking for Anilist Updates...`)
            },
            success: (xresult)=>{
                var latestAnimeID = xresult.data.Media.id
                if(latestAnimeID!==savedLatestAnimeID){
                    var maxAnimePerPage = 50
                    var maxRequest = 90
                    var startDate = new Date(Date.now() + 1000) // Allowance of 1sec
                    var animeEntries = []
                    var sum = 0
                    async function recall(page){
                        $.ajax({
                            type: 'POST',
                            url: 'https://graphql.anilist.co',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            dataType: 'json',
                            data: JSON.stringify({
                                query: `
                                {
                                    Page(page: ${page}, perPage: ${maxAnimePerPage}) {
                                        media(
                                            type: ANIME,
                                            genre_not_in: ["Hentai"],
                                            status_in:[FINISHED, RELEASING],
                                            format_in:[TV,TV_SHORT,MOVIE,OVA,ONA,SPECIAL]) {
                                            id
                                            title {
                                                userPreferred
                                            }
                                            siteUrl
                                            averageScore
                                            episodes
                                            duration
                                            trending
                                            popularity
                                            favourites
                                            format
                                            genres
                                            status
                                            tags {
                                                name
                                                rank
                                            }
                                            studios {
                                                nodes {
                                                    name
                                                    siteUrl
                                                    isAnimationStudio
                                                }
                                            }
                                            seasonYear
                                            season
                                            staff {
                                                edges {
                                                    node {
                                                        name {
                                                            userPreferred
                                                        }
                                                        siteUrl
                                                    }
                                                    role
                                                }
                                            }
                                        }
                                    }
                                }
                                `
                            }),
                            beforeSend: ()=> {
                                for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                                $("#dataStatus")
                                    .empty()
                                    .append(`Updating Anime from Anilist... Page ${page} of ${lastAnilistPage>=page?lastAnilistPage:page}`)
                                startDate = new Date(Date.now() + 1000) // Allowance of 1sec
                                saveJSON(new Date(),"savedLastRequestDate")
                            },
                            success: (result)=>{
                                var timeInterval = 60000 //Minute in ms
                                var tempAnimeEntries = result.data.Page.media
                                if(tempAnimeEntries.length>0){
                                    animeEntries = animeEntries.concat(tempAnimeEntries)
                                    return recall(++page)
                                } else {
                                    saveJSON(latestAnimeID,"savedLatestAnimeID")
                                    saveJSON(animeEntries,"savedAnimeEntries")
                                    saveJSON(page, "lastAnilistPage")
                                    analyzeAnime(animeEntries, varImportance, userListStatus, alteredVariables, username)
                                }
                            },
                            error: function(xhr) {
                                try {
                                    var timeInterval = 60000 //Minute in ms
                                    var err = xhr
                                    if(isJsonString(xhr.responseText)){
                                        err = JSON.parse(xhr.responseText).errors[0].message
                                        console.error(JSON.parse(xhr.responseText))
                                    }
                                    for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                                    for(let i=60; i>0; i--){
                                        var timeout = setTimeout(()=>{
                                            $("#dataStatus")
                                                    .empty()
                                                    .append(`Limit Request, Continuing in ${msToTime(i*1000)}...  Page ${page} of ${lastAnilistPage>=page?lastAnilistPage:page}`)
                                        },(60-i)*1000)
                                        temp.push(timeout)
                                    }
                                    setTimeout(()=>{
                                        return recall(page)
                                    },60000)
                                } catch(ex) {
                                    console.error(ex)
                                    console.error("Error 103")
                                    Swal.fire({
                                        heightAuto: false,
                                        text: `Error 103: Oops...Something went wrong! ${typeof err==="string"?err:"Please try again..."}`,
                                        icon: "error",
                                        confirmButtonColor: "#000"
                                    });
                                    (async()=>{
                                        savedRecScheme = await retrieveJSON("savedRecScheme") || {}
                                        await LoadData(savedRecScheme)
                                    })()
                                    // Browser
                                    showNotification(`Oops...Something went wrong! ${typeof err==="string"?err:"Please try again..."}`)
                                    // Browser
                                    $("#dataStatusContainer").fadeOut(2500)
                                    $("#dataStatusSpinner").show()
                                    $("#dataStatus").empty()
                                    console.log("WebtoApp: Update Error")
                                    if(Object.keys(savedRecScheme).length===0){
                                        $("#animeRecommendationList").empty()
                                        $("#animeRecommendationList").append(`
                                            <tr class="item" role="row">
                                                <td style="padding: 1.5em !important;" colspan="14">
                                                    <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                                    No Data
                                                </td>
                                            </tr>
                                        `)
                                    }
                                    for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                                    requestIsRunning = false
                                }
                            }
                        })
                    }
                    recall(1) // First Page
                } else {
                    analyzeAnime([], varImportance, userListStatus, alteredVariables, username)
                }
            },
            error: function(xhr) {
                try {
                    var err = xhr
                    if(isJsonString(xhr.responseText)){
                        err = JSON.parse(xhr.responseText).errors[0].message
                        console.error(JSON.parse(xhr.responseText))
                    } else {
                        console.error("Error 104");
                        Swal.fire({
                            heightAuto: false,
                            text: `Error 104: Oops...Something went wrong! ${typeof err==="string"?err:"Please try again..."}`,
                            icon: "error",
                            confirmButtonColor: "#000"
                        });
                        (async()=>{
                            savedRecScheme = await retrieveJSON("savedRecScheme") || {}
                            await LoadData(savedRecScheme)
                        })()
                        // Browser
                        showNotification(`Oops...Something went wrong! ${typeof err==="string"?err:"Please try again..."}`)
                        // Browser
                        console.log("WebtoApp: Update Error")
                    }
                } catch(ex) {
                    console.error(ex)
                    console.error("Error 105")
                    Swal.fire({
                        heightAuto: false,
                        text: `Error 105: Oops...Something went wrong! ${typeof err==="string"?err:"Please try again..."}`,
                        icon: "error",
                        confirmButtonColor: "#000"
                    });
                    (async()=>{
                        savedRecScheme = await retrieveJSON("savedRecScheme") || {}
                        await LoadData(savedRecScheme)
                    })()
                    // Browser
                    showNotification(`Oops...Something went wrong! ${typeof err==="string"?err:"Please try again..."}`)
                    // Browser
                    console.log("WebtoApp: Update Error")
                }
                $("#dataStatusContainer").fadeOut(2500)
                $("#dataStatusSpinner").show()
                $("#dataStatus").empty()
                if(Object.keys(savedRecScheme).length===0){
                    $("#animeRecommendationList").empty()
                    $("#animeRecommendationList").append(`
                        <tr class="item" role="row">
                            <td style="padding: 1.5em !important;" colspan="14">
                                <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                No Data
                            </td>
                        </tr>
                    `)
                }
                for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                requestIsRunning = false
            }
        })
    }

    async function analyzeAnime(animeEntries, varImportance, userListStatus, alteredVariables, username){
        var UpdateAnalyzeAnimeStartTime = new Date()
        var savedUpdateAnalyzeAnimeTime = await retrieveJSON("savedUpdateAnalyzeAnimeTime") || 3
        for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
        for(let i=savedUpdateAnalyzeAnimeTime; i>0; i--){
            var timeout = setTimeout(()=>{
                $("#dataStatus")
                    .empty()
                    .append(`Updating Recommendations List... Estimated Time: ${msToTime(i*1000)}`)
            },(savedUpdateAnalyzeAnimeTime-i)*1000)
            temp.push(timeout)
        }
        if(animeEntries.length===0) {
            animeEntries = await retrieveJSON("savedAnimeEntries") || []
        }
        // Username Changed
        var savedUsername = await retrieveJSON("savedUsername") || ""
        if(username!==savedUsername) {
            savedRecScheme = {}
        // Reset All Anime Recommendations
        } else if(isDeepUpdate) {
            savedRecScheme = {}
            saveJSON(savedRecScheme,"savedRecScheme")   
        } else {
            savedRecScheme = await retrieveJSON("savedRecScheme") || {}
        }
        var savedAnalyzedVariablesCount = await retrieveJSON("savedAnalyzedVariablesCount") || {}
        var worker = new Worker("./js-css/worker/analyzeAnime.js")
        worker.postMessage({
            animeEntries: animeEntries,
            savedRecScheme: savedRecScheme,
            userListStatus: userListStatus,
            varImportance: varImportance,
            allFilterInfo: allFilterInfo,
            alteredVariables: alteredVariables,
            savedAnalyzedVariablesCount: savedAnalyzedVariablesCount
        })
        worker.onmessage = (message) => {
            worker.terminate()
            const data = message.data
            savedRecScheme = data.savedRecScheme
            allFilterInfo = data.allFilterInfo
            savedAnalyzedVariablesCount = data.savedAnalyzedVariablesCount
            saveJSON(allFilterInfo,"allFilterInfo")
            // Saved New Username
            saveJSON(username,"savedUsername")
            // Save new AnimeList json Data
            saveJSON(savedRecScheme, "savedRecScheme")
            // Save and Reload Weight Count
            saveJSON(savedAnalyzedVariablesCount,"savedAnalyzedVariablesCount")
            if(Object.keys(savedRecScheme).length>1){
                $("#updateBtn").show()
                $("#updateIntervalBtn").show()
            }
            var worker2 = new Worker("./js-css/worker/updateOptions.js")
            worker2.postMessage({
                allFilterInfo: allFilterInfo
            })
            worker2.onmessage = (message) => {
                const data = message.data
                // Save Current Filters
                saveJSON(requestPause,"requestPause")
                var filterInputs = $("#filters .flexdatalist-multiple > .value").children(".text")
                var filters = []
                for(let i=0; i<filterInputs.length; i++){
                    var filterName = filterInputs[i].textContent
                    filters.push(filterName)
                }
                saveJSON(filters, "savedFilters")
                // Save and Reload Filters
                savedFilterOptionsJson = data.savedFilterOptionsJson
                saveJSON(savedFilterOptionsJson,"savedFilterOptionsJson")
                // Reload new Data
                LoadData(savedRecScheme)
                $('.flexdatalist').flexdatalist({
                    data: savedFilterOptionsJson
                })
                let reloadSavedData = setInterval(async () => {
                    if($("#filters .flexdatalist-multiple-value > .flexdatalist-alias").length){
                        clearInterval(reloadSavedData)
                        // Reload Filters
                        var filterInput
                        savedFilters = await retrieveJSON("savedFilters") || []
                        for(let i=0; i<savedFilters.length; i++) {
                            filterInput = $("#filters .flexdatalist-multiple-value > .flexdatalist-alias")
                            await filterInput.val(savedFilters[i])
                            var e = await $.Event("keyup",{keyCode:13})
                            await filterInput.trigger(e)
                            await filterInput.val("")
                        }
                    }
                },1)
                let reloadSavedData2 = setInterval(async () => {
                    if($("#warnAnimeModal .flexdatalist-multiple-value > .flexdatalist-alias").length){
                        clearInterval(reloadSavedData2)
                        $("#warnAnimeContainer").css({visibility:"hidden"}).show()
                        savedWarnAnime = await retrieveJSON("savedWarnAnime") || [ "ecchi","mahou shoujo","!boys' love","cgi","!ero guro","!female harem",
                                                                             "full cgi","kids","love triangle","!male harem","!mixed gender harem",
                                                                             "!nudity","!slavery","!suicide","tokusatsu","!yuri","wuxia","!netorare",
                                                                             "!rape"
                                                                           ]
                        
                        var warnAnimeInput
                        for(let i=0; i<savedWarnAnime.length; i++) {
                            warnAnimeInput = await $("#warnAnimeModal .flexdatalist-multiple-value > .flexdatalist-alias")
                            await warnAnimeInput.val(savedWarnAnime[i])
                            var e = await $.Event("keyup",{keyCode:13})
                            await warnAnimeInput.trigger(e)
                            await warnAnimeInput.val("")
                        }
                        await $("#warnAnimeContainer").css({visibility:"visible"}).hide()
                    }
                },1)
                var timeInterval = (new Date).getTime()-UpdateAnalyzeAnimeStartTime.getTime()
                saveJSON(Math.max(Math.ceil(timeInterval/1000),savedUpdateAnalyzeAnimeTime), "savedUpdateAnalyzeAnimeTime")
                if(isDeepUpdate){
                    isDeepUpdate = false
                    var timeInterval = (new Date).getTime()-deepUpdateStartTime.getTime()
                    saveJSON(Math.max(Math.ceil(timeInterval/1000),savedDeepUpdateTime),"savedDeepUpdateTime")
                }
                console.log("WebtoApp: List is Updated")
                $("#dataStatusContainer").fadeOut(2500)
                $("#dataStatus").empty()
                $("#dataStatusContainer").hide()
                if(!swal.isVisible()){
                    Swal.fire({
                        heightAuto: false,
                        text: "List has been updated!",
                        icon: "success",
                        confirmButtonColor: "#000"
                    })
                }
                // Browser
                showNotification("List has been updated!")
                // Browser
                requestIsRunning = false
                worker2.terminate()
            }
        }
    }

    async function LoadData(savedRecScheme){
        if(!isLoading) isLoading = true
        return new Promise(async (resolve) => {
            var recList = Object.values(savedRecScheme)
            if((recList.length>0)) {
                var filterInputs = $("#filters .flexdatalist-multiple > .value").children(".text")
                var filters = []
                var includes = []
                var excludes = kidsAnimeIsHidden? ["kids"] : []
                for(let i=0; i<filterInputs.length; i++){
                    var filterName = filterInputs[i].textContent
                    filters.push(filterName)
                    if(filterName.charAt(0)==="!") excludes.push(filterName.slice(1))
                    else includes.push(filterName)
                }
                $("#hiddenUnhiddenBtn").text("Unhidden")
                for(let i=0; i<includes.length; i++){
                    if(equalsNCS(includes[i],"hidden")){
                        $("#hiddenUnhiddenBtn").text("Hidden")
                        break;
                    }
                }
                saveJSON(filters, "savedFilters")
                savedWarnAnime = await retrieveJSON("savedWarnAnime") || [ "ecchi","mahou shoujo","!boys' love","cgi","!ero guro","!female harem",
                                                                           "full cgi","kids","love triangle","!male harem","!mixed gender harem",
                                                                           "!nudity","!slavery","!suicide","tokusatsu","!yuri","wuxia","!netorare",
                                                                           "!rape"
                                                                        ]
                var savedWarnR = {}
                var savedWarnY = {}
                for(let i=0; i<savedWarnAnime.length; i++){
                    var warnName = savedWarnAnime[i].toLowerCase()
                    if(warnName.charAt(0)==="!") savedWarnR[warnName.slice(1)] = null
                    else savedWarnY[warnName] = null
                }
                savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles") || []
                var worker = new Worker("./js-css/worker/loadData.js")
                worker.postMessage({
                    recList: recList,
                    savedHiddenAnimeTitles: savedHiddenAnimeTitles,
                    includes: includes,
                    excludes: excludes,
                    savedWarnR: savedWarnR,
                    savedWarnY: savedWarnY
                })
                worker.onmessage = async (message) => {
                    worker.terminate()
                    const data = message.data
                    const animeData = data.animeData
                    await new Promise(async(resolve) => {
                        savedUnhiddenTablePage = await retrieveJSON("savedUnhiddenTablePage") || 0
                        savedHiddenTablePage = await retrieveJSON("savedHiddenTablePage") || 0
                        savedTableStatus = await retrieveJSON("savedTableStatus") || "Unhidden"
                        resolve()
                    }).then(async()=>{
                        await $("#animeRecommendationList").empty()
                        await $("#animeRecommendationList").css({
                            "display":"none",
                            "visibility":"hidden",
                            "content-visibility":"hidden"
                        }).append(animeData)
                        await $("#anime-table").trigger("update")
                        await $("#anime-table").trigger("pagerUpdate")
                        await $("#animeRecommendationList").css({"content-visibility":"auto"})
                        await $("#animeRecommendationList").css({
                            "display":"",
                            "visibility":"",
                            "content-visibility":"auto"
                        })
                        // idk why savedUnhiddenTable Page sets to (page - 1) in SecondTolast and Last
                        await $("#anime-table").trigger("pageSet",(savedTableStatus==="Unhidden"? savedUnhiddenTablePage:savedHiddenTablePage))
                        setTimeout(()=>{
                            let setPageInfo = setInterval(()=>{
                                if(typeof $('#anime-table')[0].config!=="undefined"){
                                    clearInterval(setPageInfo)
                                    $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                }
                            },1)
                        },0)
                        isLoading = false
                        resolve()
                    })
                }
            }
        })
    }

    async function initUsernameData(){
        const { value: username} = await Swal.fire({
            heightAuto: false,
            title: "Starting Up",
            input: 'text',
            inputLabel: 'Enter your Anilist Username:',
            iconHtml: '<img src="./public/logo.png">',
            customClass: {
                icon: 'no-border'
            },
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: true,
            confirmButtonText: "Search",
            confirmButtonColor: '#000',
            denyButtonColor: '#e27d81',
            reverseButtons: true,
            footer: `
                <a target="_blank" rel="noopener noreferrer" href="https://anilist.co/signup">I don't have an anilist account</a>
                <a href="javascript:$('#importBtn').click()">Import Backup</a>
            `,
            inputValidator: async(value) => {
                return await new Promise(async(resolve) => {
                    if(!value) {
                        resolve("You need to write Something...")
                    } else {
                        $.ajax({
                            type: 'POST',
                            url: 'https://graphql.anilist.co',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                            },
                            dataType: 'json',
                            data: JSON.stringify({
                                query: `{User(name:"${value}"){name}}`
                            }),
                            beforeSend: () => {
                                $(".swal2-validation-message").addClass("no-before")
                                .css({display:"flex"})
                                .html(
                                    `<div id="UsernameValidation" style="display:flex; align-items:center; justify-content:center; ">
                                        <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                        <div>Checking Username...</div>
                                    </div>`
                                )
                            },
                            success: (data) => {
                                $("#UsernameValidation").fadeOut(250,()=>{
                                    $("#UsernameValidation").remove()
                                    $(".swal2-validation-message")
                                        .addClass("swal2-validation-message-custom-success")
                                        .html("Username Found")
                                    setTimeout(()=>{
                                        resolve()
                                    },500) 
                                })
                            },
                            error: (err) =>{
                                $("#UsernameValidation").fadeOut(250,()=>$(this).remove())
                                resolve("Username not Found, Please Try Again")
                            }
                        })
                    }
                })
            }
        })
        if(username){
            await $("#username").val(username)
            Update()
        }
    }

    function malanilistImportExport(){
        Swal.fire({
            heightAuto: false,
            title: "Import MAL to Anilist",
            text: `In order to import your MAL list to Anilist, you need to export your list from MAL (xml) and import the exported MAL file to your Anilist account.`,
            showConfirmButton: true,
            confirmButtonText: "Export MAL",
            confirmButtonColor: '#2E51A2',
            showDenyButton: true,
            denyButtonText: "Import to Anilist",
            denyButtonColor: "#000",
            showCancelButton: true,
            cancelButtonText: "Cancel",
            cancelButtonColor: "#e27d81",
            allowOutsideClick: false,
            allowEscapeKey: false,
            reverseButtons: true,
            footer: `<a target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/watch?v=eWooqnJ87-0">Watch this video, for tutorial</a>
                        <a target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/watch?v=rfHTiT_7a4U">Auto sync MAL and Anilist</a>`
        }).then(async(value) => {
            if(value.isConfirmed){
                await window.open('https://myanimelist.net/panel.php?go=export', '_blank');
                malanilistImportExport()
            } else if(value.isDenied) {
                await window.open('https://anilist.co/settings/import', '_blank');
                malanilistImportExport()
            }
        })
    }
    //////////////////////////////////////////////////////////////////
    // Extra
    function saveJSON(data, name) {
        try {
            var write = db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").openCursor()
            write.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    if(cursor.key===name){
                        cursor.update(data)
                    }
                    cursor.continue()
                } else {
                    db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").add(data, name)
                }
            }
        } catch(ex) {
            try{
                console.error(ex)
                db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").add(data, name)
            } catch(ex2){
                console.error(ex2)
                return localStorage.setItem(name, JSON.stringify(data))
            }
        }
    }
    async function retrieveJSON(name) {
        return new Promise((resolve)=>{
            try {
                var read = db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").get(name)
                read.onsuccess = (event) => {
                    resolve(read.result)
                }
                read.onerror = (event) => {
                    resolve(JSON.parse(localStorage.getItem(name)))
                }
            } catch(ex){
                console.error(ex)
                resolve(JSON.parse(localStorage.getItem(name)))
            }
        })
    }
    function equalsNCS(str1, str2) {
        var s1 = str1
        var s2 = str2
        if(typeof s1==="number") s1 = s1.toString()
        if(typeof s2==="number") s2 = s2.toString()
        if(typeof s1==="string") s1 = s1.trim().toLowerCase()
        if(typeof s2==="string") s2 = s2.trim().toLowerCase()
        return s1 === s2
    }
    function jsonIsEmpty(obj){
        for(var i in obj) return false
        return true
    }
    function arraySum(obj) {
        return obj.reduce((a, b) => a + b, 0)
    }
    function arrayMean(obj) {
        return (arraySum(obj) / obj.length) || 0
    }
    function msToTime(duration) {
        var seconds = Math.floor((duration / 1000) % 60),
            minutes = Math.floor((duration / (1000*60)) % 60),
            hours = Math.floor((duration / (1000*60*60)) % 24),
            days = Math.floor((duration / (1000*60*60*24)) % 7),
            weeks = Math.floor((duration / (1000*60*60*24*7)) % 4),
            months = Math.floor((duration / (1000*60*60*24*7*4)) % 12)
            years = Math.floor((duration / (1000*60*60*24*7*4*12)) % 10)
            decades = Math.floor((duration / (1000*60*60*24*7*4*12*10)) % 10)
            century = Math.floor((duration / (1000*60*60*24*7*4*12*10*10)) % 10)
            millenium = Math.floor((duration / (1000*60*60*24*7*4*12*10*10*10)) % 10)
        var time = []
        if(millenium<=0&&century<=0&&decades<=0&&years<=0&&months<=0&&weeks<=0&&days<=0&&hours<=0&&minutes<=0&&seconds<=0) return "0s"
        if(millenium>0) time.push(millenium===1?`${millenium}mil`:`${millenium}mils`)
        if(decades>0) time.push(decades===1?`${decades}de`:`${decades}des`)
        if(years>0) time.push(`${years}y`)
        if(months>0) time.push(months===1?`${months}mo`:`${months}mos`)
        if(weeks>0) time.push(`${weeks}w`)
        if(days>0) time.push(`${days}d`)
        if(hours>0) time.push(`${hours}h`)
        if(minutes>0) time.push(`${minutes}m`)
        if(seconds>0) time.push(`${seconds}s`)
        return time.join(" ")
    }
    // Browser
    async function downloadObjectAsJson(objStr, fileName) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([objStr], { type:`text/json` }));
        a.download = fileName;
        a.click();
    }
    // Browser
    function isJsonString(str) {
        try {JSON.parse(str);}
        catch (e) {return false;}
        return true;
    }
    async function parseJsonFile(file) {
        return new Promise((resolve, reject) => {
            const fileReader = new FileReader()
            fileReader.onload = event => resolve(JSON.parse(event.target.result))
            fileReader.onerror = error => reject(error)
            fileReader.readAsText(file)
        })
    }
    // Browser
    // Notification
    function showNotification(text) {
        if(document.hasFocus()) return
        const notification = new Notification('Kanshi. Recommendation Update', {
            body: text,
            icon: './public/logo.png'
        })
        setTimeout(() => {
            notification.close();
        }, 10 * 1000)
        // navigate to a URL when clicked
        notification.addEventListener('click', () => {
            window.parent.parent.focus()
        })
    }
    (async ()=>{
        if (Notification.permission === 'granted') {
            notificationGranted = true
        } else if (Notification.permission !== 'denied') {
            let permission = await Notification.requestPermission()
            notificationGranted = permission === 'granted' ? true : false
        }
    })()
    //Browser
    </script>
</body>
</html>
