<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Kanshi. - Anime Recommendation</title>
        <link rel="shortcut icon" type="image/x-icon" href="./public/logo.png" />
        <!-- Jquery -->
        <script src="./js-css/jquery-1.8.3.min.js"></script>
        <!-- Alternative JS Alert -->
        <script src="./js-css/sweetalert.min.js"></script>
        <!-- Table Sort -->
        <link rel="stylesheet" href="./js-css/jquery tablesorter/theme.default.min.css">
        <script type="text/javascript" src="./js-css/jquery tablesorter/jquery.tablesorter.js"></script>
        <script type="text/javascript" src="./js-css/jquery tablesorter/jquery.metadata.min.js"></script>
        <script type="text/javascript" src="./js-css/jquery tablesorter/jquery.tablesorter.pager.min.js"></script>
        <!-- Datalist Search Code -->
        <link rel="stylesheet" href="./js-css/flexdatalist/jquery.flexdatalist.css">
        <script src="./js-css/flexdatalist/jquery.flexdatalist.js"></script>
        <!-- Bootstrap -->
        <link rel="stylesheet" href="./js-css/bootstrap-3.3.6.min.css"/>
        <!-- Fontawesome -->
        <link rel="stylesheet" href="./js-css/font-awesome.min.css">
        <script src="./js-css/fontawesome-5.0.js" crossorigin="anonymous"></script>
        <style>
            /* Re-edit */
                /* Change For Text Size */
            :root{
                font-size: 0.9rem !important;
            }
            /* Change/Add to Class/Tag of desired division for Padding */
            .Home,
            .overlay{
                padding-inline: clamp(0px, 5vw, 75px) !important;
            }
            /* Default */
            html,
            body {
                height: 100%;
                width: 100%;
                overflow: auto;
            }
            :root{
                font-size: 0.9rem;
                background-color: #fff;
                font-family: sans-serif;
                z-index: 0;
                min-width: 100%;
                min-height: 100%;
                overflow:auto; 
            }
            :root>*{
                background-color: #fff;
                min-width: inherit;
                min-height: inherit;
            }
            *,
            ::after,
            ::before{
                margin: 0;
                padding: 0;
                text-indent: 0;
                box-sizing: border-box;
            }
            /* Text */
            .textLogo{
                font-size: clamp(1.6rem, 2vw,1.6rem) !important;
            }
            h1{
                font-size: clamp(1.3rem, 2vw,1.3rem);
            }
            h2{
                font-size: clamp(1.05rem, 2vw,1.05rem);
            }
            h3{
                font-size: clamp(1.05rem, 2vw,1.05rem);
            }
            p,
            label,
            input[type="text"]{
                font-size: clamp(0.95rem, 2vw,0.95rem);
            }
            h4{
                font-size: clamp(1rem, 2vw,1rem);
            }
            h5{
                font-size: clamp(0.9rem, 2vw,0.9rem);
            }
            h6{
                font-size: clamp(0.8rem, 2vw,0.8rem);
            }
            h1,
            h2,
            h3,
            h4,
            h5,
            h6,
            p,
            input,
            textarea,
            .textLogo{
                cursor:default;
                hyphens:manual;
                white-space:pre-wrap;
                word-break:break-word;
                overflow-wrap:break-word;
                transform-origin: left;
            }
            h1,
            h2,
            h3,
            h4,
            h5,
            h6,
            p,
            .textLogo{
                max-width: fit-content;
                min-width: fit-content;
            }
            /* Forms */
            input,
            textarea{
                outline: 0;
            }
            input[type=text]{
                width: 0;
            }
            button,
            button>*{
                cursor: pointer;
            }
            dialog{
                border: 0;
            }
            img{
                max-width: 100%;
            }
            /* Additional */
            button {
                background-color: black !important;
                color: white !important;
            }
            input {
                padding: 0.5em;
            }
            .userInput {
                width: min-content;
                border-color: rgb(118, 118, 118);
                border-width: 2px;
                border-style: inset;
                border-radius: 0px;
                background-color: rgb(255, 255, 255);
            }
            .loader {
                position: fixed;
                left: 0px;
                top: 0px;
                width: 100%;
                height: 100%;
                z-index: 9999;
                background: url('./public/loading.gif') 
                    50% 50% no-repeat 
                    rgb(0, 0, 0)
            }
            .loader > * {
                justify-content: center;
                min-height: 100%;
                align-items: center;
                display: flex;
                margin-top: 150px;
                color: wheat;
                text-align: center;
            }
            html,body,.home{
                width: 100%;
                min-height: 100%;
                height: 100%;
            }
            label{margin: 0}
            .searchData,.table-responsive{
                margin-block: 15px;
            }
            .flexdatalist-multiple > .value {
                max-width: fit-content;
                cursor: pointer;
            }
            .userInputContainer,.filter-container,.btn-container{
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                margin-block: 15px;
                gap: 0.5em;
            }
            .userInputContainer>:not(label),.filter-container>:not(label),.btn-container>:not(label){
                flex-grow: 1;
            }
            .flexdatalist-multiple{
                display: flex;
                flex-wrap: wrap-reverse;
                max-height: 120px;
                overflow-y: scroll;
            }
            .flexdatalist-multiple>.flexdatalist-multiple-value{
                flex-grow: 1;
                display: flex !important; 
            }
            .flexdatalist-multiple>.flexdatalist-multiple-value>.flexdatalist-alias{
                outline: none;
                flex-grow: 1;
            }
            .tableLoadingContainer{
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .show-hidden-anime-btn{
                text-align: center !important;
                min-width: 85px !important;
            }
            header {
                background: url('./public/header.png');
                text-align: left;
                width: 100%;
                height: 165px;
                background-size: contain;
                position: relative;
                overflow: hidden;
                border-radius: 0 0 50% 50% / 5%;
            }
            header .overlay{
                width: 100%;
                height: 100%;
                padding: 1.75em;
                color: #FFF;
                background-image: linear-gradient( 135deg, #39343c69 10%, #6d00006b 100%);
            }
            header .overlay>*{
                padding-right: 50%;
            }
            button {
                border: none;
                outline: none;
                padding: 10px 20px;
                border-radius: 50px;
                color: #333;
                background: #fff;
                margin-bottom: 50px;
                box-shadow: 0 3px 20px 0 #0000003b;
            }
            button:hover{
                cursor: pointer;
            }
            a {
                color: #B06D70;
            }
            #showAllAnime{
                display: none;
            }
            #hiddenUnhiddenBtn{
                background: black !important;
                color: white !important;
                max-width: fit-content !important;
            }
            .anime-table-headers > th{
                vertical-align: middle !important;
                padding: 1em !important;
            }
            .tablesorter-header-inner{
                margin-right: 0.5em !important;
                min-width: max-content !important;
            }
            .show-all-anime{
                background: black !important;
                color: white !important;
                border-radius: 5%;
                max-width: fit-content !important;
            }
            .tablesorter-default{
                margin: 0 !important;
            }
            .hide-anime-column{
                padding-block: 1.5em !important;
                vertical-align: middle !important;
                text-align: center !important;
                user-select: none !important;
            }
            .item > td {
                vertical-align: middle !important;
            }
            .swal-text:first-child{
                display: block !important;
                margin-top: 20px !important;
                margin-left: 15px !important;
            }
            .swal-text{
                font-size: 1.15rem !important;
                text-align: center;
            }
            .swal-footer{
                display: flex;
                justify-content: space-evenly;
                align-items: center;
                text-align: center;
            }
            .anime-score{
                text-align: center;
            }
            .overlay,
            .searchData,
            .flexdatalist-results{
                user-select: none;
            }
            .spinner {
                border: 2px solid #f3f3f3;
                border-top: 2px solid #B06D70;
                border-radius: 50%;
                width: 13px;
                height: 13px;
                animation: spin 2s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .data-status-container{
                display: none;
                align-items: center;
                justify-content: center;
            }
            .table-responsive{
                margin-bottom: 77px;
            }
            .pager{
                position: fixed;
                bottom: 0;
                width: 100%;
                border-radius: 50% 50% 0 0 / 5%;
                background: rgb(0,0,0,0.925);
                color: white;
                margin: 0;
            }
            .pager-form{
                display: flex;
                justify-content: center;
                align-items: center;
                user-select: none;
            }
            .pager-form>*{
                flex: 1;
                min-width: fit-content;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            }
            .pager-form>*>*{
                flex: 1;
                min-width: fit-content;
                cursor: pointer;
            }
            .tablesorter-pager {
                padding: 1em;
            }
            td.tablesorter-pager {
                background-color: #e6eeee;
                margin: 0;
            }
            .tablesorter-pager img {
                vertical-align: middle;
                margin-right: 2px;
                cursor: pointer;
            }
            .tablesorter-pager .pagedisplay {
                margin-block: auto;
                text-align: center;
            }
            .tablesorter-pager select {
                margin: 0;
                padding: 0;
            }
            .tablesorter-pager.disabled {
                display: none;
            }
            .tablesorter-pager .disabled {
                opacity: 0.5;
                filter: alpha(opacity=50);
                cursor: default;
            }
            .pagerSavedHeightSpacer{
                display: none;
            }
        </style>
    </head>
    <body>
        <header>
            <div class="overlay">
                <h1 class="textLogo">Kanshi.</h1>
                <h3>Anime - Anilist</h3>
                <h3>Recommendations</h3>
            </div>
        </header>
        <div class="Home">
            <div class="searchData">
                <div class="userInputContainer">
                    <input class="userInput" placeholder="Anilist Username" name="username" id="username" type="text">
                </div>
                <div class="filter-container">
                    <input type="text"
                        placeholder="Filter Genre/Tags/etc.(Exclude - add !)"
                        class="flexdatalist"
                        data-data="Options.json"
                        data-search-in="info"
                        multiple="multiple"
                        data-min-length="1"
                        name="filter">
                </div>
                <div class="btn-container">
                    <button id="showAllAnime" class="btn show-hidden-btn show-all-anime" type="submit">Show All</button>
                    <button id="searchBtn" class="btn" type="submit">Search</button>
                </div>
                <div id="dataStatusContainer" class="data-status-container">
                    <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                    <h6 id="dataStatus"></h6>
                </div>
            </div>
            <div class="table-responsive">
                <table id="anime-table" class="tablesorter {sortlist: [[1,1]]} table table-bordered table-striped">
                    <thead>
                        <tr class="anime-table-headers">
                            <th id="hiddenUnhiddenBtn" class="trigger-btn sorter-false show-hidden-anime-btn">Unhidden</th>
                            <th>Score</th>
                            <th>Title</th>
                            <th>Status</th>
                            <th>Genres</th>
                            <th>Tags</th>
                            <th>Format</th>
                            <th>Year</th>
                            <th>Season</th>
                            <th>Studios</th>
                        </tr>
                    </thead>
                    <tbody id="animeRecommendationList">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- pager -->
        <div id="pager" class="pager">
            <form class="pager-form">
                <span class="first"><h5>First</h5></span>
                <span class="prev"><h5>Prev</h5></span>
                <span class="pagedisplay"></span>
                <span class="next"><h5>Next</h5></span>
                <span class="last"><h5>Last</h5></span>
            </form>
        </div>

        <!-- Modal -->
        <div id="myModal" class="modal fade">
	        <div class="modal-dialog modal-confirm">
		        <div class="modal-content">
			        <div class="modal-header flex-column">					
				        <h4 class="modal-title w-100">Are you sure?</h4>	
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			        </div>
			        <div class="modal-body">
				        <p>Do you really want to delete these records? This process cannot be undone.</p>
			        </div>
			        <div class="modal-footer justify-content-center">
				        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				        <button type="button" class="btn btn-danger">Delete</button>
			        </div>
		        </div>
	        </div>
        </div>
        <!-- confirmation modal-->
        <div id="confirm-modal" class="modal fade" >
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Modal title</h4>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete?&hellip;</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="loader">
            <span><h1 id="loaderText">Loading...</h1></span>
        </div>

        <script defer>
            // Load Saved Data
            var savedData = typeof retrieveJSON("savedJSON")==="undefined"? null : retrieveJSON("savedJSON")
            var savedUsername = typeof retrieveJSON("savedUsername")==="undefined"? null : retrieveJSON("savedUsername")
            var savedFilters = typeof retrieveJSON("savedFilters")==="undefined"? null : retrieveJSON("savedFilters")
            var savedHiddenAnimeTitles = typeof retrieveJSON("savedHiddenAnimeTitles")==="undefined"? null : retrieveJSON("savedHiddenAnimeTitles") || []
            var savedYscroll = typeof retrieveJSON("savedYscroll")==="undefined"? null : retrieveJSON("savedYscroll") || 0.0
            var savedUpdateTime = typeof retrieveJSON("savedUpdateTime")==="undefined"? null : retrieveJSON("savedUpdateTime") || 0
            var requestPause = typeof retrieveJSON("requestPause")==="undefined"? null : retrieveJSON("requestPause") || false
            var requestInterval = typeof retrieveJSON("requestInterval")==="undefined"? null : retrieveJSON("requestInterval") || 60000
            var requestIsRunning = false
            var updateStartTime
            var temp = []
            // Reload Saved Data
            $(window).load(function() {
                // Fix Css
                $(".table-responsive").css("margin-bottom",`${$("#pager").outerHeight()+43}px`)
                // Reload Name
                $('body').animate({scrollTop: savedYscroll },1)
                if(typeof savedUsername==="string")
                    $("#username").val(savedUsername)
                // Reload Data/Filters
                var filterData = ""
                if(savedFilters instanceof Array){
                    let x = setInterval(() => {
                        if($(".flexdatalist-multiple-value > .flexdatalist-alias").length){
                            clearInterval(x)
                            var filterInput
                            for(let i=0; i<savedFilters.length; i++) {
                                filterInput = $(".flexdatalist-multiple-value > .flexdatalist-alias")
                                filterInput.val(savedFilters[i])
                                var e = $.Event("keyup",{keyCode:13})
                                filterInput.trigger(e)
                            }
                            var filters = $(".flexdatalist-multiple").children("li.value")
                            for(let i=0; i<filters.length; i++) {
                                var filterName = filters.eq(i).children(".text")[0].innerText
                                if(filterName.toLowerCase()==="hidden"){
                                    $("#hiddenUnhiddenBtn").text("Unhidden")
                                }
                            }
                            // Reload Data Table
                            if(savedData!==null && typeof savedData==="object"){
                                $("#updateBtn").show()
                                if(typeof savedUsername==="string"){
                                    LoadData(savedData)
                                    Update()
                                }
                            } else {
                                animeData = `
                                    <tr class="item" role="row">
                                        <td style="padding: 1.5em !important;" colspan="10">
                                            <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                            No Data
                                        </td>
                                    </tr>
                                `
                                $("#animeRecommendationList").append(animeData)
                                $("#anime-table").trigger("update")
                            }
                        }   
                    }, 1)
                }
                // Load Functions    
                var pagerOptions = {
                    container: $(".pager"),
                    output: '{page} of {totalPages}',
                    updateArrows: true,
                    page: 0,
                    size: 7,
                    savePages : true,
                    storageKey:'tablesorter-pager',
                    pageReset: 0,
                    fixedHeight: true,
                    removeRows: false,
                    countChildRows: false,
                    cssNext: '.next', 
                    cssPrev: '.prev', 
                    cssFirst: '.first', 
                    cssLast: '.last',
                    cssPageDisplay: '.pagedisplay', 
                    cssPageSize: '.pagesize',
                    cssDisabled: 'disabled', 
                    cssErrorRow: 'tablesorter-errorRow'
                };
                $("#anime-table")
                    .tablesorter({
                        sortInitialOrder: "asc",
                        headers: {
                            0:{sortInitialOrder: "desc"}
                        }
                    })
                    .tablesorterPager(pagerOptions);
                    $('#anime-table').delegate('button.hide-anime', 'click' ,function() {
                        var hiddenRow =  $(this).closest('tr')
                        var hiddenAnimeTitle = hiddenRow.children("td#animeTitle").children("a")[0].textContent
                        savedHiddenAnimeTitles.push(hiddenAnimeTitle)
                        // Have a Hidden Anime
                        if(savedHiddenAnimeTitles.length>0){
                            $("#showAllAnime").show()
                        }
                        saveJSON(savedHiddenAnimeTitles,"savedHiddenAnimeTitles")
                        hiddenRow.remove()
                        $('#anime-table').trigger('update')
                        return false
                    })
                    $('#anime-table').delegate('button.show-anime', 'click' ,function() {
                        savedHiddenAnimeTitles = retrieveJSON("savedHiddenAnimeTitles") || []
                        var hiddenRow =  $(this).closest('tr')
                        var hiddenAnimeTitle = hiddenRow.children("td#animeTitle").children("a")[0].textContent
                        savedHiddenAnimeTitles = savedHiddenAnimeTitles.filter((v)=>v!==hiddenAnimeTitle) || []
                        saveJSON(savedHiddenAnimeTitles,"savedHiddenAnimeTitles")
                        hiddenRow.remove()
                        // No Hidden Anime
                        if(savedHiddenAnimeTitles.length===0){
                            $("#showAllAnime").hide()
                            var animeData = `
                                <tr class="item" role="row">
                                    <td style="padding: 1.5em !important;" colspan="10">
                                        <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                        No Data
                                    </td>
                                </tr>
                            `
                            $("#animeRecommendationList").append(animeData)
                        }
                        $('#anime-table').trigger('update')
                        return false
                    })
                    $('.goto').click(function() {
                    $('#anime-table').trigger('pageAndSize', [1, 7]);
                    });
                // Remove Loader
                $(".loader").fadeOut("slow")
            })
            // Event Listeners
            $("#username").on('keypress',(e)=>{if(e.which==13){LoadData(savedData)}})
            $("#searchBtn").on('click', ()=>{
                LoadData(savedData)
                Update()
            })
            $("#hiddenUnhiddenBtn").on('click',()=>{
                if(typeof savedUsername==="string"&&savedData!==null){
                    var state = $("#hiddenUnhiddenBtn").text()
                    if(!equalsNCS($("#username"),savedUsername)){
                        $("#username").val(savedUsername)
                    }
                    if(state==="Unhidden"){
                        $("#hiddenUnhiddenBtn").text("Hidden")
                        if($(".flexdatalist-multiple-value > .flexdatalist-alias").length){
                            var filterInput = $(".flexdatalist-multiple-value > .flexdatalist-alias")
                            filterInput.val("hidden")
                            var e = $.Event("keyup",{keyCode:13})
                            filterInput.trigger(e)
                        }
                        LoadData(savedData)
                    } else {
                        $("#hiddenUnhiddenBtn").text("Unhidden")
                        if($(".flexdatalist-multiple-value").length){
                            var filters = $(".flexdatalist-multiple").children("li.value")
                            for(let i=0; i<filters.length; i++) {
                                var filterName = filters.eq(i).children(".text")[0].innerText
                                if(filterName.toLowerCase()==="hidden"){
                                    filters.eq(i).children(".fdl-remove").trigger("click")
                                    $(".flexdatalist-alias").blur()
                                }
                            }
                        } 
                        LoadData(savedData)
                    }
                }
                
            })
            $("#showAllAnime").on('click',()=>{
                swal({
                    text: "Are you sure to show all hidden Anime?",
                    buttons: true,
                })
                .then((confirmed) => {
                    if(confirmed){
                        if(!equalsNCS($("#username"),savedUsername)){
                            $("#username").val(savedUsername)
                        }
                        savedHiddenAnimeTitles = []
                        saveJSON(savedHiddenAnimeTitles, "savedHiddenAnimeTitles")
                        LoadData(savedData)
                        $("#showAllAnime").hide()
                        swal("Hidden Animes have been successfully added!", {
                            icon: "success",
                        })
                    }
                })
            })
            $("body").on('scroll', function () {
                setTimeout(()=>{
                    saveJSON($("body").scrollTop(),"savedYscroll")
                },1)
            })
            // Search Function
            function Update(){
                updateStartTime = new Date
                var filterInput = $(".filter-container > ul > .flexdatalist-multiple-value > input")
                var username = $("#username").val()
                var filter = filterInput.val()
                // Check Input Validity
                if(username===""||username===null||typeof username==="undefined"){
                    $("#username")[0].setCustomValidity("Anilist Username is Required!")
                    $("#username")[0].reportValidity()
                }else if($(".flexdatalist-multiple").children("li").length<2&&filterInput.val()!=""){
                    filterInput[0].setCustomValidity("Select or Enter a word to Filter!")
                    filterInput[0].reportValidity()
                } else {
                    if(!requestPause){
                        // Search New Data
                        requestPause = true
                        saveJSON(requestPause,"requestPause")
                        requestInterval = 60
                        saveJSON(requestInterval, "requestInterval")
                        analyzeVariables(username)
                    } else {
                        if(!requestIsRunning){
                            for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                            requestInterval = retrieveJSON("requestInterval")
                            $("#dataStatusSpinner").show(0,()=>{
                                $("#dataStatusContainer").fadeIn(2500).css("display","flex")
                            })
                            for(let i=requestInterval; i>=0; i--){
                                let timeout = setTimeout(()=>{
                                    if(i===0){
                                        requestInterval = 60
                                        saveJSON(requestInterval, "requestInterval")
                                        requestPause = false
                                        saveJSON(requestPause,"requestPause")
                                        $("#dataStatusSpinner").hide(0,()=>{
                                            $("#dataStatus")
                                                .empty()
                                                .append(`Update is now Available!`)
                                            $("#dataStatusContainer").fadeOut(2500,()=>{
                                                $("#dataStatus").empty()
                                                Update()
                                            })
                                        })
                                    } else {
                                        $("#dataStatus")
                                            .empty()
                                            .append(`Please wait for another Update... Estimated Time: ${i}s`)
                                        saveJSON(i, "requestInterval")
                                    }
                                },(requestInterval-i)*1000)
                                temp.push(timeout)
                            }
                        }
                    }
                }
            }

            function analyzeVariables(username) {
                requestIsRunning = true
                // Check Parameters
                if(typeof username==="string") {
                    $("#dataStatusSpinner").show(0,()=>{
                        $("#dataStatusContainer").fadeIn(2500).css("display","flex")
                    })
                    if(savedUpdateTime!==0){
                        for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                        for(let i=savedUpdateTime; i>0; i--){
                            var timeout = setTimeout(()=>{
                                $("#dataStatus")
                                    .empty()
                                    .append(`Updating Data... Estimated Time: ${i}s`)
                            },(savedUpdateTime-i)*1000)
                            temp.push(timeout)
                        }
                    } else {
                        $("#dataStatus").append(`Updating Data...`)
                    }
                    // Initialize Anilist Graphql Data
                    var query = `
                    {
                        MediaListCollection(userName: "${username}", type: ANIME) {
                            lists {
                                status
                                entries {
                                    media {           
                                        title {
                                            userPreferred
                                        }
                                        averageScore
                                        format
                                        episodes
                                        genres
                                        tags {
                                            category
                                            name
                                            rank
                                        }
                                        studios {
                                            nodes {
                                                name
                                            }
                                        }
                                        format
                                        episodes
                                        seasonYear
                                        season
                                        staff {
                                            edges {
                                                node {
                                                    name {
                                                        first
                                                        last
                                                    }
                                                    siteUrl
                                                }
                                            }
                                        }
                                    }
                                    score
                                }
                            }
                        }
                    }
                    `;
                    
                    // Request API
                    $.ajax({
                        type: 'POST',
                        url: 'https://graphql.anilist.co',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        dataType: 'json',
                        data: JSON.stringify({
                            query: query
                        }),
                        success: (data)=> {
                            //Concat Completed, Watching, Drop, etc.
                            var animeList = data.data.MediaListCollection.lists
                            var animeEntries = []
                            for(let i=0; i<animeList.length-1; i++){
                                animeEntries = animeList[i].entries.concat(animeList[++i].entries)
                            }
                            var varScheme = {}
                            // Check Watched
                            var userListInfo = []
                            for(let i=0; i<animeList.length; i++){
                                for(let j=0; j<animeList[i].entries.length; j++){ 
                                    userListInfo.push({
                                        title: animeList[i].entries[j].media.title.userPreferred,
                                        status: animeList[i].status
                                    })
                                }
                            }
                            for(let i=0; i<animeEntries.length; i++){
                                if(animeEntries[i].score>0){
                                    var weight = animeEntries[i].score
                                    var anime = animeEntries[i].media
                                    var format = {}
                                    var year = {}
                                    var season = {}
                                    var episodes = {}
                                    var episodetype
                                    if(anime.episodes===1) episodetype = "Episode: 1"
                                    else if (anime.episodes>1&&anime.episodes<7) episodetype = "Episode: 2-6"
                                    else if (anime.episodes>6&&anime.episodes<14) episodetype = "Episode: 7-13"
                                    else if (anime.episodes>13&&anime.episodes<27) episodetype = "Episode: 14-26"
                                    else if (anime.episodes>26&&anime.episodes<53) episodetype = "Episode: 27-52"
                                    else if (anime.episodes>52&&anime.episodes<101) episodetype = "Episode: 53-100"
                                    else if (anime.episodes>100) episodetype = "Episode: 101+"
                                    else episodetype = "Episode: null"
                                    var genres = {}
                                    var tags = {}
                                    var tagsCategory = {}
                                    var studios = {}
                                    var staff = {}
                                    if(Object.keys(varScheme).length<1){
                                        format = {["Format: "+anime.format]: {
                                            count: 1,
                                            weight: [weight]
                                        }
                                        }
                                        episodes = {[episodetype]: {
                                            count: 1,
                                            weight: [weight]
                                        }
                                        }
                                        year = {["Year: "+anime.seasonYear]: {
                                            count: 1,
                                            weight: [weight]
                                        }
                                        }
                                        season = {["Season: "+anime.season]: {
                                            count: 1,
                                            weight: [weight]
                                        }
                                        }
                                        for(let j=0; j<anime.genres.length; j++){
                                        genres = {
                                            ["Genre: "+anime.genres[j]]: {
                                            count: 1,
                                            weight: [weight]
                                            }
                                        }
                                        }
                                        for(let j=0; j<anime.tags.length; j++){
                                        tags = {
                                            ["Tag: "+anime.tags[j].name]: {
                                            count: 1,
                                            rating: [anime.tags[j].rank],
                                            weight: [weight]
                                            }
                                        }
                                        tagsCategory = { 
                                            ["Tag Category: "+anime.tags[j].category]: {
                                            count: 1,
                                            rating: [anime.tags[j].rank],//base 100
                                            weight: [weight] //base 10
                                            }
                                        }
                                        }
                                        for(let j=0; j<anime.studios.nodes.length; j++){
                                        studios = {
                                            ["Studio: "+anime.studios.nodes[j].name]: {
                                            count: 1,
                                            weight: [weight]
                                            }
                                        }
                                        }
                                        for(let j=0; j<anime.staff.edges.length; j++){
                                        var firstname = anime.staff.edges[j].node.name.first==null?null:anime.staff.edges[j].node.name.first
                                        var lastname = anime.staff.edges[j].node.name.last==null?null:anime.staff.edges[j].node.name.last
                                        var fullname
                                        if(firstname!=null&&lastname!=null)
                                            fullname = firstname+" "+lastname
                                        else if(firstname!=null&&lastname==null)
                                            fullname = firstname
                                        else if(firstname==null&&lastname!=null)
                                            fullname = lastname
                                        else 
                                            fullname = "null"
                                        fullname = "Staff: "+fullname
                                        staff = {[fullname]: {
                                            count: 1,
                                            weight: [weight]
                                        }}
                                        }
                                        varScheme = {
                                        // Key with key
                                        format: format,
                                        episodes: episodes,
                                        year: year,
                                        season: season,
                                        genres: genres,
                                        tags: tags,
                                        tagsCategory: tagsCategory,
                                        studios: studios,
                                        staff: staff,
                                        }
                                    }
                                    else{
                                        var xformat = anime.format==null? "Format: null" : "Format: "+anime.format
                                        if(Object.keys(varScheme.format).length<1){
                                        varScheme.format = {[xformat]: {
                                            count: 1,
                                            weight: [weight]
                                        }}
                                        }
                                        else if(Object.keys(varScheme.format).includes(xformat)){
                                        varScheme.format[xformat].count = ++varScheme.format[xformat].count
                                        varScheme.format[xformat].weight.push(weight)
                                        }
                                        else{
                                        varScheme.format = {...varScheme.format, [xformat]: {
                                            count: 1,
                                            weight: [weight]
                                        }}
                                        }
                                        if(Object.keys(varScheme.episodes).length<1){
                                        varScheme.episodes = {[episodetype]: {
                                            count: 1,
                                            weight: [weight]
                                        }}
                                        }
                                        if(Object.keys(varScheme.episodes).includes(episodetype)){
                                        varScheme.episodes[episodetype].count = ++varScheme.episodes[episodetype].count
                                        varScheme.episodes[episodetype].weight.push(weight)
                                        }
                                        else{
                                        varScheme.episodes = {...varScheme.episodes, [episodetype]: {
                                            count: 1,
                                            weight: [weight]
                                        }}
                                        }
                                        var xseasonYear = anime.seasonYear==null? "Year: null" : "Year: "+anime.seasonYear.toString()
                                        if(Object.keys(varScheme.year).length<1){
                                        varScheme.year = {[xseasonYear]: {
                                            count: 1,
                                            weight: [weight]
                                        }}
                                        }
                                        else if(Object.keys(varScheme.year).includes(xseasonYear)){
                                        varScheme.year[xseasonYear].count = ++varScheme.year[xseasonYear].count
                                        varScheme.year[xseasonYear].weight.push(weight)
                                        }
                                        else{
                                        varScheme.year = {...varScheme.year, [xseasonYear]: {
                                            count: 1,
                                            weight: [weight]
                                        }}
                                        }
                                        var xseason = anime.season==null? "Season: null" : "Season: "+anime.season
                                        if(Object.keys(varScheme.season).length<1){
                                        varScheme.season = {[xseason]: {
                                            count: 1,
                                            weight: [weight]
                                        }}
                                        }
                                        else if(Object.keys(varScheme.season).includes(xseason)){
                                        varScheme.season[xseason].count = ++varScheme.season[xseason].count
                                        varScheme.season[xseason].weight.push(weight)
                                        }
                                        else{
                                        varScheme.season = {...varScheme.season, [xseason]: {
                                            count: 1,
                                            weight: [weight]
                                        }}
                                        }
                                        for(let j=0; j<anime.genres.length; j++){
                                        var xgenres = anime.genres[j]==null? "Genre: null" : "Genre: "+anime.genres[j]
                                        if(Object.keys(varScheme.genres).length<1){
                                            varScheme.genres = {[xgenres]: {
                                            count: 1,
                                            weight: [weight]
                                            }}
                                        }
                                        else if(Object.keys(varScheme.genres).includes(xgenres)){
                                            varScheme.genres[xgenres].count = ++varScheme.genres[xgenres].count
                                            varScheme.genres[xgenres].weight.push(weight)
                                        }
                                        else{
                                            varScheme.genres = {...varScheme.genres, [xgenres]: {
                                            count: 1,
                                            weight: [weight]
                                            }}
                                        }
                                        }
                                        for(let j=0; j<anime.tags.length; j++){
                                        var xtags = anime.tags[j].name==null? "Tag: null" : "Tag: "+anime.tags[j].name
                                        if(Object.keys(varScheme.tags).length<1){
                                            varScheme.tags = { 
                                            [xtags]: {
                                                count: 1,
                                                rating: [anime.tags[j].rank],
                                                weight: [weight]
                                            }
                                            }
                                        }
                                        else if(Object.keys(varScheme.tags).includes(xtags)){
                                            varScheme.tags[xtags].count = ++varScheme.tags[xtags].count
                                            varScheme.tags[xtags].rating.push(anime.tags[j].rank)
                                            varScheme.tags[xtags].weight.push(weight)
                                        }
                                        else {
                                            varScheme.tags = {...varScheme.tags, 
                                            [xtags]: {
                                            count: 1,
                                            rating: [anime.tags[j].rank],
                                            weight: [weight]
                                            }}
                                        }
                                        var xtagsCategory = anime.tags[j].category==null? "Tag Category: null" : "Tag Category: "+anime.tags[j].category
                                        if(Object.keys(varScheme.tagsCategory).length<1){
                                            varScheme.tagsCategory = { 
                                            [xtagsCategory]: {
                                                count: 1,
                                                rating: [anime.tags[j].rank],
                                                weight: [weight]
                                            }
                                            }
                                        }
                                        else if(Object.keys(varScheme.tagsCategory).includes(xtagsCategory)){
                                            varScheme.tagsCategory[xtagsCategory].count = ++varScheme.tagsCategory[xtagsCategory].count
                                            varScheme.tagsCategory[xtagsCategory].rating.push(anime.tags[j].rank)
                                            varScheme.tagsCategory[xtagsCategory].weight.push(weight)
                                        }
                                        else {
                                            varScheme.tagsCategory = {...varScheme.tagsCategory, 
                                            [xtagsCategory]: {
                                            count: 1,
                                            rating: [anime.tags[j].rank],
                                            weight: [weight]
                                            }}
                                        }
                                        }
                                        for(let j=0; j<anime.studios.nodes.length; j++){
                                        var xstudios = anime.studios.nodes[j].name==null? "Studio: null" : "Studio: "+anime.studios.nodes[j].name
                                        if(Object.keys(varScheme.studios).length<1){
                                            varScheme.studios = { 
                                            [xstudios]: {
                                                count: 1,
                                                weight: [weight]
                                            }
                                            }
                                        }
                                        else if(Object.keys(varScheme.studios).includes(xstudios)){
                                            varScheme.studios[xstudios].count = ++varScheme.studios[xstudios].count
                                            varScheme.studios[xstudios].weight.push(weight)
                                        }
                                        else {
                                            varScheme.studios = {...varScheme.studios, 
                                            [xstudios]: {
                                            count: 1,
                                            weight: [weight]
                                            }}
                                        }
                                        }
                                        for(let j=0; j<anime.staff.edges.length; j++){
                                        var firstname = anime.staff.edges[j].node.name.first==null?null:anime.staff.edges[j].node.name.first
                                        var lastname = anime.staff.edges[j].node.name.last==null?null:anime.staff.edges[j].node.name.last
                                        var fullname
                                        if(firstname!=null&&lastname!=null)
                                            fullname = firstname+" "+lastname
                                        else if(firstname!=null&&lastname==null)
                                            fullname = firstname
                                        else if(firstname==null&&lastname!=null)
                                            fullname = lastname
                                        else 
                                            fullname = "null"
                                        fullname = "Staff: "+fullname
                                        var xfullname = fullname
                                        if(Object.keys(varScheme.staff).length<1){
                                            varScheme.staff = {[xfullname]: {
                                            count: 1,
                                            weight: [weight]
                                            }}
                                        }
                                        else if(Object.keys(varScheme.staff).includes(xfullname)){
                                            varScheme.staff[xfullname].count = ++varScheme.staff[xfullname].count
                                            varScheme.staff[xfullname].weight.push(weight)
                                        }
                                        else varScheme.staff = {...varScheme.staff, [xfullname]: {
                                            count: 1,
                                            weight: [weight]
                                        }}
                                        }
                                    }
                                }
                            }
                            // Fix Data JSON
                            // Sum of every Dimension
                            var formatSum = 0
                            for(let i=0; i<Object.keys(varScheme.format).length; i++){
                                var formatKey = Object.keys(varScheme.format)
                                formatSum += varScheme.format[formatKey[i]].count
                            }
                            var episodeSum = 0
                            for(let i=0; i<Object.keys(varScheme.episodes).length; i++){
                                var episodesKey = Object.keys(varScheme.episodes)
                                episodeSum += varScheme.episodes[episodesKey[i]].count
                            }
                            var yearSum = 0
                            for(let i=0; i<Object.keys(varScheme.year).length; i++){
                                var yearKey = Object.keys(varScheme.year)
                                yearSum += varScheme.year[yearKey[i]].count
                            }
                            var seasonSum = 0
                            for(let i=0; i<Object.keys(varScheme.season).length; i++){
                                var seasonKey = Object.keys(varScheme.season)
                                seasonSum += varScheme.season[seasonKey[i]].count
                            }
                            var genresSum = 0
                            for(let i=0; i<Object.keys(varScheme.genres).length; i++){
                                var genresKey = Object.keys(varScheme.genres)
                                genresSum += varScheme.genres[genresKey[i]].count
                            }
                            var tagsSum = 0
                            for(let i=0; i<Object.keys(varScheme.tags).length; i++){
                                var tagsKey = Object.keys(varScheme.tags)
                                tagsSum += varScheme.tags[tagsKey[i]].count
                            }
                            var tagsCategorySum = 0
                            for(let i=0; i<Object.keys(varScheme.tagsCategory).length; i++){
                                var tagsCategoryKey = Object.keys(varScheme.tagsCategory)
                                tagsCategorySum += varScheme.tagsCategory[tagsCategoryKey[i]].count
                            }
                            var studiosSum = 0
                            for(let i=0; i<Object.keys(varScheme.studios).length; i++){
                                var studiosKey = Object.keys(varScheme.studios)
                                studiosSum += varScheme.studios[studiosKey[i]].count
                            }
                            var staffSum = 0
                            for(let i=0; i<Object.keys(varScheme.staff).length; i++){
                                var staffKey = Object.keys(varScheme.staff)
                                staffSum += varScheme.staff[staffKey[i]].count
                            }
                            ///////////////////////////////////////////////////////////////////////////////////////////////
                            // Sum of all Dimension
                            var sum = formatSum + episodeSum + yearSum + seasonSum + genresSum + tagsSum + tagsCategorySum + studiosSum + staffSum
                            // Clean Data JSON
                            var score, count, weight
                            for(let i=0; i<Object.keys(varScheme.format).length; i++){
                                var formatKey = Object.keys(varScheme.format)
                                score = arrayMean(varScheme.format[formatKey[i]].weight)*10
                                count = varScheme.format[formatKey[i]].count
                                weight = ((1/formatSum)*count)*((1/sum)*formatSum)
                                varScheme.format[formatKey[i]] = weight*score
                            }
                            for(let i=0; i<Object.keys(varScheme.episodes).length; i++){
                                var episodesKey = Object.keys(varScheme.episodes)
                                score = arrayMean(varScheme.episodes[episodesKey[i]].weight)*10
                                count = varScheme.episodes[episodesKey[i]].count
                                weight = ((1/episodeSum)*count)*((1/sum)*episodeSum)
                                varScheme.episodes[episodesKey[i]] = weight*score
                            }
                            for(let i=0; i<Object.keys(varScheme.year).length; i++){
                                var yearKey = Object.keys(varScheme.year)
                                score = arrayMean(varScheme.year[yearKey[i]].weight)*10
                                count = varScheme.year[yearKey[i]].count
                                weight = ((1/yearSum)*count)*((1/sum)*yearSum)
                                varScheme.year[yearKey[i]] = weight*score
                            }
                            for(let i=0; i<Object.keys(varScheme.season).length; i++){
                                var seasonKey = Object.keys(varScheme.season)
                                score = arrayMean(varScheme.season[seasonKey[i]].weight)*10
                                count = varScheme.season[seasonKey[i]].count
                                weight = ((1/seasonSum)*count)*((1/sum)*seasonSum)
                                varScheme.season[seasonKey[i]] = weight*score
                            }
                            for(let i=0; i<Object.keys(varScheme.genres).length; i++){
                                var genresKey = Object.keys(varScheme.genres)
                                score = arrayMean(varScheme.genres[genresKey[i]].weight)*10
                                count = varScheme.genres[genresKey[i]].count
                                weight = ((1/genresSum)*count)*((1/sum)*genresSum)
                                varScheme.genres[genresKey[i]] = weight*score
                            }
                            for(let i=0; i<Object.keys(varScheme.tags).length; i++){
                                var tagsKey = Object.keys(varScheme.tags)
                                score = arrayMean(varScheme.tags[tagsKey[i]].weight)*10
                                count = varScheme.tags[tagsKey[i]].count
                                weight = ((1/tagsSum)*count)*((1/sum)*tagsSum)
                                varScheme.tags[tagsKey[i]] = weight*score
                            }
                            for(let i=0; i<Object.keys(varScheme.tagsCategory).length; i++){
                                var tagsCategoryKey = Object.keys(varScheme.tagsCategory)
                                score = arrayMean(varScheme.tagsCategory[tagsCategoryKey[i]].weight)*10
                                count = varScheme.tagsCategory[tagsCategoryKey[i]].count
                                weight = ((1/tagsCategorySum)*count)*((1/sum)*tagsCategorySum)
                                varScheme.tagsCategory[tagsCategoryKey[i]] = weight*score
                            }
                            for(let i=0; i<Object.keys(varScheme.studios).length; i++){
                                var studiosKey = Object.keys(varScheme.studios)
                                score = arrayMean(varScheme.studios[studiosKey[i]].weight)*10
                                count = varScheme.studios[studiosKey[i]].count
                                weight = ((1/studiosSum)*count)*((1/sum)*studiosSum)
                                varScheme.studios[studiosKey[i]] = weight*score
                            }
                            for(let i=0; i<Object.keys(varScheme.staff).length; i++){
                                var staffKey = Object.keys(varScheme.staff)
                                score = arrayMean(varScheme.staff[staffKey[i]].weight)*10
                                count = varScheme.staff[staffKey[i]].count
                                weight = ((1/staffSum)*count)*((1/sum)*staffSum)
                                varScheme.staff[staffKey[i]] = weight*score
                            }
                            // Join Data
                            var varKeys = Object.keys(varScheme)
                            var tempVar = {}
                            for(let i=0; i<varKeys.length; i++){
                                var scoreVar = varScheme[varKeys[i]]
                                for(let j=0; j<Object.keys(scoreVar).length; j++){
                                var scoreKeys = Object.keys(scoreVar)
                                var scoreVal = Object.values(scoreVar)
                                tempVar = {...tempVar, [scoreKeys[j]]:scoreVal[j]}
                                }
                            }
                            varScheme = tempVar
                            analyzeAnime(username, varScheme, userListInfo)
                        },
                        error: function(xhr, error) {
                            var err = JSON.parse(xhr.responseText).errors[0].message
                            $("#dataStatusSpinner").hide(0,()=>{
                                $("#dataStatus")
                                    .empty()
                                    .append(`An Error has Occured!`)
                            })
                            setTimeout(()=>{
                                $("#dataStatusContainer").fadeOut(2500,()=>{
                                    $("#dataStatusSpinner").show()
                                    $("#dataStatus").empty()
                                })
                            })
                            if(err==="User not found"){
                                $("#username")[0].setCustomValidity("Username is not found!")
                                $("#username")[0].reportValidity()
                            } else {
                                swal("Error", {
                                    title: "Oops...Something Went Wrong!",
                                    text: `Error: ${err}`,
                                    icon: "error"
                                })
                            }
                            requestIsRunning = false
                            console.log(error)
                        }
                    })
                }
            }
            function analyzeAnime(username, varImportance, userListInfo){
                var page=1
                var maxAnimePerPage = 50
                var maxRequest=90-1//MaxRequest-RequestsBefore
                var timeInterval=60000 //Minute
                var recScheme=[]
                recall(page)
                function recall(xpage){
                    var startDate = new Date(Date.now()+1000) //Delay
                    $.ajax({
                        type: 'POST',
                        url: 'https://graphql.anilist.co',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        dataType: 'json',
                        data: JSON.stringify({
                            query: `
                            {
                                Page(page: ${page}, perPage: ${maxAnimePerPage}) {
                                    media(
                                        type: ANIME,
                                        format_not_in:[MUSIC,MANGA,NOVEL,ONE_SHOT]) {
                                        title {
                                            userPreferred
                                        }
                                        siteUrl
                                        averageScore
                                        format
                                        episodes
                                        genres
                                        tags {
                                            category
                                            name
                                        }
                                        studios {
                                            nodes {
                                                name
                                            }
                                        }
                                        format
                                        episodes
                                        seasonYear
                                        season
                                        staff {
                                            edges {
                                                node {
                                                    name {
                                                        first
                                                        last
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            `
                        }),
                        success: (result)=>{
                            var animeEntries = result.data.Page.media
                            if(animeEntries.length===0){
                                // Saved New Username
                                saveJSON(username,"savedUsername")
                                savedUsername = username
                                // Save new AnimeList json Data
                                saveJSON(recScheme, "savedJSON")
                                savedData = recScheme
                                // Reload new Data
                                LoadData(recScheme)
                                var timeInterval = (new Date).getTime()-updateStartTime.getTime()
                                saveJSON(Math.floor(timeInterval/1000)+1, "savedUpdateTime")
                                $("#dataStatusSpinner").hide(0,()=>{
                                    $("#dataStatus")
                                        .empty()
                                        .append(`List has been Updated!`)
                                })
                                setTimeout(()=>{
                                    $("#dataStatusContainer").fadeOut(2500,()=>{
                                        $("#dataStatusSpinner").show()
                                        $("#dataStatus").empty()
                                        requestIsRunning = false
                                        // Reload Request Interval
                                        for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                                        requestInterval = retrieveJSON("requestInterval")
                                        $("#dataStatusSpinner").show(0,()=>{
                                            $("#dataStatusContainer").fadeIn(2500).css("display","flex")
                                        })
                                        for(let i=requestInterval; i>=0; i--){
                                            let timeout = setTimeout(()=>{
                                                if(i===0){
                                                    requestInterval = 60
                                                    saveJSON(requestInterval, "requestInterval")
                                                    requestPause = false
                                                    saveJSON(requestPause,"requestPause")
                                                    $("#dataStatusSpinner").hide(0,()=>{
                                                        $("#dataStatus")
                                                            .empty()
                                                            .append(`Update is now Available!`)
                                                        $("#dataStatusContainer").fadeOut(2500,()=>{
                                                            $("#dataStatus").empty()
                                                        })
                                                    })
                                                } else {
                                                    $("#dataStatus")
                                                        .empty()
                                                        .append(`Please wait for another Request... Estimated Time: ${i}s`)
                                                    saveJSON(i, "requestInterval")
                                                }
                                            },(requestInterval-i)*1000)
                                            temp.push(timeout)
                                        }
                                    })
                                }, 1000)
                            } else {
                                for(let i=0; i<animeEntries.length; i++){
                                    var anime = animeEntries[i]
                                    /////
                                    var title = anime.title.userPreferred || "Title: N/A"
                                    var url = anime.siteUrl
                                    // var type = anime.type || "N/A"
                                    var format = anime.format || "Format: N/A"
                                    var year = anime.seasonYear || "Year: N/A"
                                    var season = anime.season || "Season: N/A"
                                    var studios = anime.studios.nodes
                                    var tags = anime.tags
                                    var genres = anime.genres
                                    var anilistScore = anime.averageScore
                                    var status = "UNWATCHED"
                                    var score = 0
                                    // Arrange
                                    var xformat = format!=="Format: N/A"?`Format: ${format}`:`${Math.random()}`
                                    var episodetype = `${Math.random()}`
                                    if(anime.episodes===1) episodetype = "Episode: 1"
                                    else if (anime.episodes>1&&anime.episodes<7) episodetype = "Episode: 2-6"
                                    else if (anime.episodes>6&&anime.episodes<14) episodetype = "Episode: 7-13"
                                    else if (anime.episodes>13&&anime.episodes<27) episodetype = "Episode: 14-26"
                                    else if (anime.episodes>26&&anime.episodes<53) episodetype = "Episode: 27-52"
                                    else if (anime.episodes>52&&anime.episodes<101) episodetype = "Episode: 53-100"
                                    else if (anime.episodes>100) episodetype = "Episode: 101+"
                                    //
                                    var xyear = year!=="Year: N/A"?"Year: "+year:`${Math.random()}`
                                    var xseason = season!=="Season: N/A"?"Season: "+season:`${Math.random()}`
                                    var xgenres = []
                                    for(let j=0; j<genres.length; j++){
                                        xgenres.push("Genre: "+genres[j])
                                    }
                                    var xtags = []
                                    var xtagsCategory = []
                                    for(let j=0; j<tags.length; j++){
                                        xtags.push("Tag: "+tags[j].name)
                                        xtagsCategory.push("Tag Category: "+tags[j].category)
                                    }
                                    var xstudios = []
                                    for(let j=0; j<studios.length; j++){
                                        xstudios.push("Studio: "+studios[j].name)
                                    }
                                    var xstaff = []
                                    for(let j=0; j<anime.staff.edges.length; j++){
                                        var firstname = anime.staff.edges[j].node.name.first==null?null:anime.staff.edges[j].node.name.first
                                        var lastname = anime.staff.edges[j].node.name.last==null?null:anime.staff.edges[j].node.name.last
                                        var fullname = `${Math.random()}`
                                        if(firstname!=null&&lastname!=null)
                                            fullname = firstname+" "+lastname
                                        else if(firstname!=null&&lastname==null)
                                            fullname = firstname
                                        else if(firstname==null&&lastname!=null)
                                            fullname = lastname
                                        xstaff.push("Staff: "+fullname)
                                    }
                                    // Analyze
                                    if(typeof varImportance[format]!=="undefined") score+=varImportance[format]
                                    if(typeof varImportance[episodetype]!=="undefined") score+=varImportance[episodetype]
                                    if(typeof varImportance[year]!=="undefined") score+=varImportance[year]
                                    if(typeof varImportance[season]!=="undefined") score+=varImportance[season]
                                    for(let j=0; j<xgenres.length; j++){
                                        if(typeof varImportance[xgenres[j]]!=="undefined") score+=varImportance[xgenres[j]]
                                    }
                                    for(let j=0; j<xtags.length; j++){
                                        if(typeof varImportance[xtags[j]]!=="undefined") score+=varImportance[xtags[j]]
                                    }
                                    for(let j=0; j<xtagsCategory.length; j++){
                                        if(typeof varImportance[xtagsCategory[j]]!=="undefined") score+=varImportance[xtagsCategory[j]]
                                    }
                                    for(let j=0; j<xstudios.length; j++){
                                        if(typeof varImportance[xstudios[j]]!=="undefined") score+=varImportance[xstudios[j]]
                                    }
                                    for(let j=0; j<xstaff.length; j++){
                                        if(typeof varImportance[xstaff[j]]!=="undefined") score+=varImportance[xstaff[j]]
                                    }
                                    //
                                    for(let k=0; k<userListInfo.length; k++){
                                        if(userListInfo[k].title===title){
                                            status = userListInfo[k].status
                                            break
                                        }
                                    }
                                    var info = ""
                                    for(let k=0; k<genres.length; k++){
                                        var genreName = genres[k]==="null"||genres[k]===null||genres[k]===""?"N/A":genres[k]
                                        if(k<genres.length-1) info = info+genreName+", "
                                        else info = info+genreName
                                    }
                                    genres = info==""?'Genres: N/A':info
                                    info = ""
                                    for(let k=0; k<tags.length; k++){
                                        var tagName = tags[k].name==="null"||tags[k].name===null||tags[k].name===""?"N/A":tags[k].name
                                        if(k<tags.length-1) info = info+tagName+", "
                                        else info = info+tagName
                                    }
                                    tags = info==""?'Tags: N/A':info
                                    info = ""
                                    for(let k=0; k<studios.length; k++){
                                        var studioName = studios[k].name==="null"||studios[k].name===null||studios[k].name===""?"N/A":studios[k].name
                                        if(k<studios.length-1) info = info+studioName+", "
                                        else info = info+studioName
                                    }
                                    studios = info==""?'Studios: N/A':info
                                    info = ""
                                    // Add Recommendation Scheme
                                    if(recScheme.length<1){
                                    recScheme.push({
                                        title: title, url: url, score: score, 
                                        status: status, genres: genres, tags: tags, year: year, 
                                        season: season, format: format, studios: studios
                                        })
                                    }
                                    else{
                                        var hasValue = false
                                        for(let k=0; k<recScheme.length; k++){
                                            hasValue = recScheme[k].title==title || hasValue
                                        }
                                        if(!hasValue){
                                            recScheme.push({
                                            title: title, url: url, score: score, 
                                            status: status, genres: genres, tags: tags, year: year, 
                                            season: season, format: format, studios: studios
                                            })
                                        }
                                    }
                                }
                                if(page%maxRequest===0){
                                    setTimeout(()=>{
                                        recall(++page)
                                    },(timeInterval-((new Date).getTime()-startDate.getTime())))
                                } else {
                                    recall(++page)
                                }           
                            }
                        },
                        error: function(xhr, error) {
                            var err = JSON.parse(xhr.responseText).errors[0].message
                            $("#dataStatus")
                                .empty()
                                .append(`An Error Occured!`)
                            setTimeout(()=>{
                                $("#dataStatus").fadeOut(2500,()=>{
                                    $("#dataStatus").empty()
                                })
                            })
                            if(err==="User not found"){
                                $("#username")[0].setCustomValidity("Username is not found!")
                                $("#username")[0].reportValidity()
                            } else {
                                swal("Error", {
                                    title: "Oops...Something Went Wrong!",
                                    text: `Error: ${err}`,
                                    icon: "error"
                                })
                            }
                            console.log(error)
                        }
                    })
                }
            }
            function LoadData(data){
                var filterInputs = $(".flexdatalist-multiple > .value").children(".text")
                var filters = []
                var includes = []
                var excludes = []
                for(let i=0; i<filterInputs.length; i++){
                    var filterName = filterInputs[i].textContent
                    filters.push(filterName)
                    if(filterName.charAt(0)==="!") excludes.push(filterName.slice(1))
                    else includes.push(filterName)
                }
                savedFilters = filters
                saveJSON(savedFilters, "savedFilters")
                if((data!==null && typeof data==="object")) {
                  // FilterOut User Includes and Excludes
                    // Include
                    var tempRecScheme = []
                    for(let i=0; i<includes.length; i++){
                        for(let j=0; j<data.length; j++){
                            var hasValue = false
                            if(equalsNCS(includes[i],data[j].type)
                            ||equalsNCS(includes[i],data[j].format)
                            ||equalsNCS(includes[i],data[j].year)
                            ||equalsNCS(includes[i],data[j].season)
                            ||equalsNCS(includes[i],data[j].status)
                            ||equalsNCS(includes[i],"hidden"))
                            {
                                tempRecScheme.push(data[j])
                                continue
                            }
                            var temp = data[j].studios.split(", ")
                            for(let k=0; k<temp.length; k++){
                                if(equalsNCS(includes[i],temp[k])){
                                    tempRecScheme.push(data[j])
                                    hasValue = true
                                    break
                                }
                            }
                            if(hasValue) continue
                            temp = data[j].genres.split(", ")
                            for(let k=0; k<temp.length; k++){
                                if(equalsNCS(includes[i],temp[k])){
                                    tempRecScheme.push(data[j])
                                    hasValue = true
                                    break
                                }
                            }
                            if(hasValue) continue
                            temp = data[j].tags.split(", ")
                            for(let k=0; k<temp.length; k++){
                                if(equalsNCS(includes[i],temp[k])){
                                    tempRecScheme.push(data[j])
                                    hasValue = true
                                    break
                                }
                            }
                        }
                        data = tempRecScheme
                        tempRecScheme = []
                    }
                    // Exclude
                    for(let i=0; i<excludes.length; i++){
                        for(let j=0; j<data.length; j++){
                            var hasValue = false
                            if(equalsNCS(excludes[i],data[j].type)
                            ||equalsNCS(excludes[i],data[j].format)
                            ||equalsNCS(excludes[i],data[j].year)
                            ||equalsNCS(excludes[i],data[j].season)
                            ||equalsNCS(excludes[i],data[j].status))
                            {
                                continue
                            }
                            temp = data[j].studios.split(", ")
                            for(let k=0; k<temp.length; k++){
                                if(equalsNCS(excludes[i],temp[k])){
                                    hasValue = true
                                    break
                                }
                            }
                            if(hasValue) continue
                            temp = data[j].genres.split(", ")
                            for(let k=0; k<temp.length; k++){
                                if(equalsNCS(excludes[i],temp[k])){
                                    hasValue = true
                                    break
                                }
                            }
                            if(hasValue) continue
                            temp = data[j].tags.split(", ")
                            for(let k=0; k<temp.length; k++){
                                if(equalsNCS(excludes[i],temp[k])){
                                    hasValue = true
                                    break
                                }
                            }
                            if(hasValue==false)
                                tempRecScheme.push(data[j])
                        }
                        data = tempRecScheme
                        tempRecScheme = []
                    }
                    // Show Table
                    var animeData = ""
                    if(savedHiddenAnimeTitles.length>0){
                        $("#showAllAnime").show()
                    }
                    savedHiddenAnimeTitles = retrieveJSON("savedHiddenAnimeTitles") || []
                    $.each(data, (key, value) => {
                        if(includes.some(item=>equalsNCS(item,"hidden"))){                            
                            if(savedHiddenAnimeTitles.includes(value.title)){
                                animeData += `
                                <tr class="item" role="row">
                                    <td class="hide-anime-column">
                                        <button 
                                            style="margin:auto; padding: 5px 13px;" 
                                            type="button" class="show-anime" 
                                            title="Hide this Anime">Show</button>
                                    </td>
                                    <td class="anime-score">${parseFloat(value.score.toFixed(5))}</td>
                                    <td id="animeTitle"><a href="${value.url}">${value.title}</a></td>
                                    <td>${value.status}</td>
                                    <td>${value.genres}</td>
                                    <td>${value.tags}</td>
                                    <td>${value.format}</td>
                                    <td>${value.year}</td>
                                    <td>${value.season}</td>
                                    <td>${value.studios}</td>
                                </tr>`
                            }
                        } else {
                            if(!savedHiddenAnimeTitles.includes(value.title)){
                                animeData += `
                                <tr class="item" role="row">
                                    <td class="hide-anime-column">
                                        <button 
                                            style="margin:auto; padding: 5px 13px;" 
                                            type="button" class="hide-anime" 
                                            title="Hide this Anime">Hide</button>
                                    </td>
                                    <td class="anime-score">${parseFloat(value.score.toFixed(5))}</td>
                                    <td id="animeTitle"><a href="${value.url}">${value.title}</a></td>
                                    <td>${value.status}</td>
                                    <td>${value.genres}</td>
                                    <td>${value.tags}</td>
                                    <td>${value.format}</td>
                                    <td>${value.year}</td>
                                    <td>${value.season}</td>
                                    <td>${value.studios}</td>
                                </tr>`
                            }
                        }
                    })
                    if(animeData===""){
                        animeData = `
                            <tr class="item" role="row">
                                <td style="padding: 1.5em !important;" colspan="10">
                                   <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                   No Data
                                </td>
                            </tr>
                        `
                    }
                    $("#animeRecommendationList").empty()
                    $("#animeRecommendationList").append(animeData)
                    $("#anime-table").trigger("update")
                } else {
                    Update()
                }
            }
            //////////////////////////////////////////////////////////////////
            // Extra
            function saveJSON(data, name) {
                localStorage.setItem(name, JSON.stringify(data))  
            }
            function retrieveJSON(name) {
                var retrievedObject = localStorage.getItem(name)
                return JSON.parse(retrievedObject)
            }
            function equalsNCS(str1, str2) {
                var s1 = str1
                var s2 = str2
                if(typeof str1=="number") s1 = str1.toString()
                if(typeof str2=="number") s2 = str2.toString()
                if(typeof str1=="string"&&typeof str2=="string")
                    return str1.toLowerCase() == str2.toLowerCase()
                else return s1==s2
                
            }
            function arraySum(obj) {
                return obj.reduce((a, b) => a + b, 0)
            }
            function arrayMean(obj) {
                return (arraySum(obj) / obj.length) || 0
            }
        </script>
    </body>
</html>