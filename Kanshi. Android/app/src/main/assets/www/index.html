<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanshi. - Anime Recommendation</title>
    <link rel="shortcut icon" type="image/x-icon" href="./public/logo.png" />
    <!-- Jquery -->
    <script src="./js-css/jquery-1.8.3.min.js"></script>
    <!-- Alternative JS Alert -->
    <script src="./js-css/sweetalert.min.js"></script>
    <!-- Table Sort -->
    <link rel="stylesheet" href="./js-css/jquery tablesorter/theme.default.min.css">
    <script type="text/javascript" src="./js-css/jquery tablesorter/jquery.tablesorter.js"></script>
    <script type="text/javascript" src="./js-css/jquery tablesorter/jquery.metadata.min.js"></script>
    <script type="text/javascript" src="./js-css/jquery tablesorter/jquery.tablesorter.pager.min.js"></script>
    <!-- Datalist Search Code -->
    <link rel="stylesheet" href="./js-css/flexdatalist/jquery.flexdatalist.css">
    <script src="./js-css/flexdatalist/jquery.flexdatalist.js"></script>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="./js-css/bootstrap-3.3.6.min.css"/>
    <!-- Fontawesome -->
    <link rel="stylesheet" href="./js-css/font-awesome.min.css">
    <script src="./js-css/fontawesome-5.0.js" crossorigin="anonymous"></script>
    <style>
            /* Re-edit */
                /* Change For Text Size */
            :root{
                font-size: 0.9rem !important;
            }
            /* Change/Add to Class/Tag of desired division for Padding */
            .Home,
            .overlay{
                padding-inline: clamp(0px, 5vw, 75px) !important;
            }
            /* Default */
            html,
            body {
                height: 100%;
                width: 100%;
                overflow: auto;
            }
            :root{
                font-size: 0.9rem;
                background-color: #fff;
                font-family: sans-serif;
                z-index: 0;
                min-width: 100%;
                min-height: 100%;
                overflow:auto;
            }
            :root>*{
                background-color: #fff;
                min-width: inherit;
                min-height: inherit;
            }
            *,
            ::after,
            ::before{
                margin: 0;
                padding: 0;
                text-indent: 0;
                box-sizing: border-box;
            }
            /* Text */
            .textLogo{
                font-size: clamp(1.6rem, 2vw,1.6rem) !important;
            }
            h1{
                font-size: clamp(1.3rem, 2vw,1.3rem);
            }
            h2{
                font-size: clamp(1.05rem, 2vw,1.05rem);
            }
            h3{
                font-size: clamp(1.05rem, 2vw,1.05rem);
            }
            p,
            label,
            input[type="text"]{
                font-size: clamp(0.95rem, 2vw,0.95rem);
            }
            h4{
                font-size: clamp(1rem, 2vw,1rem);
            }
            h5{
                font-size: clamp(0.9rem, 2vw,0.9rem);
            }
            h6{
                font-size: clamp(0.8rem, 2vw,0.8rem);
            }
            h1,
            h2,
            h3,
            h4,
            h5,
            h6,
            p,
            input,
            textarea,
            .textLogo{
                cursor:default;
                hyphens:manual;
                white-space:pre-wrap;
                word-break:break-word;
                overflow-wrap:break-word;
                transform-origin: left;
            }
            h1,
            h2,
            h3,
            h4,
            h5,
            h6,
            p,
            .textLogo{
                max-width: fit-content;
                min-width: fit-content;
            }
            /* Forms */
            input,
            textarea{
                outline: 0;
            }
            input[type=text]{
                width: 0;
            }
            button,
            button>*{
                cursor: pointer;
            }
            dialog{
                border: 0;
            }
            img{
                max-width: 100%;
            }
            /* Additional */
            body{
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            ::-webkit-scrollbar {
                display: none;
            }
            .example {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            button {
                background-color: black;
                color: white;
            }
            input {
                padding: 0.5em;
            }
            .userInput {
                width: min-content;
                border-color: rgb(118, 118, 118);
                border-width: 2px;
                border-style: inset;
                border-radius: 0px;
                background-color: rgb(255, 255, 255);
            }
            .loader {
                position: fixed;
                left: 0px;
                top: 0px;
                width: 100%;
                height: 100%;
                z-index: 9999;
                background: url('./public/loading.gif')
                    50% 50% no-repeat
                    rgb(0, 0, 0)
            }
            .loader > * {
                justify-content: center;
                min-height: 100%;
                align-items: center;
                display: flex;
                margin-top: 150px;
                color: wheat;
                text-align: center;
            }
            html,body,.home{
                width: 100%;
                min-height: 100%;
                height: 100%;
            }
            label{margin: 0}
            .searchData,.table-responsive{
                margin-block: 15px;
            }
            .flexdatalist-multiple > .value {
                max-width: fit-content;
                cursor: pointer;
            }
            .userInputContainer,.filter-container,.btn-container{
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                margin-block: 15px;
                gap: 0.5em;
            }
            .userInputContainer>:not(label),.filter-container>:not(label),.btn-container>:not(label){
                flex-grow: 1;
            }
            .flexdatalist-multiple{
                display: flex;
                flex-wrap: wrap-reverse;
                max-height: 120px;
                overflow-y: scroll;
            }
            .flexdatalist-multiple>.flexdatalist-multiple-value{
                flex-grow: 1;
                display: flex !important;
            }
            .flexdatalist-multiple>.flexdatalist-multiple-value>.flexdatalist-alias{
                outline: none;
                flex-grow: 1;
            }
            .tableLoadingContainer{
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .show-hidden-anime-btn{
                text-align: center !important;
                min-width: 85px !important;
            }
            header {
                background: url('./public/header.png');
                text-align: left;
                width: 100%;
                height: 165px;
                background-size: contain;
                position: relative;
                overflow: hidden;
                border-radius: 0 0 50% 50% / 5%;
            }
            header .overlay{
                width: 100%;
                height: 100%;
                padding: 1.75em;
                color: #FFF;
                background-image: linear-gradient( 135deg, #39343c69 10%, #6d00006b 100%);
            }
            header .overlay>*{
                padding-right: 50%;
            }
            button {
                border: none;
                outline: none;
                padding: 10px 20px;
                border-radius: 50px;
                box-shadow: 0 3px 20px 0 #0000003b;
            }
            button:hover{
                cursor: pointer;
            }
            a {
                color: #B06D70;
            }
            #updateIntervalBtn,
            #chooseExportPathBtn,
            #updateBtn,
            #showAllAnime{
                display: none;
            }
            #hiddenUnhiddenBtn{
                background: black !important;
                color: white !important;
                max-width: fit-content !important;
                cursor: pointer;
            }
            #searchBtn:hover,
            #searchBtn:focus{
                color: white;
            }
            .anime-table-headers > th{
                vertical-align: middle !important;
                padding: 1em !important;
            }
            .tablesorter-header-inner{
                margin-right: 0.5em !important;
                min-width: max-content !important;
            }
            .show-all-anime{
                background: black !important;
                color: white !important;
                border-radius: 5%;
                max-width: fit-content !important;
            }
            .tablesorter-default{
                margin: 0 !important;
            }
            .hide-anime-column{
                padding-block: 1.5em !important;
                vertical-align: middle !important;
                text-align: center !important;
                user-select: none !important;
            }
            .item > td {
                vertical-align: middle !important;
            }
            .swal-text:first-child{
                display: block !important;
                margin-top: 20px !important;
                margin-left: 15px !important;
            }
            .swal-text{
                font-size: 1.15rem !important;
                text-align: center;
            }
            .swal-footer{
                display: flex;
                justify-content: space-evenly;
                align-items: center;
                text-align: center;
            }
            .anime-score{
                text-align: center !important;
                max-width: 50px !important;
                text-overflow: ellipsis !important;
                overflow: hidden !important;
            }
            .overlay,
            .searchData,
            .flexdatalist-results{
                user-select: none;
            }
            .spinner {
                border: 2px solid #f3f3f3;
                border-top: 2px solid #B06D70;
                border-radius: 50%;
                width: 13px;
                height: 13px;
                animation: spin 2s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .data-status-container{
                display: none;
                align-items: center;
                justify-content: center;
            }
            .table-responsive{
                margin-bottom: 77px;
            }
            .pager{
                position: fixed;
                bottom: 0;
                width: 100%;
                border-radius: 50% 50% 0 0 / 5%;
                background: rgb(0,0,0,0.925);
                color: white;
                margin: 0;
                z-index: 100;
            }
            .pager-form{
                display: flex;
                justify-content: center;
                align-items: center;
                user-select: none;
            }
            .pager-form>*{
                flex: 1;
                min-width: fit-content;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            }
            .pager-form>*>*{
                flex: 1;
                min-width: fit-content;
                cursor: pointer;
            }
            .tablesorter-pager {
                padding: 1em;
            }
            td.tablesorter-pager {
                background-color: #e6eeee;
                margin: 0;
            }
            .tablesorter-pager img {
                vertical-align: middle;
                margin-right: 2px;
                cursor: pointer;
            }
            .tablesorter-pager .pagedisplay {
                margin-block: auto;
                text-align: left;
            }
            .tablesorter-pager select {
                margin: 0;
                padding: 0;
            }
            .tablesorter-pager.disabled {
                display: none;
            }
            .tablesorter-pager .disabled {
                opacity: 0.5;
                filter: alpha(opacity=50);
                cursor: default;
            }
            .pagerSavedHeightSpacer{
                display: none;
            }
            .pagedisplay{
                max-width: fit-content;
            }
            .pagenum{
                background-color: transparent;
                height: fit-content;
                border: transparent;
                text-align: center;
                outline: none;
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
            }
            .pagenum>*{
                background-color: black;
                color: white;
            }
            .endPage{
                text-align: left;
            }
            .nav{
                z-index: 100;
                position: fixed;
                width: 100%;
                height: 50px;
                display: flex;
                color: white;
                justify-content: space-between;
                background-color: rgb(0,0,0,0.925);
                padding: 1em;
                align-items: center;
            }
            .nav > div{
                flex: 1;
                display: flex;
            }
            .nav img{
                margin-left: auto;
                max-height: 40px;
                cursor: pointer;
            }
            .nav h1{
                cursor: pointer;
            }
            header{
                margin-top: 50px;
            }
            .menu-container {
                top: 0px;
                right: 0;
                position: fixed;
                z-index: 99;
                height: 100%;
                width: 100%;
                background-color: rgb(0, 0, 0, 0.925);
                color: white;
                display: none;
            }
            .menu-container>div{
                padding: 1em;
                margin-top: 60px;
                display: flex;
                flex-wrap: wrap;
                gap: 1.5em;
                height: min-content;
            }
            .menu-container>div>button{
                -moz-box-shadow: 0 3px 20px 0 #af6e7138 !important;
                -webkit-box-shadow: 0 3px 20px 0 #af6e7138 !important;
                box-shadow: 0 3px 20px 0 #af6e7138 !important;
            }
        </style>
</head>
<body>
<nav class="nav">
    <div><h1 id="menuTitle" class="textLogo">Kanshi.</h1></div>
    <div><img id="menuIcon" src="./public/logo.png" alt="menubar"></div>
</nav>
<div class="menu-container">
    <div>
        <button id="updateBtn">Update</button>
        <button id="showAllAnime">Show All</button>
        <input type="file" id="importFile" style="display: none;" accept=".json"/>
        <button id="importBtn">Import</button>
        <button id="exportBtn">Export</button>
        <button id="chooseExportPathBtn">Change Export Folder</button>
        <button id="updateIntervalBtn">Update Every 4 hours</button>
        <button id="exportIntervalBtn">Export Every 4 hours</button>
    </div>
</div>
<header>
    <div class="overlay">
        <h1 class="textLogo">Kanshi.</h1>
        <h3>Anime - Anilist</h3>
        <h3>Recommendations</h3>
    </div>
</header>
<div class="Home">
    <div class="searchData">
        <div class="userInputContainer">
            <input class="userInput" placeholder="Anilist Username" name="username" id="username" type="text">
        </div>
        <div class="filter-container">
            <input type="text"
                   placeholder="Filter Word/Number (!Exclude/Score>N/etc.)"
                   class="flexdatalist"
                   data-search-in="info"
                   multiple="multiple"
                   data-min-length="1"
                   name="filter">
        </div>
        <div class="btn-container">
            <button id="searchBtn" class="btn" type="submit">Search</button>
        </div>
        <div id="dataStatusContainer" class="data-status-container">
            <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
            <h6 id="dataStatus"></h6>
        </div>
    </div>
    <div class="table-responsive">
        <table id="anime-table" class="tablesorter {sortlist: [[1,1]]} table table-bordered table-striped">
            <thead>
            <tr class="anime-table-headers">
                <th id="hiddenUnhiddenBtn" class="trigger-btn sorter-false show-hidden-anime-btn">Unhidden</th>
                <th>Score</th>
                <th>Title</th>
                <th>Status</th>
                <th>Genres</th>
                <th>Tags</th>
                <th>Format</th>
                <th>Year</th>
                <th>Season</th>
                <th>Studios</th>
            </tr>
            </thead>
            <tbody id="animeRecommendationList">
            <tr class="item" role="row">
                <td style="padding: 1.5em !important;" colspan="10">
                    <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                    No Data
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- pager -->
<div id="pager" class="pager">
    <form class="pager-form">
        <span id="first" class="first"><h5>First</h5></span>
        <span id="prev" class="prev"><h5>Prev</h5></span>
        <span id="selectPageNumber">
            <select id="pageNumberOptions" class="custom-select pagenum" title="Select page number"></select>
        </span>
        <span id="next" class="next"><h5>Next</h5></span>
        <span id="last" class="last"><h5>Last</h5></span>
    </form>
</div>

<!-- Modal -->
<div id="myModal" class="modal fade">
    <div class="modal-dialog modal-confirm">
        <div class="modal-content">
            <div class="modal-header flex-column">
                <h4 class="modal-title w-100">Are you sure?</h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            </div>
            <div class="modal-body">
                <p>Do you really want to delete these records? This process cannot be undone.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>
<!-- confirmation modal-->
<div id="confirm-modal" class="modal fade" >
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">Modal title</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete?&hellip;</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>
</div>
<div class="loader">
    <span><h1 id="loaderText">Loading...</h1></span>
</div>

<script defer>
            // Initialize Global Variables
              // IndexDB
            var request, db,
              // Saved Data
            savedUsername, savedData, savedFilters, savedUpdateTime, requestIntervalSeconds,
            savedHiddenAnimeTitles, savedYscroll, savedTablePage, savedTableStatus, exportPathIsAvailable,
            savedFilterOptionsJson, allFilterInfo, exportIntervalIsActive, updateIntervalIsActive,
            exportIntervalStartDate, updateIntervalStartDate,
              // Load Saved API Request State
            savedUpdateTime, savedLastRequestDate, requestPause,
            updateStartTime, isRunning = false, requestIsRunning = false, temp = []
            // Create IndexDB
            $(window).load(function() {
                new Promise((resolve)=>{
                    request = window.indexedDB.open("MyIndexDB", 1)
                    request.onerror = (event) => {
                        console.error("MyIndexDB is Not Allowed! Using Locale Storage Instead")
                    }
                    request.onsuccess = (event) => {
                        db = event.target.result
                        resolve()
                    }
                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        db.createObjectStore("MyObjectStore")
                    }
                }).then(async()=>{
                    // Auto css
                    $(".table-responsive").css("margin-bottom",`${$("#pager").outerHeight()+43}px`)
                    // Reload Name
                    savedUsername = await retrieveJSON("savedUsername") || ""
                    if(savedUsername.length>0){
                        $("#username").val(savedUsername)
                        $("#updateIntervalBtn").show()
                    }
                    // Reload FilterOptions
                    savedFilterOptionsJson = await retrieveJSON("savedFilterOptionsJson") || []
                    allFilterInfo = await retrieveJSON("allFilterInfo") || {}
                    if(savedFilterOptionsJson.length===0){
                        var worker = new Worker("./js-css/worker/getOptions.js")
                        worker.postMessage("")
                        worker.onmessage = (message) => {
                            const data = message.data
                            savedFilterOptionsJson = data.savedFilterOptionsJson
                            saveJSON(savedFilterOptionsJson,"savedFilterOptionsJson")
                            allFilterInfo = data.allFilterInfo
                            saveJSON(allFilterInfo,"allFilterInfo")
                            $('.flexdatalist').flexdatalist({
                                minLength: 1,
                                searchIn: 'info',
                                data: savedFilterOptionsJson
                            })
                            worker.terminate()
                        }
                    } else {
                        $('.flexdatalist').flexdatalist({
                            minLength: 1,
                            searchIn: 'info',
                            data: savedFilterOptionsJson
                        })
                    }
                    // Reload Filters -> Data
                        // Check for FlexDatalist Availability
                    let reloadSavedData = setInterval(async () => {
                        if($(".flexdatalist-multiple-value > .flexdatalist-alias").length){
                            clearInterval(reloadSavedData)
                            // Reload Filters
                            var filterInput
                            savedFilters = await retrieveJSON("savedFilters") || []
                            for(let i=0; i<savedFilters.length; i++) {
                                filterInput = $(".flexdatalist-multiple-value > .flexdatalist-alias")
                                await filterInput.val(savedFilters[i])
                                var e = await $.Event("keyup",{keyCode:13})
                                await filterInput.trigger(e)
                                await filterInput.val("")
                            }
                            // Check if the List shown is Hidden List or Unhidden List -> Rename th button
                            var filters = $(".flexdatalist-multiple").children("li.value")
                            for(let i=0; i<filters.length; i++) {
                                var filterName = filters.eq(i).children(".text")[0].innerText
                                if(filterName.toLowerCase()==="hidden"){
                                    $("#hiddenUnhiddenBtn").text("Hidden")
                                }
                            }
                            // Reload Data Table
                            await $("#animeRecommendationList").html(`
                                <tr class="item" role="row">
                                    <td style="padding: 1.5em !important;" colspan="10">
                                        <div style="display:flex; align-items:center;">
                                            <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                            <div>Loading...</div>
                                        </div>
                                    </td>
                                </tr>
                            `)
                            savedData = await retrieveJSON("savedData") || []
                            if(savedData.length>0){
                                $("#updateBtn").show()
                                await LoadData(savedData,false)
                                if(savedHiddenAnimeTitles.length>0){
                                    $("#showAllAnime").show()
                                }
                            } else {
                                animeData = `
                                    <tr class="item" role="row">
                                        <td style="padding: 1.5em !important;" colspan="10">
                                            <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                            No Data
                                        </td>
                                    </tr>
                                `
                                $("#animeRecommendationList").empty()
                                $("#animeRecommendationList").append(animeData)
                                await $("#anime-table").trigger("update")
                                setTimeout(()=>{
                                    let setPageInfo = setInterval(()=>{
                                        if(typeof $('#anime-table')[0].config!=="undefined"){
                                            clearInterval(setPageInfo)
                                            $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                        }
                                    },1)
                                },0)
                            }
                        }
                    },1)

                    // Reload saved Website Y-Position
                    savedYscroll = await retrieveJSON("savedYscroll") || 0.0
                    var reloadSavedYScrollStartDate = new Date()
                    let reloadSavedYScroll = setInterval(()=>{
                        $('body').animate({scrollTop: savedYscroll},1)
                        if($("body").scrollTop()===savedYscroll||
                        (((new Date()).getTime())-reloadSavedYScrollStartDate.getTime())>1000){
                            clearInterval(reloadSavedYScroll)
                        }
                    },1)

                    // Auto Interval
                      // Update
                    updateIntervalIsActive = await retrieveJSON("updateIntervalIsActive") || false
                      if(updateIntervalIsActive){
                        $("#updateIntervalBtn").css({background: "white",color:"black"})
                        updateIntervalStartDate = await retrieveJSON("updateIntervalStartDate") || new Date()
                        saveJSON(updateIntervalStartDate,"updateIntervalStartDate")
                        if((new Date).getTime()-(updateIntervalStartDate.getTime())>14400000){// 4hrs
                            Update()
                            updateIntervalStartDate = new Date()
                            saveJSON(updateIntervalStartDate,"updateIntervalStartDate")
                        }
                    }
                    exportIntervalIsActive = await retrieveJSON("exportIntervalIsActive") || false
                      // Export
                    if(exportIntervalIsActive){
                        $("#exportIntervalBtn").css({background: "white",color:"black"})
                        exportIntervalStartDate = await retrieveJSON("exportIntervalStartDate") || new Date()
                        saveJSON(exportIntervalStartDate,"exportIntervalStartDate")
                        if((new Date).getTime()-(exportIntervalStartDate.getTime())>14400000){// 4hrs
                            const savedUsername = await retrieveJSON("savedUsername")
                            const savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles")
                            const allFilterInfo = await retrieveJSON("allFilterInfo")
                            const savedFilterOptionsJson = await retrieveJSON("savedFilterOptionsJson")
                            const savedData = await retrieveJSON("savedData")
                            const backup = {
                                savedUsername: savedUsername,
                                savedHiddenAnimeTitles: savedHiddenAnimeTitles,
                                allFilterInfo: allFilterInfo,
                                savedFilterOptionsJson: savedFilterOptionsJson,
                                savedData: savedData
                            }
                            downloadObjectAsJson(backup, "Kanshi-Backup")
                            exportIntervalStartDate = new Date()
                            saveJSON(exportIntervalStartDate,"exportIntervalStartDate")
                        }
                    }

                    // Export Path is Available
                    exportPathIsAvailable = await retrieveJSON("exportPathIsAvailable")
                    if(exportPathIsAvailable){
                        $("#chooseExportPathBtn").show()
                    }

                    // Load Functions
                    savedTablePage = await retrieveJSON("savedTablePage") || [0,0]
                    savedTableStatus = await retrieveJSON("savedTableStatus") || "Unhidden"
                    await $("#anime-table")
                        .tablesorter({
                            sortInitialOrder: "asc",
                            headers: {
                                0:{sortInitialOrder: "desc"}
                            }
                        })
                        .tablesorterPager({
                            container: $(".pager"),
                            updateArrows: true,
                            page: savedTableStatus==="Unhidden"? savedTablePage[0]:savedTablePage[1],
                            savePages: true,
                            size: 8,
                            pageReset: false,
                            removeRows: true,
                            cssNext: '.next',
                            cssPrev: '.prev',
                            cssFirst: '.first',
                            cssLast: '.last',
                            cssGoto: '.pagenum',
                            cssPageDisplay: '.pagedisplay'
                        })
                        .bind('pageMoved', async function(){
                            setTimeout(()=>{
                                let setPageInfo = setInterval(()=>{
                                    if(typeof $('#anime-table')[0].config!=="undefined"){
                                        clearInterval(setPageInfo)
                                        $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                    }
                                },1)
                            },0)
                            var page = $('#anime-table')[0].config.pager.page
                            savedTableStatus = await retrieveJSON("savedTableStatus") || "Unhidden"
                            savedTablePage = await retrieveJSON("savedTablePage") || [0,0]
                            saveJSON(savedTableStatus==="Unhidden"?[page,savedTablePage[1]||0]:[savedTablePage[0]||0,page],"savedTablePage")
                        })
                    await $('#anime-table')
                        .delegate('button.hide-anime', 'click' , async function() {
                            var hiddenRow =  $(this).closest('tr')
                            var hiddenAnimeTitle = hiddenRow.children("td#animeTitle").children("a")[0].textContent
                            savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles") || []
                            savedHiddenAnimeTitles.push(hiddenAnimeTitle)
                            saveJSON(savedHiddenAnimeTitles,"savedHiddenAnimeTitles")
                            // Have a Hidden Anime
                            if(savedHiddenAnimeTitles.length>0){
                                $("#showAllAnime").show()
                            }
                            await hiddenRow.html(`
                                <td style="padding: 1.5em !important;" colspan="10">
                                    <div style="display:flex; align-items:center;">
                                        <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                        <div>Loading...</div>
                                    </div>
                                </td>
                            `)
                            savedData = await retrieveJSON("savedData")
                            await LoadData(savedData,false)
                            setTimeout(()=>{
                                let setPageInfo = setInterval(()=>{
                                    if(typeof $('#anime-table')[0].config!=="undefined"){
                                        clearInterval(setPageInfo)
                                        $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                    }
                                },1)
                            },0)
                            return false
                        })
                    await $('#anime-table').delegate('button.show-anime', 'click' , async function() {
                        var hiddenRow = $(this).closest('tr')
                        var hiddenAnimeTitle = hiddenRow.children("td#animeTitle").children("a")[0].textContent
                        savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles") || []
                        savedHiddenAnimeTitles = savedHiddenAnimeTitles.filter((v)=>v!==hiddenAnimeTitle)
                        saveJSON(savedHiddenAnimeTitles,"savedHiddenAnimeTitles")
                        // No Hidden Anime
                        if(savedHiddenAnimeTitles.length===0){
                            $("#showAllAnime").hide()
                        } else {
                            await hiddenRow.html(`
                                <td style="padding: 1.5em !important;" colspan="10">
                                    <div style="display:flex; align-items:center;">
                                        <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                        <div>Loading...</div>
                                    </div>
                                </td>
                            `)
                        }
                        savedData = await retrieveJSON("savedData")
                        await LoadData(savedData,false)
                        setTimeout(()=>{
                            let setPageInfo = setInterval(()=>{
                                if(typeof $('#anime-table')[0].config!=="undefined"){
                                    clearInterval(setPageInfo)
                                    $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                }
                            },1)
                        },0)
                        return false
                    })
                    // Remove Loader
                    setTimeout(()=>{
                        let setPageInfo = setInterval(()=>{
                            if(typeof $('#anime-table')[0].config!=="undefined"){
                                clearInterval(setPageInfo)
                                $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                            }
                        },1)
                    },0)
                    setTimeout(()=>{
                        $(".loader").fadeOut("slow")
                    },1000)
                })
            })
            // Event Listeners
            $("#username").on('keypress',async e =>{
                savedData = await retrieveJSON("savedData") || []
                if(e.which==13) {
                    LoadData(savedData,false)
                }
            })
            $("#searchBtn").on('click', async ()=>{
                savedData = await retrieveJSON("savedData") || []
                savedUpdateTime = await retrieveJSON("savedUpdateTime") || 1800
                if(savedData.length>0) {
                    await $("#animeRecommendationList").html(`
                        <tr class="item" role="row">
                            <td style="padding: 1.5em !important;" colspan="10">
                                <div style="display:flex; align-items:center;">
                                    <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                    <div>Loading...</div>
                                </div>
                            </td>
                        </tr>
                    `)
                    LoadData(savedData,false)
                }
                else {
                    swal({
                        text: `Do you want to continue and Update your Recommendations List?
                        The estimated time to finish is ${msToTime(savedUpdateTime*1000)}`,
                        buttons: [
                            'No',
                            'Yes'
                        ],
                    })
                    .then((confirmed) => {
                        if(confirmed){
                            Update()
                        }
                    })
                }
            })
            $("#menuIcon, #menuTitle").on("click",()=>{
                var menu = $(".menu-container")
                if(menu.css("display")=="none"){
                    menu.fadeIn(250)
                } else {
                    menu.fadeOut(250)
                }
            })
            $("#updateBtn").on('click', async ()=>{
                savedUpdateTime = await retrieveJSON("savedUpdateTime") || 1800
                swal({
                    text: `Do you want to continue and Update your Recommendations List?
                    The estimated time to finish is ${msToTime(savedUpdateTime*1000)}`,
                    buttons: [
                        'No',
                        'Yes'
                    ],
                })
                .then(async (confirmed) => {
                    if(confirmed){
                        Update()
                        $(".menu-container").fadeOut(250)
                    }
                })
            })
            $("#hiddenUnhiddenBtn").on('click', async()=>{
                if(!isRunning){
                    isRunning = true
                    savedUsername = await retrieveJSON("savedUsername") || ""
                    savedData = await retrieveJSON("savedData") || []
                    if(savedUsername.length>0&&savedData.length>0){
                        console.log("run3")
                        var state = await $("#hiddenUnhiddenBtn").text()
                        if(!equalsNCS($("#username").val(),savedUsername)){
                            await $("#username").val(savedUsername)
                            console.log("run4")
                        }
                        if(state==="Unhidden"){
                            console.log("run5")
                            if($(".flexdatalist-multiple-value > .flexdatalist-alias").length){
                                var filterInput = await $(".flexdatalist-multiple-value > .flexdatalist-alias")
                                await filterInput.val("hidden")
                                var e = await $.Event("keyup",{keyCode:13})
                                await filterInput.trigger(e)
                                await filterInput.val("")
                            }
                            saveJSON("Hidden","savedTableStatus")
                            await $("#animeRecommendationList").html(`
                                <tr class="item" role="row">
                                    <td style="padding: 1.5em !important;" colspan="10">
                                        <div style="display:flex; align-items:center;">
                                            <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                            <div>Loading...</div>
                                        </div>
                                    </td>
                                </tr>
                            `)
                            await LoadData(savedData,false)
                            await $("#hiddenUnhiddenBtn").text("Hidden")
                            savedTablePage = await retrieveJSON("savedTablePage") || [0,0]
                            $("#anime-table").trigger("pageSet",1+savedTablePage[0])
                            setTimeout(()=>{
                                let setPageInfo = setInterval(()=>{
                                    if(typeof $('#anime-table')[0].config!=="undefined"){
                                        clearInterval(setPageInfo)
                                        $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                    }
                                },1)
                            },0)
                            isRunning = false
                        } else {
                            console.log("run6")
                            if($(".flexdatalist-multiple-value").length){
                                var filters = await $(".flexdatalist-multiple").children("li.value")
                                for(let i=0; i<filters.length; i++) {
                                    var filterName = await filters.eq(i).children(".text")[0].innerText
                                    if(filterName.toLowerCase()==="hidden"){
                                        await filters.eq(i).children(".fdl-remove").trigger("click")
                                        await $(".flexdatalist-alias").blur()
                                    }
                                }
                            }
                            saveJSON("Unhidden","savedTableStatus")
                            await $("#animeRecommendationList").html(`
                                <tr class="item" role="row">
                                    <td style="padding: 1.5em !important;" colspan="10">
                                        <div style="display:flex; align-items:center;">
                                            <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                            <div>Loading...</div>
                                        </div>
                                    </td>
                                </tr>
                            `)
                            await LoadData(savedData,false)
                            $("#hiddenUnhiddenBtn").text("Unhidden")
                            savedTablePage = await retrieveJSON("savedTablePage") || [0,0]
                            savedTableStatus = await retrieveJSON("savedTableStatus") || "Unhidden"
                            $("#anime-table").trigger("pageSet",1+savedTablePage[1])
                            setTimeout(()=>{
                                let setPageInfo = setInterval(()=>{
                                    if(typeof $('#anime-table')[0].config!=="undefined"){
                                        clearInterval(setPageInfo)
                                        $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                    }
                                },1)
                            },0)
                            isRunning = false
                        }
                    } else isRunning = false
                }
            })
            $("#showAllAnime").on('click', ()=>{
                swal({
                    text: "Do you want to show all your hidden Anime? This will remove all hidden Anime in the Hidden's List!",
                    buttons: [
                        'No',
                        'Yes'
                    ],
                })
                .then(async(confirmed) => {
                    if(confirmed){
                        savedUsername = await retrieveJSON("savedUsername") || ""
                        if(!equalsNCS($("#username").val(),savedUsername)){
                            $("#username").val(savedUsername)
                        }
                        saveJSON([], "savedHiddenAnimeTitles")
                        savedData = await retrieveJSON("savedData") || []
                        if(await $(".flexdatalist-multiple-value").length){
                            var filters = await $(".flexdatalist-multiple").children("li.value")
                            for(let i=0; i<filters.length; i++) {
                                var filterName = await filters.eq(i).children(".text")[0].innerText
                                if(filterName.toLowerCase()==="hidden"){
                                    await filters.eq(i).children(".fdl-remove").trigger("click")
                                    await $(".flexdatalist-alias").blur()
                                }
                            }
                        }
                        if($("#hiddenUnhiddenBtn").text()==="Hidden"){
                            await $("#animeRecommendationList").html(`
                                    <tr class="item" role="row">
                                        <td style="padding: 1.5em !important;" colspan="10">
                                            <div style="display:flex; align-items:center;">
                                                <div id="dataStatusSpinner" style="margin-right:0.5ch;" class="spinner"></div>
                                                <div>Loading...</div>
                                            </div>
                                        </td>
                                    </tr>
                                `)
                        }
                        await LoadData(savedData,false)
                        $("#hiddenUnhiddenBtn").text("Unhidden")
                        savedTablePage = await retrieveJSON("savedTablePage") || [0,0]
                        await $('#anime-table').trigger("pageSet",savedTablePage[0])
                        setTimeout(()=>{
                            let setPageInfo = setInterval(()=>{
                                if(typeof $('#anime-table')[0].config!=="undefined"){
                                    clearInterval(setPageInfo)
                                    $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                }
                            },1)
                        },0)
                        saveJSON("Unhidden","savedTableStatus")
                        saveJSON($('#anime-table')[0].config.pager.page,"savedTablePage")
                        $("#showAllAnime").hide()
                        $(".menu-container").fadeOut(250)
                        swal("All Hidden Animes has now been successfully Unidden!", {
                            icon: "success",
                        })
                    }
                })
            })
            $("#importBtn").on("click", ()=>{
                $("#importFile").click()
            })
            $("#importFile").on("change",(event)=>{
                if($("#importFile")[0].value != ""){
                    try {
                        const importedFile = $("#importFile")[0].files[0]
                        const reader = new FileReader();
                        reader.onload = () => {
                            const fullPath = $("#importFile")[0].value
                            $("#importBtn").css({background: "white", color: "black"})
                            const startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
                            var filename = fullPath.substring(startIndex);
                            if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
                                filename = filename.substring(1);
                            }
                            swal({
                                text: `File named [${filename}] been Detected, do you want to continue the Import? This will remove your current Data!`,
                                buttons: [
                                    'No',
                                    'Yes'
                                ],
                            })
                            .then(async (confirmed) => {
                                if(confirmed){
                                    $("#importBtn").css({background: "black", color: "white"})
                                    const fileContent = JSON.parse(reader.result);
                                    const entries = Object.entries(fileContent)
                                    savedUsername = fileContent.savedUsername || ""
                                    saveJSON(savedUsername,"savedUsername")
                                    savedHiddenAnimeTitles = fileContent.savedHiddenAnimeTitles || []
                                    saveJSON(savedHiddenAnimeTitles,"savedHiddenAnimeTitles")
                                    allFilterInfo = fileContent.allFilterInfo || allFilterInfo
                                    saveJSON(allFilterInfo,"allFilterInfo")
                                    savedFilterOptionsJson = fileContent.savedFilterOptionsJson || savedFilterOptionsJson
                                    saveJSON(savedFilterOptionsJson,"savedFilterOptionsJson")
                                    savedData = fileContent.savedData || []
                                    saveJSON(savedData,"savedData")
                                    $("#username").val(savedUsername)
                                    if(savedUsername.length) $("#updateIntervalBtn").show()
                                    else $("#updateIntervalBtn").hide()
                                    $('.flexdatalist').flexdatalist({
                                        data: savedFilterOptionsJson
                                    })
                                    if(savedHiddenAnimeTitles.length) $("#showAllAnime").show()
                                    else $("#showAllAnime").hide()
                                    if(savedData.length) {
                                        $("#updateBtn").show()
                                        LoadData(savedData)
                                    } else {
                                        $("#updateBtn").hide()
                                        animeData = `
                                            <tr class="item" role="row">
                                                <td style="padding: 1.5em !important;" colspan="10">
                                                    <i class="fa fa-solid fa-file fa-xl" style="padding-right: 1ch;"></i>
                                                    No Data
                                                </td>
                                            </tr>
                                        `
                                        $("#animeRecommendationList").empty()
                                        $("#animeRecommendationList").append(animeData)
                                        await $("#anime-table").trigger("update")
                                    }
                                    $(".menu-container").fadeOut(250)
                                    swal("Data has been Updated!", {
                                        icon: "success",
                                    })
                                } else {
                                    $("#importBtn").css({background: "black", color: "white"})
                                    $("#importFile")[0].value = "";
                                }
                            })
                        }
                        reader.readAsText(importedFile);
                    }catch(ex){}
                }
            })
            $("#exportBtn").on("click", async()=>{
                exportPathIsAvailable = await retrieveJSON("exportPathIsAvailable") || false
                if(exportPathIsAvailable) {
                    swal({
                        text: `Do you want to Export your Data?`,
                        buttons: [
                            'No',
                            'Yes'
                        ],
                    })
                    .then(async (confirmed) => {
                        if(confirmed){
                            const savedUsername = await retrieveJSON("savedUsername")
                            const savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles")
                            const allFilterInfo = await retrieveJSON("allFilterInfo")
                            const savedFilterOptionsJson = await retrieveJSON("savedFilterOptionsJson")
                            const savedData = await retrieveJSON("savedData")
                            const backup = {
                                savedUsername: savedUsername,
                                savedHiddenAnimeTitles: savedHiddenAnimeTitles,
                                allFilterInfo: allFilterInfo,
                                savedFilterOptionsJson: savedFilterOptionsJson,
                                savedData: savedData
                            }
                            downloadObjectAsJson(backup, "Kanshi-Backup")
                            $(".menu-container").fadeOut(250)
                        }
                    })
                } else {
                    console.log("WebtoApp: Choose an Export Path")
                }
            })
            $("#updateIntervalBtn").on("click",async()=>{
                updateIntervalIsActive = await retrieveJSON("updateIntervalIsActive") || false
                if(updateIntervalIsActive){
                    swal({
                        text: `Do you want to Disable Auto Update for your Recommendations List every 4 hours?`,
                        buttons: [
                            'No',
                            'Yes'
                        ],
                    })
                    .then(async (confirmed) => {
                        if(confirmed){
                            $("#updateIntervalBtn").css({background:"black",color:"white"})
                            updateIntervalIsActive = false
                            saveJSON(updateIntervalIsActive,"updateIntervalIsActive")
                        }
                    })
                } else {
                    swal({
                        text: `Do you want to Enable Auto Update for your Recommendations List every 4 hours?`,
                        buttons: [
                            'No',
                            'Yes'
                        ],
                    })
                    .then(async (confirmed) => {
                        if(confirmed){
                            $("#updateIntervalBtn").css({background:"white",color:"black"})
                            updateIntervalIsActive = true
                            saveJSON(updateIntervalIsActive,"updateIntervalIsActive")
                            updateIntervalStartDate = await retrieveJSON("updateIntervalStartDate") || new Date()
                            saveJSON(updateIntervalStartDate,"updateIntervalStartDate")
                            if((new Date).getTime()-(updateIntervalStartDate.getTime())>14400000){// 4hrs
                                Update()
                                updateIntervalStartDate = new Date()
                                saveJSON(updateIntervalStartDate,"updateIntervalStartDate")
                            }
                        }
                    })
                }
            })
            $("#exportIntervalBtn").on("click",async()=>{
                exportPathIsAvailable = await retrieveJSON("exportPathIsAvailable") || false
                exportPathIsAvailable = true
                if(exportPathIsAvailable) {
                    exportIntervalIsActive = await retrieveJSON("exportIntervalIsActive") || false
                    if(exportIntervalIsActive){
                        swal({
                            text: `Do you want to Disable Data Back-Up every 4 hours?`,
                            buttons: [
                                'No',
                                'Yes'
                            ],
                        })
                        .then(async (confirmed) => {
                            if(confirmed){
                                $("#exportIntervalBtn").css({background:"black",color:"white"})
                                exportIntervalIsActive = false
                                saveJSON(exportIntervalIsActive,"exportIntervalIsActive")
                            }
                        })
                    } else {
                        swal({
                            text: `Do you want to Enable Data Back-Up every 4 hours?`,
                            buttons: [
                                'No',
                                'Yes'
                            ],
                        })
                        .then(async (confirmed) => {
                            if(confirmed){
                                $("#exportIntervalBtn").css({background:"white",color:"black"})
                                exportIntervalIsActive = true
                                saveJSON(exportIntervalIsActive,"exportIntervalIsActive")
                                exportIntervalStartDate = await retrieveJSON("exportIntervalStartDate") || new Date()
                                saveJSON(exportIntervalStartDate,"exportIntervalStartDate")
                                if((new Date).getTime()-(exportIntervalStartDate.getTime())>14400000){// 4hrs
                                    const savedUsername = await retrieveJSON("savedUsername")
                                    const savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles")
                                    const allFilterInfo = await retrieveJSON("allFilterInfo")
                                    const savedFilterOptionsJson = await retrieveJSON("savedFilterOptionsJson")
                                    const savedData = await retrieveJSON("savedData")
                                    const backup = {
                                        savedUsername: savedUsername,
                                        savedHiddenAnimeTitles: savedHiddenAnimeTitles,
                                        allFilterInfo: allFilterInfo,
                                        savedFilterOptionsJson: savedFilterOptionsJson,
                                        savedData: savedData
                                    }
                                    downloadObjectAsJson(backup, "Kanshi-Backup")
                                    exportIntervalStartDate = new Date()
                                    saveJSON(exportIntervalStartDate,"exportIntervalStartDate")
                                }
                            }
                        })

                    }
                } else {
                    console.log("WebtoApp: Choose an Export Path")
                }
            })
            $("#chooseExportPathBtn").on("click",()=>{
                console.log("WebtoApp: Choose an Export Path")
            })
            //
            $(".anime-table-headers").on('click', ()=>{
                setTimeout(()=>{
                    let setPageInfo = setInterval(()=>{
                        if(typeof $('#anime-table')[0].config!=="undefined"){
                            clearInterval(setPageInfo)
                            $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                        }
                    },1)
                },0)
            })
            $("body").on('scroll', function () {
                setTimeout(()=>{
                    saveJSON($("body").scrollTop(),"savedYscroll")
                },1)
            })
            // Search Function
            async function Update(){
                updateStartTime = new Date
                var filterInput = $(".filter-container > ul > .flexdatalist-multiple-value > input")
                var username = $("#username").val()
                var filter = filterInput.val()
                // Check Input Validity
                if(username===""||username===null||typeof username==="undefined"){
                    $("#username")[0].setCustomValidity("Anilist Username is Required!")
                    $("#username")[0].reportValidity()
                }else if($(".flexdatalist-multiple").children("li").length<2&&filterInput.val()!=""){
                    filterInput[0].setCustomValidity("Select or Enter a word to Filter!")
                    filterInput[0].reportValidity()
                } else {
                    savedUsername = await retrieveJSON("savedUsername") || ""
                    if(savedUsername.length===0){
                        saveJSON(username,"savedUsername")
                    }
                    requestPause = await retrieveJSON("requestPause") || false
                    savedLastRequestDate = await retrieveJSON("savedLastRequestDate") || new Date(Date.now()-60001)
                    if(!requestPause
                    ||(((new Date().getTime())-savedLastRequestDate.getTime())>60000)){
                        // Search New Data
                        requestPause = true
                        saveJSON(requestPause,"requestPause")
                        analyzeVariables(username)
                    } else {
                        if(!requestIsRunning){
                            for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                            $("#dataStatusSpinner").show(0,()=>{
                                $("#dataStatusContainer").fadeIn(2500).css("display","flex")
                            })
                            requestIntervalSeconds = Math.round(60-(((new Date()).getTime()-savedLastRequestDate.getTime())/1000)) || 60
                            for(let i=requestIntervalSeconds; i>=0; i--){
                                let timeout = setTimeout(()=>{
                                    if(i===0){
                                        requestPause = false
                                        saveJSON(requestPause,"requestPause")
                                        $("#dataStatusSpinner").hide(0,()=>{
                                            $("#dataStatus")
                                                .empty()
                                                .append(`Update is now Available!`)
                                            $("#dataStatusContainer").fadeOut(2500,()=>{
                                                $("#dataStatus").empty()
                                                Update()
                                            })
                                        })
                                    } else {
                                        $("#dataStatus")
                                            .empty()
                                            .append(`Please wait for another Update... Estimated Time: ${msToTime(i*1000)}`)
                                    }
                                },(requestIntervalSeconds-i)*1000)
                                temp.push(timeout)
                            }
                        } else {
                            $(".menu-container").fadeOut(250)
                            swal("List is Already Updating! Please wait a moment...", {
                                icon: "info",
                            })
                        }
                    }
                }
            }

            function analyzeVariables(username) {
                // Check Parameters
                if(username.length>0) {
                    // Initialize Anilist Graphql Data
                    var query = `
                    {
                        MediaListCollection(userName: "${username}", type: ANIME) {
                            lists {
                                status
                                entries {
                                    media {
                                        title {
                                            userPreferred
                                        }
                                        averageScore
                                        format
                                        episodes
                                        genres
                                        tags {
                                            name
                                        }
                                        studios {
                                            nodes {
                                                name
                                            }
                                        }
                                        format
                                        episodes
                                        seasonYear
                                        season
                                        staff {
                                            edges {
                                                node {
                                                    name {
                                                        first
                                                        last
                                                    }
                                                    siteUrl
                                                }
                                            }
                                        }
                                    }
                                    score
                                }
                            }
                        }
                    }
                    `;
                    // Request API
                    $.ajax({
                        type: 'POST',
                        url: 'https://graphql.anilist.co',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        dataType: 'json',
                        data: JSON.stringify({
                            query: query
                        }),
                        beforeSend: async () => {
                            requestIsRunning = true
                            saveJSON(new Date(),"savedLastRequestDate")
                            savedUpdateTime = await retrieveJSON("savedUpdateTime") || 1800
                            $("#dataStatusSpinner").show(0, ()=>{
                                $("#dataStatusContainer").fadeIn(2500).css("display","flex")
                                for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                                for(let i=savedUpdateTime; i>0; i--){
                                    var timeout = setTimeout(()=>{
                                        $("#dataStatus")
                                            .empty()
                                            .append(`Updating Data... Estimated Time: ${msToTime(i*1000)}`)
                                    },(savedUpdateTime-i)*1000)
                                    temp.push(timeout)
                                }
                            })
                        },
                        success: (data)=> {
                            var worker = new Worker("./js-css/worker/analyzeVariable.js")
                            worker.postMessage(data)
                            worker.onmessage = (message) => {
                                const data = message.data
                                const varScheme = data.varScheme
                                const userListInfo = data.userListInfo
                                analyzeAnime(username, varScheme, userListInfo)
                                worker.terminate()
                            }
                        },
                        error: function(xhr) {
                            try {
                                var err = xhr
                                if(isJsonString(xhr.responseText)){
                                    err = JSON.parse(xhr.responseText).errors[0].message
                                    console.error(JSON.parse(xhr.responseText))
                                }
                                $("#dataStatusContainer").fadeOut(2500,()=>{
                                    $("#dataStatusSpinner").show()
                                    $("#dataStatus").empty()
                                })
                                if(err==="User not found"){
                                    $("#username")[0].setCustomValidity("Username is not found!")
                                    $("#username")[0].reportValidity()
                                } else {
                                    swal("Error", {
                                        title: "Oops...Something Went Wrong!",
                                        text: `Error 100: ${typeof err==="string"?err:"Please Try Again..."}`,
                                        icon: "error"
                                    })
                                }
                            } catch(ex) {
                                console.error(ex)
                                $("#dataStatusContainer").fadeOut(2500,()=>{
                                    $("#dataStatusSpinner").show()
                                    $("#dataStatus").empty()
                                })
                                swal("Error", {
                                    title: "Oops...Something Went Wrong!",
                                    text: `Error 101: ${typeof err==="string"?err:"Please Try Again..."}`,
                                    icon: "error"
                                })
                            }
                            console.log("WebtoApp: Update Error")
                            requestIsRunning = false
                        }
                    })
                }
            }

            function analyzeAnime(username, varImportance, userListInfo){
                // Download Recommendation List json
                var maxAnimePerPage = 50
                var maxRequest = 90
                var firstMaxRequest = maxRequest-1 //MaxRequest-RequestsBefore
                var startDate = new Date()
                var recScheme = []
                var sum = 0
                recall(1) // First Page
                function recall(page){
                    $.ajax({
                        type: 'POST',
                        url: 'https://graphql.anilist.co',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        dataType: 'json',
                        data: JSON.stringify({//genre_not_in: ["Hentai"]
                            query: `
                            {
                                Page(page: ${page}, perPage: ${maxAnimePerPage}) {
                                    media(
                                        type: ANIME,
                                        status_in:[FINISHED, RELEASING],
                                        format_in:[TV,TV_SHORT,MOVIE,OVA,ONA,SPECIAL]) {
                                        title {
                                            userPreferred
                                        }
                                        siteUrl
                                        averageScore
                                        format
                                        episodes
                                        genres
                                        tags {
                                            name
                                        }
                                        studios {
                                            nodes {
                                                name
                                            }
                                        }
                                        format
                                        episodes
                                        seasonYear
                                        season
                                        staff {
                                            edges {
                                                node {
                                                    name {
                                                        first
                                                        last
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            `
                        }),
                        beforeSend: ()=> {
                            saveJSON(new Date(),"savedLastRequestDate")
                            startDate = new Date(Date.now + 1000) // Allowance of 1sec
                        },
                        success: (result)=>{
                            var timeInterval = 60000 //Minute in ms
                            var animeEntries = result.data.Page.media
                            if(animeEntries.length>0){
                                var worker = new Worker("./js-css/worker/analyzeAnime.js")
                                worker.postMessage({
                                    animeEntries: animeEntries,
                                    recScheme: recScheme,
                                    userListInfo: userListInfo,
                                    varImportance: varImportance,
                                    allFilterInfo: allFilterInfo
                                })
                                worker.onmessage = (message) => {
                                    const data = message.data
                                    recScheme = data.recScheme
                                    sum = data.sum
                                    allFilterInfo = data.allFilterInfo
                                    saveJSON(allFilterInfo,"allFilterInfo")
                                    worker.terminate()
                                    if((page%(page===1?firstMaxRequest:maxRequest))===0){
                                        setTimeout(()=>{
                                            recall(++page)
                                        },timeInterval-((new Date).getTime()-startDate.getTime()))
                                    } else {
                                        recall(++page)
                                    }
                                }
                            } else {
                                // Clean Analyzed Recommendations
                                for(let i=0;i<recScheme.length;i++){
                                    var anime = recScheme[i]
                                    var weight = (1/sum)*anime.count
                                    recScheme[i].score=anime.score*weight
                                }
                                // Saved New Username
                                saveJSON(username,"savedUsername")
                                // Save new AnimeList json Data
                                saveJSON(recScheme, "savedData")
                                // // Download Recommendation List json
                                // downloadObjectAsJson(recScheme,"NWVI-NWA")
                                var worker = new Worker("./js-css/worker/updateOptions.js")
                                worker.postMessage({
                                    allFilterInfo: allFilterInfo
                                })
                                worker.onmessage = (message) => {
                                    const data = message.data
                                    savedFilterOptionsJson = data.savedFilterOptionsJson
                                    saveJSON(savedFilterOptionsJson,"savedFilterOptionsJson")
                                    $('.flexdatalist').flexdatalist({
                                        data: savedFilterOptionsJson
                                    })
                                    // Reload new Data
                                    LoadData(recScheme, true)
                                    var timeInterval = (new Date).getTime()-updateStartTime.getTime()
                                    saveJSON(Math.floor(timeInterval/1000)+1, "savedUpdateTime")
                                    console.log("WebtoApp: List is Updated")
                                    swal("List has been Updated!", {
                                        icon: "success",
                                    })
                                    requestIsRunning = false
                                    setTimeout(async()=>{
                                        for(let i=0;i<temp.length;i++) clearTimeout(temp[i])
                                        $("#dataStatusSpinner").show(0,()=>{
                                            $("#dataStatusContainer").fadeIn(2500).css("display","flex")
                                        })
                                        savedLastRequestDate = await retrieveJSON("savedLastRequestDate") || new Date(Date.now()-60001)
                                        requestIntervalSeconds = Math.round(60-(((new Date()).getTime()-savedLastRequestDate.getTime())/1000)) || 60
                                        for(let i=requestIntervalSeconds; i>=0; i--){
                                            let timeout = setTimeout(()=>{
                                                if(i===0){
                                                    requestPause = false
                                                    saveJSON(requestPause,"requestPause")
                                                    $("#dataStatusSpinner").hide(0,()=>{
                                                        $("#dataStatus")
                                                            .empty()
                                                            .append(`Update is now Available!`)
                                                        $("#dataStatusContainer").fadeOut(2500,()=>{
                                                            $("#dataStatus").empty()
                                                        })
                                                    })
                                                } else {
                                                    $("#dataStatus")
                                                        .empty()
                                                        .append(`Please wait for another Update... Estimated Time: ${msToTime(i*1000)}`)
                                                }
                                            },(requestIntervalSeconds-i)*1000)
                                            temp.push(timeout)
                                        }
                                    }, 1)
                                }
                            }
                        },
                        error: function(xhr) {
                            try {
                                var timeInterval = 60000 //Minute in ms
                                var err = xhr
                                if(isJsonString(xhr.responseText)){
                                    err = JSON.parse(xhr.responseText).errors[0].message
                                    console.error(JSON.parse(xhr.responseText))
                                }
                                if(err==="Too Many Requests."){
                                    setTimeout(()=>{
                                        recall(page)
                                    },timeInterval)
                                } else {
                                    if(err==="User not found"){
                                        $("#username")[0].setCustomValidity("Username is not found!")
                                        $("#username")[0].reportValidity()
                                    } else {
                                        swal("Error", {
                                            title: "Oops...Something Went Wrong!",
                                            text: `Error 102: ${typeof err==="string"?err:"Please Try Again..."}`,
                                            icon: "error"
                                        })
                                    }
                                    $("#dataStatusContainer").fadeOut(2500,()=>{
                                        $("#dataStatusSpinner").show()
                                        $("#dataStatus").empty()
                                    })
                                    console.log("WebtoApp: Update Error")
                                    requestIsRunning = false
                                }
                            } catch(ex) {
                                console.error(ex)
                                swal("Error", {
                                    title: "Oops...Something Went Wrong!",
                                    text: `Error 103: ${typeof err==="string"?err:"Please Try Again..."}`,
                                    icon: "error"
                                })
                                console.log("WebtoApp: Update Error")
                                requestIsRunning = false
                            }
                        }
                    })
                }
            }
            async function LoadData(recScheme, updateFilters){
                if((recScheme.length>0)) {
                    var filterInputs = $(".flexdatalist-multiple > .value").children(".text")
                    var filters = []
                    var includes = []
                    var excludes = []
                    for(let i=0; i<filterInputs.length; i++){
                        var filterName = filterInputs[i].textContent
                        filters.push(filterName)
                        if(filterName.charAt(0)==="!") excludes.push(filterName.slice(1))
                        else includes.push(filterName)
                    }
                    $("#hiddenUnhiddenBtn").text("Unhidden")
                    for(let i=0; i<includes.length; i++){
                        if(equalsNCS(includes[i],"hidden")){
                            $("#hiddenUnhiddenBtn").text("Hidden")
                            break;
                        }
                    }
                    saveJSON(filters, "savedFilters")
                    savedHiddenAnimeTitles = await retrieveJSON("savedHiddenAnimeTitles") || []
                    var worker = new Worker("./js-css/worker/loadData.js")
                    worker.postMessage({
                        recScheme: recScheme,
                        savedHiddenAnimeTitles: savedHiddenAnimeTitles,
                        includes: includes,
                        excludes: excludes
                    })
                    worker.onmessage = async (message) => {
                        const data = message.data
                        const animeData = data.animeData
                        worker.terminate()
                        $("#animeRecommendationList").empty()
                        $("#animeRecommendationList").append(animeData)
                        await $("#anime-table").trigger("update")
                        await $("#anime-table").trigger("pagerUpdate")
                        savedTablePage = await retrieveJSON("savedTablePage") || [0,0]
                        savedTableStatus = await retrieveJSON("savedTableStatus") || "Unhidden"
                        $("#anime-table").trigger("pageSet",1+(savedTableStatus==="Unhidden"? savedTablePage[0]:savedTablePage[1]))
                        setTimeout(()=>{
                            let setPageInfo = setInterval(()=>{
                                if(typeof $('#anime-table')[0].config!=="undefined"){
                                    clearInterval(setPageInfo)
                                    $("#pageNumberOptions").find("option:selected").text(`${$("#pageNumberOptions").val()} of ${$('#anime-table')[0].config.pager.totalPages}`).prop('selected', true)
                                }
                            },1)
                        },0)
                    }
                } else {
                    Update()
                }
            }
            //////////////////////////////////////////////////////////////////
            // Extra
            function saveJSON(data, name) {
                try {
                    var write = db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").openCursor()
                    write.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            if(cursor.key===name){
                                cursor.update(data)
                            }
                            cursor.continue()
                        } else {
                            db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").add(data, name)
                        }
                    }
                } catch(ex) {
                    try{
                        console.error(ex)
                        db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").add(data, name)
                    } catch(ex2){
                        console.error(ex2)
                        return localStorage.setItem(name, JSON.stringify(data))
                    }
                }
            }
            async function retrieveJSON(name) {
                return new Promise((resolve)=>{
                    try {
                        var read = db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").get(name)
                        read.onsuccess = (event) => {
                            resolve(read.result)
                        }
                        read.onerror = (event) => {
                            if(isJsonString(xhr.responseText)){
                                resolve(JSON.parse(localStorage.getItem(name)))
                            } else resolve()
                        }
                    } catch(ex){
                        console.error(ex)
                        if(isJsonString(xhr.responseText)){
                            resolve(JSON.parse(localStorage.getItem(name)))
                        } else resolve()
                    }
                })
            }
            function equalsNCS(str1, str2) {
                var s1 = str1
                var s2 = str2
                if(typeof s1==="number") s1 = s1.toString()
                if(typeof s2==="number") s2 = s2.toString()
                if(typeof s1==="string") s1 = s1.trim().toLowerCase()
                if(typeof s2==="string") s2 = s2.trim().toLowerCase()
                return s1 === s2
            }
            function arraySum(obj) {
                return obj.reduce((a, b) => a + b, 0)
            }
            function arrayMean(obj) {
                return (arraySum(obj) / obj.length) || 0
            }
            function msToTime(duration) {
                var seconds = Math.floor((duration / 1000) % 60),
                    minutes = Math.floor((duration / (1000*60)) % 60),
                    hours = Math.floor((duration / (1000*60*60)) % 24),
                    days = Math.floor((duration / (1000*60*60*24)) % 7),
                    weeks = Math.floor((duration / (1000*60*60*24*7)) % 4),
                    months = Math.floor((duration / (1000*60*60*24*7*4)) % 12)
                    years = Math.floor((duration / (1000*60*60*24*7*4*12)) % 10)
                    decades = Math.floor((duration / (1000*60*60*24*7*4*12*10)) % 10)
                    century = Math.floor((duration / (1000*60*60*24*7*4*12*10*10)) % 10)
                    millenium = Math.floor((duration / (1000*60*60*24*7*4*12*10*10*10)) % 10)
                var time = []
                if(millenium<=0&&century<=0&&decades<=0&&years<=0&&months<=0&&weeks<=0&&days<=0&&hours<=0&&minutes<=0&&seconds<=0) return "0s"
                if(millenium>0) time.push(millenium===1?`${millenium}mil`:`${millenium}mils`)
                if(decades>0) time.push(decades===1?`${decades}de`:`${decades}des`)
                if(years>0) time.push(`${years}y`)
                if(months>0) time.push(months===1?`${months}mo`:`${months}mos`)
                if(weeks>0) time.push(`${weeks}w`)
                if(days>0) time.push(`${days}d`)
                if(hours>0) time.push(`${hours}h`)
                if(minutes>0) time.push(`${minutes}m`)
                if(seconds>0) time.push(`${seconds}s`)
                return time.join(" ")
            }
            function downloadObjectAsJson(exportObj, exportName){
                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
                var downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href",dataStr);
                downloadAnchorNode.setAttribute("download",exportName + ".json");
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }
            function isJsonString(str) {
                try {JSON.parse(str);}
                catch (e) {return false;}
                return true;
            }
            async function parseJsonFile(file) {
                return new Promise((resolve, reject) => {
                    const fileReader = new FileReader()
                    fileReader.onload = event => resolve(JSON.parse(event.target.result))
                    fileReader.onerror = error => reject(error)
                    fileReader.readAsText(file)
                })
            }
        </script>
</body>
</html>
