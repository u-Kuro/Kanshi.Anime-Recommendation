<body>
    <header>
        <div class="overlay">
            <h1>Kanshi.</h1>
            <h5>Anime - Anilist</h5>
            <h5>Search Filter</h5>
            <h5>Recommendation</h5>
        </div>
    </header>
    <div class="Home container">
        <div class="searchData">
            <div class="userInputContainer">
                <input class="userInput" placeholder="Anilist Username" name="username" id="username" type="text">
            </div>
            <div class="filter-container">
                <input type="text"
                    placeholder="Filter Genre/Tags/Status/etc. (Exclude - add !)"
                    class="flexdatalist"
                    data-data="Options.json"
                    data-search-in="info"
                    multiple="multiple"
                    data-min-length="1"
                    name="filter">
            </div>
            <div class="btn-container">
                <button id="btn" class="btn" type="submit">Search</button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table id="anime-table" class="sortable table table-bordered table-striped">
                <tr>
                    <th>Score</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Genres</th>
                    <th>Tags</th>
                    <th>Season</th>
                    <th>Format</th>
                    <th>Studios</th>
                </tr>
            </table>
        </div>
    </div>
</div>
<div class="loader"></div>
    <script>
        $(window).load(function() {
            setTimeout(()=>{
                $(".loader").fadeOut("slow");
            },2500)
        });
        $(".flexdatalist").flexdatalist({
            minLength: 1,
            searchIn: "info",
            data: "Options.json"
        });
    </script>
    <script>
        var savedData = retrieveJSON("savedJSON")
        var unameInput = $("#username")
        var filterInput = $(".filter-container > ul > .flexdatalist-multiple-value > input")
        var filterOptionsInput = $(".flexdatalist-results")
        var btn = $("#btn")
        unameInput.on('keypress',(e)=>{if(e.which==13){Search()}})
        btn.on('click', ()=>Search())
        //
        function Search(){
            var username = unameInput.val()
            var filter = filterInput.val()
            if(username===""||username===null||typeof username==="undefined"){
                unameInput[0].setCustomValidity("Anilist Username is Required!")
                unameInput[0].reportValidity()
            }if($(".flexdatalist-multiple").children("li").length<2&&filterInput.val()!=""){
                filterInput.val("")
                filterInput[0].setCustomValidity("Select or Enter a word to Filter!")
                filterInput[0].reportValidity()
            } else {
                var filterInputs = $(".flexdatalist-multiple > .value").children(".text")
                var includes = []
                var excludes = []
                for(let i=0; i<filterInputs.length; i++){
                    var data = filterInputs[i].textContent
                    if(data.charAt(0)==="!") excludes.push(data.slice(1))
                    else includes.push(data)
                }
                AnalyzeRefresh(username, includes, excludes, savedData)
            }
        }

        function AnalyzeRefresh(username, includes, excludes, data){
            LoadData(includes, excludes, data)
            retrieveAnalyze(username, includes, excludes)
        }

        function retrieveAnalyze(username, includes, excludes) {
            var query = `
            {
            MediaListCollection(userName: "${username}", type: ANIME) {
                lists {
                status
                entries {
                    media {
                    title {
                        userPreferred
                    }     
                    recommendations {
                        edges {
                        node {
                            mediaRecommendation {
                            title {
                                userPreferred
                            }
                            averageScore 
                            siteUrl
                            genres
                            tags {
                                name
                            }
                            type
                            format
                            seasonYear
                            season
                            studios {
                                nodes {
                                name
                                }
                            }
                            }
                            rating
                        }
                        }
                    }
                    }
                score
                }
                }
            }
            }
            `;

            $.ajax({
                type: 'POST',
                url: 'https://graphql.anilist.co',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                dataType: 'json',
                data: JSON.stringify({
                    query: query
                }),
                success: (data)=> {
                    //Concat Completed, Watching, Drop, etc.
                    var animeList = data.data.MediaListCollection.lists
                    var animeEntries = []
                    for(let i=0; i<animeList.length-1; i++){
                        animeEntries = animeList[i].entries.concat(animeList[++i].entries)
                    }
                    // For Recommendations
                    var recScheme = []
                    var userListInfo = []
                    // Check Watched
                    for(let i=0; i<animeList.length; i++){
                        for(let j=0; j<animeList[i].entries.length; j++){ 
                        userListInfo.push({
                            name: animeList[i].entries[j].media.title.userPreferred,
                            status: animeList[i].status
                        })
                        }
                    }
                    for(let i=0; i<animeEntries.length; i++){
                        if(animeEntries[i].score>1){
                            var meanUserScore = animeEntries[i].score*0.1
                            var recommended = animeEntries[i].media.recommendations.edges
                            for(let j=0; j<recommended.length; j++){
                                if(recommended[j].node.mediaRecommendation!==null){
                                    if(recommended[j].node.mediaRecommendation.title!==null&&recommended[j].node.mediaRecommendation.rating!==null&&recommended[j].node.mediaRecommendation.genres!==null){
                                        var title = recommended[j].node.mediaRecommendation.title.userPreferred
                                        var url = recommended[j].node.mediaRecommendation.siteUrl
                                        var type = recommended[j].node.mediaRecommendation.type
                                        var format = recommended[j].node.mediaRecommendation.format
                                        var year = recommended[j].node.mediaRecommendation.seasonYear
                                        var season = recommended[j].node.mediaRecommendation.season
                                        var studios = recommended[j].node.mediaRecommendation.studios.nodes 
                                        var tags = recommended[j].node.mediaRecommendation.tags
                                        var genres = recommended[j].node.mediaRecommendation.genres
                                        var anilistScore = recommended[j].node.mediaRecommendation.averageScore
                                        var status = ""
                                        for(let k=0; k<userListInfo.length; k++){
                                            if(userListInfo[k].name===title){
                                                status = userListInfo[k].status
                                                break
                                            }
                                            else status = "UNWATCHED"
                                        }
                                        var info = ""
                                        for(let k=0; k<genres.length; k++){
                                            if(k<genres.length-1) info = info+genres[k]+", "
                                            else info = info+genres[k]
                                        }
                                        genres = info
                                        info = ""
                                        for(let k=0; k<tags.length; k++){
                                            if(k<genres.length-1) info = info+tags[k].name+", "
                                            else info = info+tags[k].name
                                        }
                                        tags = info
                                        info = ""
                                        for(let k=0; k<studios.length; k++){
                                            if(k<genres.length-1) info = info+studios[k].name+", "
                                            else info = info+studios[k].name
                                        }
                                        studios = info
                                        info = ""
                                        // Add Recommendation Scheme
                                        if(recScheme.length<1){
                                        recScheme.push({
                                            ["Hide (x)"]: "", title: title, url:url,
                                            score: 0, 
                                            meanUserScoreWeighted: 0, anilistScoreWeighted: 0, userAnilistScore: 0, 
                                            meanUserScore: [meanUserScore],  anilistScore: anilistScore, count: 1,
                                            status: status, genres: genres, tags: tags, year: year, 
                                            season: season, format: format, studios: studios, type: type
                                            })
                                        }
                                        else{
                                            var hasValue = false
                                            for(let k=0; k<recScheme.length; k++){
                                                hasValue = recScheme[k].title==title || hasValue;
                                                if(hasValue){
                                                recScheme[k].count = ++recScheme[k].count
                                                recScheme[k].meanUserScore.push(meanUserScore)
                                                break
                                                }
                                            }
                                            if(!hasValue){
                                                recScheme.push({
                                                title: title, url:url,
                                                score: 0, 
                                                meanUserScoreWeighted: 0, anilistScoreWeighted: 0, userAnilistScore: 0, 
                                                meanUserScore: [meanUserScore],  anilistScore: anilistScore, count: 1,
                                                status: status, genres: genres, tags: tags, year: year, 
                                                season: season, format: format, studios: studios, type: type
                                                })
                                            }
                                        }
                                    } else continue
                                } else continue
                            }
                        }
                    }
                        var sum = 0 
                        for(let i=0; i<recScheme.length; i++){
                            sum = sum + recScheme[i].count
                        }
                        for(let i=0; i<recScheme.length; i++){
                            // UserScore: 1, AnilistScore: 100, countWeight: 1
                            var meanUserScore = arrayMean(recScheme[i].meanUserScore)*100
                            var anilistScore = recScheme[i].anilistScore*.01
                            var countWeight = (1/sum)*recScheme[i].count
                            recScheme[i].score = meanUserScore*anilistScore*countWeight
                            recScheme[i].userAnilistScore = meanUserScore*anilistScore
                            recScheme[i].meanUserScoreWeighted = meanUserScore*countWeight 
                            recScheme[i].anilistScoreWeighted = anilistScore*100*countWeight
                            recScheme[i].meanUserScore = meanUserScore 
                            recScheme[i].anilistScore = anilistScore*100
                            delete recScheme[i].userScore
                            delete recScheme[i].weight
                        }
                    saveJSON(recScheme, "savedJSON")
                    savedData = recScheme
                    LoadData(includes, excludes, recScheme)
                }, error: (error) => {
                    console.log(error)
                }
            })
        }

        function LoadData(includes, excludes, data){
            if(data!==null&&typeof data!=="undefined"&&typeof data==="object") {                
                // FilterOut User Includes and Excludes
                    // Include
                    var tempRecScheme = []
                    for(let i=0; i<includes.length; i++){
                        for(let j=0; j<data.length; j++){
                            var hasValue = false
                            if(equalsNCS(includes[i],data[j].type)
                            ||equalsNCS(includes[i],data[j].format)
                            ||equalsNCS(includes[i],data[j].year)
                            ||equalsNCS(includes[i],data[j].season)
                            ||equalsNCS(includes[i],data[j].status))
                            {
                                tempRecScheme.push(data[j])
                                continue
                            }
                            var temp = data[j].studios.split(", ")
                            for(let k=0; k<temp.length; k++){
                                if(equalsNCS(includes[i],temp[k])){
                                    tempRecScheme.push(data[j])
                                    hasValue = true
                                    break
                                }
                            }
                            if(hasValue) continue
                            temp = data[j].genres.split(", ")
                            for(let k=0; k<temp.length; k++){
                                if(equalsNCS(includes[i],temp[k])){
                                    tempRecScheme.push(data[j])
                                    hasValue = true
                                    break
                                }
                            }
                            if(hasValue) continue
                            temp = data[j].tags.split(", ")
                            for(let k=0; k<temp.length; k++){
                                if(equalsNCS(includes[i],temp[k])){
                                    tempRecScheme.push(data[j])
                                    hasValue = true
                                    break
                                }
                            }
                        }
                        data = tempRecScheme
                        tempRecScheme = []
                    }
                // Exclude
                for(let i=0; i<excludes.length; i++){
                    for(let j=0; j<data.length; j++){
                        var hasValue = false
                        if(equalsNCS(excludes[i],data[j].type)
                        ||equalsNCS(excludes[i],data[j].format)
                        ||equalsNCS(excludes[i],data[j].year)
                        ||equalsNCS(excludes[i],data[j].season)
                        ||equalsNCS(excludes[i],data[j].status))
                        {
                            continue
                        }
                        temp = data[j].studios.split(", ")
                        for(let k=0; k<temp.length; k++){
                            if(equalsNCS(excludes[i],temp[k])){
                                hasValue = true
                                break
                            }
                        }
                        if(hasValue) continue
                        temp = data[j].genres.split(", ")
                        for(let k=0; k<temp.length; k++){
                            if(equalsNCS(excludes[i],temp[k])){
                                hasValue = true
                                break
                            }
                        }
                        if(hasValue) continue
                        temp = data[j].tags.split(", ")
                        for(let k=0; k<temp.length; k++){
                            if(equalsNCS(excludes[i],temp[k])){
                                hasValue = true
                                break
                            }
                        }
                        if(hasValue==false)
                            tempRecScheme.push(data[j])
                    }
                    data = tempRecScheme
                    tempRecScheme = []
                }
                // Show Table
                var animeData = ""
                
                $.each(data, (key, value) => {
                    animeData += `<tr class="item">`
                    animeData += `<td>${value.score.toFixed(4)}</td>`
                    animeData += `<td><a href="${value.url}">${value.title}</a></td>`
                    animeData += `<td>${value.status}</td>`
                    animeData += `<td>${value.genres}</td>`
                    animeData += `<td>${value.tags}</td>`
                    animeData += `<td>${value.season}</td>`
                    animeData += `<td>${value.format}</td>`
                    animeData += `<td>${value.studios}</td>`
                    animeData += `</tr>`
                })
                $("#anime-table > tbody").empty()
                $("#anime-table").append(animeData)
            }
        }


    //////////////////////////////////////////////////////////////////
    // Extra
    function saveJSON(data, name) {
        localStorage.setItem(name, JSON.stringify(data));       
    }
    function retrieveJSON(name) {
        var retrievedObject = localStorage.getItem(name);
        return JSON.parse(retrievedObject)
    }
    function equalsNCS(str1, str2) {
        var s1 = str1
        var s2 = str2
        if(typeof str1=="number") s1 = str1.toString()
        if(typeof str2=="number") s2 = str2.toString()
        if(typeof str1=="string"&&typeof str2=="string")
            return str1.toLowerCase() == str2.toLowerCase()
        else return s1==s2
        
    }
    function arraySum(obj) {
        return obj.reduce((a, b) => a + b, 0)
    }
    function arrayMean(obj) {
        return (arraySum(obj) / obj.length) || 0
    }
        
    </script>
